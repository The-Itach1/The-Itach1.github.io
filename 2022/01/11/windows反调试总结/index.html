<!DOCTYPE html><html lang="zh-CH" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Windows反调试总结 | The_Itach1</title><meta name="author" content="The_Itach1"><meta name="copyright" content="The_Itach1"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><meta name="description" content="Windows反调试总结本文总结下windows下常见的反调试技术，尽量完全，如果不适用win10的就不总结了，也是对《逆向工程核心原理相关部分的一个总结》，目前更新状态，静态反调试快弄完了，动态的尽快吧，hook api应该也是最近更。 期末也是过去了，表面上复习，实际上是休息了一个月左右，嘿嘿，现在也是寒假了，也是准备提升下自己的编程能力，学习下常见病毒编程技术，网络编程，和python进阶。">
<meta property="og:type" content="article">
<meta property="og:title" content="Windows反调试总结">
<meta property="og:url" content="http://example.com/2022/01/11/windows%E5%8F%8D%E8%B0%83%E8%AF%95%E6%80%BB%E7%BB%93/index.html">
<meta property="og:site_name" content="The_Itach1">
<meta property="og:description" content="Windows反调试总结本文总结下windows下常见的反调试技术，尽量完全，如果不适用win10的就不总结了，也是对《逆向工程核心原理相关部分的一个总结》，目前更新状态，静态反调试快弄完了，动态的尽快吧，hook api应该也是最近更。 期末也是过去了，表面上复习，实际上是休息了一个月左右，嘿嘿，现在也是寒假了，也是准备提升下自己的编程能力，学习下常见病毒编程技术，网络编程，和python进阶。">
<meta property="og:locale" content="zh_CH">
<meta property="og:image" content="https://s2.loli.net/2022/01/11/RcyES7Ve6Fmk9Dw.jpg">
<meta property="article:published_time" content="2022-01-11T10:38:45.000Z">
<meta property="article:modified_time" content="2022-01-11T13:54:07.057Z">
<meta property="article:author" content="The_Itach1">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://s2.loli.net/2022/01/11/RcyES7Ve6Fmk9Dw.jpg"><link rel="shortcut icon" href="/img/2.png"><link rel="canonical" href="http://example.com/2022/01/11/windows%E5%8F%8D%E8%B0%83%E8%AF%95%E6%80%BB%E7%BB%93/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: 'Just',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  ClickShowText: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  justifiedGallery: {
    js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
    css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
};

var saveToLocal = {
  set: function setWithExpiry(key, value, ttl) {
    const now = new Date()
    const expiryDay = ttl * 86400000
    const item = {
      value: value,
      expiry: now.getTime() + expiryDay,
    }
    localStorage.setItem(key, JSON.stringify(item))
  },

  get: function getWithExpiry(key) {
    const itemStr = localStorage.getItem(key)

    if (!itemStr) {
      return undefined
    }
    const item = JSON.parse(itemStr)
    const now = new Date()

    if (now.getTime() > item.expiry) {
      localStorage.removeItem(key)
      return undefined
    }
    return item.value
  }
}</script><script id="config_change">var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2022-01-11 21:54:07'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(function () {  window.activateDarkMode = function () {
    document.documentElement.setAttribute('data-theme', 'dark')
    if (document.querySelector('meta[name="theme-color"]') !== null) {
      document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
    }
  }
  window.activateLightMode = function () {
    document.documentElement.setAttribute('data-theme', 'light')
   if (document.querySelector('meta[name="theme-color"]') !== null) {
      document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
    }
  }
  const autoChangeMode = 'false'
  const t = saveToLocal.get('theme')
  if (autoChangeMode === '1') {
    const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
    const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
    const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
    const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified
    if (t === undefined) {
      if (isLightMode) activateLightMode()
      else if (isDarkMode) activateDarkMode()
      else if (isNotSpecified || hasNoSupport) {
        const now = new Date()
        const hour = now.getHours()
        const isNight = hour <= 6 || hour >= 18
        isNight ? activateDarkMode() : activateLightMode()
      }
      window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
        if (saveToLocal.get('theme') === undefined) {
          e.matches ? activateDarkMode() : activateLightMode()
        }
      })
    } else if (t === 'light') activateLightMode()
    else activateDarkMode()
  } else if (autoChangeMode === '2') {
    const now = new Date()
    const hour = now.getHours()
    const isNight = hour <= 6 || hour >= 18
    if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
    else if (t === 'light') activateLightMode()
    else activateDarkMode()
  } else {
    if (t === 'dark') activateDarkMode()
    else if (t === 'light') activateLightMode()
  }const asideStatus = saveToLocal.get('aside-status')
if (asideStatus !== undefined) {
   if (asideStatus === 'hide') {
     document.documentElement.classList.add('hide-aside')
   } else {
     document.documentElement.classList.remove('hide-aside')
   }
}})()</script><meta name="generator" content="Hexo 5.2.0"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="author-avatar"><img class="avatar-img" src="/img/5.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">52</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fa fa-heartbeat"></i><span> List</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fas fa-music"></i><span> music</span></a></li><li><a class="site-page" href="/Gallery/"><i class="fa-fw fas fa-images"></i><span> Gallery</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fas fa-video"></i><span> movies</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(https://s2.loli.net/2022/01/11/RcyES7Ve6Fmk9Dw.jpg)"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">The_Itach1</a></span><span id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fa fa-heartbeat"></i><span> List</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fas fa-music"></i><span> music</span></a></li><li><a class="site-page" href="/Gallery/"><i class="fa-fw fas fa-images"></i><span> Gallery</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fas fa-video"></i><span> movies</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><span class="close" id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></span></span></nav><div id="post-info"><h1 class="post-title">Windows反调试总结</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2022-01-11T10:38:45.000Z" title="Created 2022-01-11 18:38:45">2022-01-11</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2022-01-11T13:54:07.057Z" title="Updated 2022-01-11 21:54:07">2022-01-11</time></span></div><div class="meta-secondline"> <span class="post-meta-separator">|</span><span class="post-meta-pv-cv"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post View:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="Windows反调试总结"><a href="#Windows反调试总结" class="headerlink" title="Windows反调试总结"></a>Windows反调试总结</h1><p>本文总结下windows下常见的反调试技术，尽量完全，如果不适用win10的就不总结了，也是对《逆向工程核心原理相关部分的一个总结》，目前更新状态，静态反调试快弄完了，动态的尽快吧，hook api应该也是最近更。</p>
<p>期末也是过去了，表面上复习，实际上是休息了一个月左右，嘿嘿，现在也是寒假了，也是准备提升下自己的编程能力，学习下常见病毒编程技术，网络编程，和python进阶。</p>
<h2 id="静态反调试"><a href="#静态反调试" class="headerlink" title="静态反调试"></a>静态反调试</h2><p>PEB结构体。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">PEB</span> &#123;</span></span><br><span class="line">  BYTE                          Reserved1[<span class="number">2</span>];</span><br><span class="line">  BYTE                          BeingDebugged;</span><br><span class="line">  BYTE                          Reserved2[<span class="number">1</span>];</span><br><span class="line">  PVOID                         Reserved3[<span class="number">2</span>];</span><br><span class="line">  PPEB_LDR_DATA                 Ldr;</span><br><span class="line">  PRTL_USER_PROCESS_PARAMETERS  ProcessParameters;</span><br><span class="line">  PVOID                         Reserved4[<span class="number">3</span>];</span><br><span class="line">  PVOID                         AtlThunkSListPtr;</span><br><span class="line">  PVOID                         Reserved5;</span><br><span class="line">  ULONG                         Reserved6;</span><br><span class="line">  PVOID                         Reserved7;</span><br><span class="line">  ULONG                         Reserved8;</span><br><span class="line">  ULONG                         AtlThunkSListPtr32;</span><br><span class="line">  PVOID                         Reserved9[<span class="number">45</span>];</span><br><span class="line">  BYTE                          Reserved10[<span class="number">96</span>];</span><br><span class="line">  PPS_POST_PROCESS_INIT_ROUTINE PostProcessInitRoutine;</span><br><span class="line">  BYTE                          Reserved11[<span class="number">128</span>];</span><br><span class="line">  PVOID                         Reserved12[<span class="number">1</span>];</span><br><span class="line">  ULONG                         SessionId;</span><br><span class="line">&#125; PEB, *PPEB;</span><br></pre></td></tr></table></figure>

<p>如何获取PEB结构体的地址</p>
<ul>
<li>方法一</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mov eax，DWORD PTR FS:[0x30]；address of PEB</span><br></pre></td></tr></table></figure>

<ul>
<li>方法二</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mov eax，DWORD PTR FS:[0x18]；address of TEB</span><br><span class="line">mov eax，DWORD PTR DS:[eax+0x30]</span><br></pre></td></tr></table></figure>

<ul>
<li>方法三</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">FARPROC pProc &#x3D; NULL;</span><br><span class="line">LPBYTE pTEB &#x3D; NULL;</span><br><span class="line">LPBYTE pPEB &#x3D; NULL;</span><br><span class="line"></span><br><span class="line">pProc &#x3D; GetProcAddress(GetModuleHandle(L&quot;ntdll.dll&quot;), &quot;NtCurrentTeb&quot;);</span><br><span class="line">pTEB &#x3D; (LPBYTE)(*pProc)();               &#x2F;&#x2F; address of TEB</span><br><span class="line">pPEB &#x3D; (LPBYTE) * (LPDWORD)(pTEB + 0x30);     &#x2F;&#x2F; address of PEB</span><br></pre></td></tr></table></figure>
<h3 id="BeingDebugged"><a href="#BeingDebugged" class="headerlink" title="BeingDebugged"></a>BeingDebugged</h3><p>进程处于调试状态，PEB.BeingDebugged(偏移+2)的值就会变为1，未调试状态为0。</p>
<p>isDebuggerPresent函数就是通过修改这个PEB.BeingDebugged来达到检测进程是否处于调试的目的。</p>
<p>下面是自己写的一个例子，我们然后自己来调试看看isDebuggerPresent内部是什么样子。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;windows.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">test1</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	BOOL check;</span><br><span class="line"></span><br><span class="line">	check = IsDebuggerPresent();</span><br><span class="line">	<span class="keyword">if</span> (check == TRUE)</span><br><span class="line">	&#123;</span><br><span class="line">		MessageBoxA(<span class="literal">NULL</span>, <span class="string">&quot;Being Debugger&quot;</span>,<span class="string">&quot;The_Itach1&quot;</span>, MB_OK);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		MessageBoxA(<span class="literal">NULL</span>, <span class="string">&quot;No Debugger&quot;</span>, <span class="string">&quot;The_Itach1&quot;</span>, MB_OK);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	test1();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ida中调试isDebuggerPresent函数。<br><img src="https://s2.loli.net/2022/01/09/IZXNRymveqPchTY.png"><br>可以看到就是先获取了PEB结构体的地址，然后找到偏移为2的PEB.BeingDebugged的值，然后返回。</p>
<p>破解的话就直接，修改返回值，或者改跳转之类，或者直接修改PEB.BeingDebugged的值。</p>
<h3 id="NtGlobalFlag"><a href="#NtGlobalFlag" class="headerlink" title="NtGlobalFlag"></a>NtGlobalFlag</h3><p>进程处于调试状态，PEB.NtGlobalFlag(+68)的值会变为0x70，所以该特点也可以作为反调试的一个标志。</p>
<p>代码如下，vs直接运行不报被调试，ida调试会报。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;windows.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">test2</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	FARPROC pProc = <span class="literal">NULL</span>;</span><br><span class="line">	LPBYTE pTEB = <span class="literal">NULL</span>;</span><br><span class="line">	LPBYTE pPEB = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">	pProc = GetProcAddress(GetModuleHandle(<span class="string">L&quot;ntdll.dll&quot;</span>), <span class="string">&quot;NtCurrentTeb&quot;</span>);</span><br><span class="line">	pTEB = (LPBYTE)(*pProc)();               <span class="comment">// address of TEB</span></span><br><span class="line">	pPEB = (LPBYTE) * (LPDWORD)(pTEB + <span class="number">0x30</span>);     <span class="comment">// address of PEB</span></span><br><span class="line"></span><br><span class="line">	DWORD dwNtGlobalFlag = *(LPDWORD)(pPEB + <span class="number">0x68</span>);</span><br><span class="line">	<span class="keyword">if</span> (dwNtGlobalFlag == <span class="number">0x70</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		MessageBoxA(<span class="literal">NULL</span>, <span class="string">&quot;Being Debugger&quot;</span>, <span class="string">&quot;The_Itach1&quot;</span>, MB_OK);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		MessageBoxA(<span class="literal">NULL</span>, <span class="string">&quot;No Debugger&quot;</span>, <span class="string">&quot;The_Itach1&quot;</span>, MB_OK);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	test2();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>破解方法和上面差不多。</p>
<h3 id="NtQueryInformationProcess"><a href="#NtQueryInformationProcess" class="headerlink" title="NtQueryInformationProcess"></a>NtQueryInformationProcess</h3><p>用这个函数可以用来获取各种与进程调试的信息。官方文档<a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows/win32/api/winternl/nf-winternl-ntqueryinformationprocess">https://docs.microsoft.com/en-us/windows/win32/api/winternl/nf-winternl-ntqueryinformationprocess</a></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function">__kernel_entry NTSTATUS <span class="title">NtQueryInformationProcess</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  [in]            HANDLE           ProcessHandle,</span></span></span><br><span class="line"><span class="function"><span class="params">  [in]            PROCESSINFOCLASS ProcessInformationClass,</span></span></span><br><span class="line"><span class="function"><span class="params">  [out]           PVOID            ProcessInformation,</span></span></span><br><span class="line"><span class="function"><span class="params">  [in]            ULONG            ProcessInformationLength,</span></span></span><br><span class="line"><span class="function"><span class="params">  [out, optional] PULONG           ReturnLength</span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br></pre></td></tr></table></figure>

<p>ProcessInformationClass，实际上官方文档根本不全。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">enum</span> _<span class="title">PROCESS_INFORMATION_CLASS</span> &#123;</span></span><br><span class="line">  ProcessMemoryPriority,</span><br><span class="line">  ProcessMemoryExhaustionInfo,</span><br><span class="line">  ProcessAppMemoryInfo,</span><br><span class="line">  ProcessInPrivateInfo,</span><br><span class="line">  ProcessPowerThrottling,</span><br><span class="line">  ProcessReservedValue1,</span><br><span class="line">  ProcessTelemetryCoverageInfo,</span><br><span class="line">  ProcessProtectionLevelInfo,</span><br><span class="line">  ProcessLeapSecondInfo,</span><br><span class="line">  ProcessMachineTypeInfo,</span><br><span class="line">  ProcessInformationClassMax</span><br><span class="line">&#125; PROCESS_INFORMATION_CLASS;</span><br></pre></td></tr></table></figure>
<p>主要看二三参数</p>
<p>ProcessInformationClass代表要检索的进程信息的类型，实际上就是调用相关的函数来获取信息，我们主要关注和调试相关的，也就是ProcessDebugPort(0x7)，ProcessDebugObjectHandle(0x1e)，ProcessDebugFlags(0x1f)。</p>
<p>ProcessInformation，相关函数的返回信息到这个参数。</p>
<p>下面以一个例子来说说这三种。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;windows.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">enum</span> _<span class="title">PROCESSINFOCLASS</span> &#123;</span></span><br><span class="line">	ProcessBasicInformation = <span class="number">0</span>,</span><br><span class="line">	ProcessQuotaLimits,</span><br><span class="line">	ProcessIoCounters,</span><br><span class="line">	ProcessVmCounters,</span><br><span class="line">	ProcessTimes,</span><br><span class="line">	ProcessBasePriority,</span><br><span class="line">	ProcessRaisePriority,</span><br><span class="line">	ProcessDebugPort = <span class="number">7</span>,</span><br><span class="line">	ProcessExceptionPort,</span><br><span class="line">	ProcessAccessToken,</span><br><span class="line">	ProcessLdtInformation,</span><br><span class="line">	ProcessLdtSize,</span><br><span class="line">	ProcessDefaultHardErrorMode,</span><br><span class="line">	ProcessIoPortHandlers,</span><br><span class="line">	ProcessPooledUsageAndLimits,</span><br><span class="line">	ProcessWorkingSetWatch,</span><br><span class="line">	ProcessUserModeIOPL,</span><br><span class="line">	ProcessEnableAlignmentFaultFixup,</span><br><span class="line">	ProcessPriorityClass,</span><br><span class="line">	ProcessWx86Information,</span><br><span class="line">	ProcessHandleCount,</span><br><span class="line">	ProcessAffinityMask,</span><br><span class="line">	ProcessPriorityBoost,</span><br><span class="line">	MaxProcessInfoClass,</span><br><span class="line">	ProcessWow64Information = <span class="number">26</span>,</span><br><span class="line">	ProcessImageFileName = <span class="number">27</span>,</span><br><span class="line">	ProcessDebugObjectHandle = <span class="number">30</span>,</span><br><span class="line">	ProcessDebugFlags = <span class="number">31</span>,</span><br><span class="line">	SystemKernelDebuggerInformation = <span class="number">35</span></span><br><span class="line">&#125;PROCESSINFOCLASS;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">test3</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">typedef</span> <span class="title">NTSTATUS</span><span class="params">(WINAPI* NTQUERYINFORMATIONPROCESS)</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">		HANDLE ProcessHandle,</span></span></span><br><span class="line"><span class="function"><span class="params">		PROCESSINFOCLASS ProcessInformationClass,</span></span></span><br><span class="line"><span class="function"><span class="params">		PVOID ProcessInformation,</span></span></span><br><span class="line"><span class="function"><span class="params">		ULONG ProcessInformationLength,</span></span></span><br><span class="line"><span class="function"><span class="params">		PULONG ReturnLength</span></span></span><br><span class="line"><span class="function"><span class="params">		)</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	HANDLE pProcessHandle;</span><br><span class="line">	DWORD  dwDebugPort;</span><br><span class="line">	HANDLE hDebugObject = <span class="literal">NULL</span>;</span><br><span class="line">	BOOL bDebugFlag;</span><br><span class="line">	NTQUERYINFORMATIONPROCESS myNtQueryInformationProcess;</span><br><span class="line"></span><br><span class="line">	myNtQueryInformationProcess = (NTQUERYINFORMATIONPROCESS)GetProcAddress(GetModuleHandle(<span class="string">L&quot;ntdll.dll&quot;</span>), <span class="string">&quot;NtQueryInformationProcess&quot;</span>);</span><br><span class="line"></span><br><span class="line">	pProcessHandle = GetCurrentProcess();</span><br><span class="line">	myNtQueryInformationProcess(pProcessHandle, ProcessDebugPort, &amp;dwDebugPort, <span class="keyword">sizeof</span>(dwDebugPort),<span class="literal">NULL</span>);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;ProcessDebugPort：%x\n&quot;</span>, dwDebugPort);</span><br><span class="line"></span><br><span class="line">	myNtQueryInformationProcess(pProcessHandle, ProcessDebugObjectHandle, &amp;hDebugObject, <span class="keyword">sizeof</span>(hDebugObject), <span class="literal">NULL</span>);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;ProcessDebugObjectHandle：%x\n&quot;</span>, hDebugObject);</span><br><span class="line"></span><br><span class="line">	myNtQueryInformationProcess(pProcessHandle, ProcessDebugFlags, &amp;bDebugFlag, <span class="keyword">sizeof</span>(bDebugFlag), <span class="literal">NULL</span>);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;ProcessDebugFlags：%x\n&quot;</span>, bDebugFlag);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">//test1();</span></span><br><span class="line">	<span class="comment">//test2();</span></span><br><span class="line">	test3();</span><br><span class="line">	system(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面的代码是自己定义了一个函数指针，来调用NtQueryInformationProcess函数，并且枚举了更多的PROCESSINFOCLASS数据，需要注意enum类型重定义的问题，这是官方文档中没有的，应该是作者通过自己分析NtQueryInformationProcess内部得到的。</p>
<p>上面的3种在非调试情况返回的值分别如下</p>
<pre><code>ProcessDebugPort：0
ProcessDebugObjectHandle：0
ProcessDebugFlags：1</code></pre>
<p>而在调试时却是这种</p>
<pre><code>ProcessDebugPort：ffffffff
ProcessDebugObjectHandle：100 ；代表调试对象的句柄值
ProcessDebugFlags：0</code></pre>
<p>官方文档实际上写的信息很少，如果想要深入了解如何返回的值，可以看看<a target="_blank" rel="noopener" href="https://www.52pojie.cn/thread-1409104-1-1.html">https://www.52pojie.cn/thread-1409104-1-1.html</a>这篇文章，但是我一直没找到如何看这个函数内部的方法，可能和内核调试有关吧。</p>
<p>破解方法，修改每次的返回值就行，如果出现次数太多，或者每时每刻都在调用反调试函数，就需要用打补丁的方式hook这个api，使其每次都返回正确的值，具体思路就是在进入函数前先jmp到我们的补丁代码处，然后调用真正的NtQueryInformationProcess函数，根据栈上ProcessInformationClass[esp+c]值的不同，从而再来修改栈上ProcessInformation(esp+10)的对应值。</p>
<h3 id="NtQuerySystemInformation"><a href="#NtQuerySystemInformation" class="headerlink" title="NtQuerySystemInformation"></a>NtQuerySystemInformation</h3><p>用来检测自己的OS(操作系统)是否处于调试模式。</p>
<p>windows10启动调试模式和win7差不多，命令如下，需要重启电脑</p>
<pre><code>C:\WINDOWS\system32&gt; bcdedit /debug on ;打开
C:\WINDOWS\system32&gt; bcdedit /debug off ;关闭</code></pre>
<p>而这个函数就可以用来判断我们的OS是否是处于调试模式。</p>
<p>NtQuerySystemInformation的基本信息，<a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows/win32/api/winternl/nf-winternl-ntquerysysteminformation">https://docs.microsoft.com/en-us/windows/win32/api/winternl/nf-winternl-ntquerysysteminformation</a>，官方文档还是给的不全。</p>
<pre><code>__kernel_entry NTSTATUS NtQuerySystemInformation(
  [in]            SYSTEM_INFORMATION_CLASS SystemInformationClass,
  [in, out]       PVOID                    SystemInformation,
  [in]            ULONG                    SystemInformationLength,
  [out, optional] PULONG                   ReturnLength
);</code></pre>
<p>主要参数一二，SystemInformationClass这个参数传入SystemKernelDebuggerInformation=0x23时，能通过其返回到第二个参数的结构体的信息来判断OS是否处于调试模式，<a target="_blank" rel="noopener" href="https://www.geoffchappell.com/studies/windows/km/ntoskrnl/api/ex/sysinfo/kernel_debugger.htm#:~:text=The%20SYSTEM_KERNEL_DEBUGGER_INFORMATION%20structure%20is%20what%20a%20successful%20call,buffer%20when%20given%20the%20information%20class%20SystemKernelDebuggerInformation%20%280x23%29.">https://www.geoffchappell.com/studies/windows/km/ntoskrnl/api/ex/sysinfo/kernel_debugger.htm#:~:text=The%20SYSTEM_KERNEL_DEBUGGER_INFORMATION%20structure%20is%20what%20a%20successful%20call,buffer%20when%20given%20the%20information%20class%20SystemKernelDebuggerInformation%20%280x23%29.</a>这个网站里面有SYSTEM_KERNEL_DEBUGGER_INFORMATION的一些信息。</p>
<p>测试代码如下。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;windows.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">test4</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">typedef</span> <span class="title">NTSTATUS</span><span class="params">(WINAPI* NTQUERYSYSTEMINFORMATION)</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">		ULONG SystemInformationClass,</span></span></span><br><span class="line"><span class="function"><span class="params">		PVOID SystemInformation,</span></span></span><br><span class="line"><span class="function"><span class="params">		ULONG SystemInformationLength,</span></span></span><br><span class="line"><span class="function"><span class="params">		PULONG ReturnLength</span></span></span><br><span class="line"><span class="function"><span class="params">		)</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//这个结构体官方文档并没给，但能在其他地方找到这个结构体的基本信息。</span></span><br><span class="line">	<span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">SYSTEM_KERNEL_DEBUGGER_INFORMATION</span></span></span><br><span class="line"><span class="class">	&#123;</span></span><br><span class="line">		BOOLEAN DebuggerEnabled;</span><br><span class="line">		BOOLEAN DebuggerNotPresent;</span><br><span class="line">	&#125; SYSTEM_KERNEL_DEBUGGER_INFORMATION, * PSYSTEM_KERNEL_DEBUGGER_INFORMATION;</span><br><span class="line"></span><br><span class="line">	NTQUERYSYSTEMINFORMATION myNtQuerySystemInformation;</span><br><span class="line">	ULONG ulReturnedLength = <span class="number">0</span>;</span><br><span class="line">	SYSTEM_KERNEL_DEBUGGER_INFORMATION SystemInformation = &#123;<span class="number">0</span>,&#125;;</span><br><span class="line"></span><br><span class="line">	myNtQuerySystemInformation = (NTQUERYSYSTEMINFORMATION)GetProcAddress(GetModuleHandle(<span class="string">L&quot;ntdll.dll&quot;</span>), <span class="string">&quot;NtQuerySystemInformation&quot;</span>);</span><br><span class="line">	myNtQuerySystemInformation(SystemKernelDebuggerInformation, &amp;SystemInformation, <span class="keyword">sizeof</span>(SystemInformation), &amp;ulReturnedLength);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;SystemKernelDebuggerInformation%d %d\n&quot;</span>, SystemInformation.DebuggerEnabled, SystemInformation.DebuggerNotPresent);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (SystemInformation.DebuggerEnabled)</span><br><span class="line">	&#123;</span><br><span class="line">		MessageBoxA(<span class="literal">NULL</span>, <span class="string">&quot;Being Debugger&quot;</span>, <span class="string">&quot;The_Itach1&quot;</span>, MB_OK);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		MessageBoxA(<span class="literal">NULL</span>, <span class="string">&quot;No Debugger&quot;</span>, <span class="string">&quot;The_Itach1&quot;</span>, MB_OK);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">//test1();</span></span><br><span class="line">	<span class="comment">//test2();</span></span><br><span class="line">	<span class="comment">//test3();</span></span><br><span class="line">	test4();</span><br><span class="line"></span><br><span class="line">	system(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当处于调试时，结构体的两个变量都是1，非调试时，结构体第一个变量为0，第二个变量为1。</p>
<p>破解方法，C:\WINDOWS\system32&gt; bcdedit /debug off ;关闭</p>
<h3 id="NtQueryObject"><a href="#NtQueryObject" class="headerlink" title="NtQueryObject"></a>NtQueryObject</h3><p>原理就是调试器调试进程时，会产生一个调试对象的内核对象，所以我们只需要检查这个内核对象是否存在即可。</p>
<p>代码太多了。。。焯</p>
<h3 id="ZwSetInformationThread"><a href="#ZwSetInformationThread" class="headerlink" title="ZwSetInformationThread"></a>ZwSetInformationThread</h3><p>该函数是用来设置线程信息的，也是一种反调试的手段，可以将被调试程序强制退出调试状态，对于ZwSetInformationThread这个函数，先看看结构。</p>
<pre><code>NTSYSAPI NTSTATUS ZwSetInformationThread(
  [in] HANDLE          ThreadHandle,
  [in] THREADINFOCLASS ThreadInformationClass,
  [in] PVOID           ThreadInformation,
  [in] ULONG           ThreadInformationLength
);</code></pre>
<p>第一个参数是线程的句柄，第二个参数表示一个在THREADINFOCLASS枚举（见ntddk.h中）的系统定义的值，如下，官方文档又没给。</p>
<pre><code>typedef enum _THREAD_INFORMATION_CLASS &#123;
        ThreadBasicInformation,
        ThreadTimes,
        ThreadPriority,
        ThreadBasePriority,
        ThreadAffinityMask,
        ThreadImpersonationToken,
        ThreadDescriptorTableEntry,
        ThreadEnableAlignmentFaultFixup,
        ThreadEventPair,
        ThreadQuerySetWin32StartAddress,
        ThreadZeroTlsCell,
        ThreadPerformanceCount,
        ThreadAmILastThread,
        ThreadIdealProcessor,
        ThreadPriorityBoost,
        ThreadSetTlsArrayAddress,
        ThreadIsIoPending,
        ThreadHideFromDebugger           // 17 (0x11)
    &#125; THREAD_INFORMATION_CLASS, *PTHREAD_INFORMATION_CLASS;</code></pre>
<p>当设置为ThreadHideFromDebugger，然后调用该函数，如果处于非调试状态，什么事没有，如果处于调试状态，调试器和该进程都停止。</p>
<p>下面还是举个例子。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;windows.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">test5</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">typedef</span> <span class="class"><span class="keyword">enum</span> _<span class="title">THREAD_INFORMATION_CLASS</span> &#123;</span></span><br><span class="line">		ThreadBasicInformation,</span><br><span class="line">		ThreadTimes,</span><br><span class="line">		ThreadPriority,</span><br><span class="line">		ThreadBasePriority,</span><br><span class="line">		ThreadAffinityMask,</span><br><span class="line">		ThreadImpersonationToken,</span><br><span class="line">		ThreadDescriptorTableEntry,</span><br><span class="line">		ThreadEnableAlignmentFaultFixup,</span><br><span class="line">		ThreadEventPair,</span><br><span class="line">		ThreadQuerySetWin32StartAddress,</span><br><span class="line">		ThreadZeroTlsCell,</span><br><span class="line">		ThreadPerformanceCount,</span><br><span class="line">		ThreadAmILastThread,</span><br><span class="line">		ThreadIdealProcessor,</span><br><span class="line">		ThreadPriorityBoost,</span><br><span class="line">		ThreadSetTlsArrayAddress,</span><br><span class="line">		ThreadIsIoPending,</span><br><span class="line">		ThreadHideFromDebugger           <span class="comment">// 17 (0x11)</span></span><br><span class="line">	&#125; THREAD_INFORMATION_CLASS, * PTHREAD_INFORMATION_CLASS;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">typedef</span> <span class="title">NTSTATUS</span><span class="params">(WINAPI* ZWSETINFORMATIONTHREAD)</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">		HANDLE ThreadHandle,</span></span></span><br><span class="line"><span class="function"><span class="params">		THREAD_INFORMATION_CLASS ThreadInformationClass,</span></span></span><br><span class="line"><span class="function"><span class="params">		PVOID ThreadInformation,</span></span></span><br><span class="line"><span class="function"><span class="params">		ULONG ThreadInformationLength</span></span></span><br><span class="line"><span class="function"><span class="params">		)</span></span>;</span><br><span class="line"></span><br><span class="line">	ZWSETINFORMATIONTHREAD myZwSetInformationThread;</span><br><span class="line"></span><br><span class="line">	myZwSetInformationThread=(ZWSETINFORMATIONTHREAD) GetProcAddress(GetModuleHandle(<span class="string">L&quot;ntdll.dll&quot;</span>), <span class="string">&quot;ZwSetInformationThread&quot;</span>);</span><br><span class="line">	myZwSetInformationThread(GetCurrentThread(), ThreadHideFromDebugger, <span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">	MessageBoxA(<span class="literal">NULL</span>, <span class="string">&quot;No Debugger&quot;</span>, <span class="string">&quot;The_Itach1&quot;</span>, MB_OK);<span class="comment">//正常运行会跳出窗口</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	test5();</span><br><span class="line">	system(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ida调试看看是不是真的。<br><img src="https://s2.loli.net/2022/01/10/w7i6yYna8fqexPu.png"><br>可以看到ida无法退出，程序也闪退了。</p>
<p>破解方法，patch掉，或者钩取该函数，修改传入的第二个参数为0。</p>
<h3 id="TLS回调函数"><a href="#TLS回调函数" class="headerlink" title="TLS回调函数"></a>TLS回调函数</h3><p>TLS回调函数是指，没当创建/终止进程的线程时会自动调用执行的函数，创建进程的主线程时也会自动调用回调函数，且其调用执行先于EP代码，反调试技术利用的就是TLS回调函数的这一特征。</p>
<p>可以先于EP执行，意味着我们可以干很多事情，搞反调试在TLS函数里面，修改全局变量数据，加密解密代码区等等事情。</p>
<p>下面就来举个TLS反调试的简单例子，x86，Debug下编译，release编译出来的好像有问题。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;Windows.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//linker spec通知链接器PE文件要创建TLS目录,当然32位和64位会有些差别。</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> comment(linker, <span class="meta-string">&quot;/INCLUDE:__tls_used&quot;</span>)  </span></span><br><span class="line"><span class="comment">//函数格式</span></span><br><span class="line"><span class="comment">//typedef void (NTAPI* PIMAGE_TLS_CALLBACK)(</span></span><br><span class="line"><span class="comment">//	PVOID DllHandle,</span></span><br><span class="line"><span class="comment">//	DWORD Reason,</span></span><br><span class="line"><span class="comment">//	PVOID Reserved</span></span><br><span class="line"><span class="comment">//	);</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> NTAPI <span class="title">TLS_CALLBACK1</span><span class="params">(PVOID DllHandle, DWORD Reason, PVOID Reserved)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	BOOL check;</span><br><span class="line"></span><br><span class="line">	check = IsDebuggerPresent();</span><br><span class="line">	<span class="keyword">if</span> (check == TRUE)</span><br><span class="line">	&#123;</span><br><span class="line">		MessageBoxA(<span class="literal">NULL</span>, <span class="string">&quot;Being Debugger&quot;</span>, <span class="string">&quot;The_Itach1&quot;</span>, MB_OK);</span><br><span class="line">		<span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		MessageBoxA(<span class="literal">NULL</span>, <span class="string">&quot;No Debugger&quot;</span>, <span class="string">&quot;The_Itach1&quot;</span>, MB_OK);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//创建TLS段 并定义一个回调函数。</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> data_seg(<span class="meta-string">&quot;.CRT$XLX&quot;</span>)</span></span><br><span class="line">PIMAGE_TLS_CALLBACK pTLS_CALLBACKs[] = &#123; TLS_CALLBACK1, <span class="number">0</span> &#125;;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> data_seg()</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;this is main function&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>程序在检测到调试就会弹出被调试时窗口。</p>
<p>由于TLS回调函数的特性，该方法可结合各种反调试手段。</p>
<h3 id="ETC"><a href="#ETC" class="headerlink" title="ETC"></a>ETC</h3><p>简单来说就是针对各种调试器信息的，检测有没有这些调试器的痕迹出现。</p>
<p>常见函数，FindWindow函数看看是否有ida，xdbg等等窗口。CreateToolhelp32Snapshot()，给进程拍快照，遍历进程，看看有没有ida，xdbg的进程。包括检测虚拟机中的特殊进程之类的。</p>
<p>CreateToolhelp32Snapshot，ctf中就曾出现过，忘了哪个比赛了，还是比较好辨认。</p>
<p>vs的spy++工具可以直接查看窗口的标题和所属类名称。使用findwindows，通过提供窗口标题或者窗口所属类名来判断的方式，自己试了下不太可靠</p>
<p>下面举个GetWindowText查看是否存在xdbg，ida窗口的例子。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;locale.h&gt; //必备头文件</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">test6</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	setlocale(LC_ALL, <span class="string">&quot;&quot;</span>);<span class="comment">//用来打印中文的。</span></span><br><span class="line">	HWND hWnd = GetDesktopWindow();</span><br><span class="line">	hWnd = GetWindow(hWnd, GW_CHILD); <span class="comment">//如果指定的窗口是父窗口，则检索到的句柄标识Z顺序顶部的子窗口；</span></span><br><span class="line">	hWnd = GetWindow(hWnd, GW_HWNDFIRST);</span><br><span class="line"></span><br><span class="line">	TCHAR szWindow[MAX_PATH] = &#123; <span class="number">0</span>, &#125;;</span><br><span class="line">	<span class="comment">//遍历所有桌面上的窗口名称来比较是否存在ida，xdbg</span></span><br><span class="line">	<span class="keyword">while</span> (hWnd)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (GetWindowText(hWnd, szWindow, MAX_PATH))</span><br><span class="line">		&#123;</span><br><span class="line"></span><br><span class="line">			_tprintf(<span class="string">L&quot;%s\n&quot;</span>, szWindow);<span class="comment">//打印窗口名称</span></span><br><span class="line">			<span class="comment">//_tcsstr，字符1 在字符串2中首次出现的位置，未出现返回NULL值</span></span><br><span class="line">			<span class="keyword">if</span> (_tcsstr(szWindow, <span class="string">L&quot;IDA&quot;</span>) ||</span><br><span class="line">				_tcsstr(szWindow, <span class="string">L&quot;dbg&quot;</span>) )</span><br><span class="line">			&#123;</span><br><span class="line">				MessageBoxA(<span class="literal">NULL</span>, <span class="string">&quot;Being Debugger&quot;</span>, <span class="string">&quot;The_Itach1&quot;</span>, MB_OK);</span><br><span class="line">				</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span></span><br><span class="line">			&#123;</span><br><span class="line">				MessageBoxA(<span class="literal">NULL</span>, <span class="string">&quot;No Debugger&quot;</span>, <span class="string">&quot;The_Itach1&quot;</span>, MB_OK);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		hWnd = GetWindow(hWnd, GW_HWNDNEXT);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>用findwindows有点不准确。</p>
<p>破解方法，绕过就行。</p>
<h3 id="SMC"><a href="#SMC" class="headerlink" title="SMC"></a>SMC</h3><p>这个技术就是将代码区给加密或部分加密，在调试的时候进行自解密，就不会对程序产生影响，而带来的效果是ida静态分析时看不到相应代码部分，利用汇编，或者c语言都可实现，可配合TLS回调函数进行，在ep前进行main函数的自解密。</p>
<p>先讲讲汇编实现的原理，实际上和21章内嵌补丁练习差不多，本次安洵出题也是这样实现的，编译好程序exe后，先指定好需要加密的部分，用idapython进行加密，选定一个这个代码部分前一个要跳转的部分(jmp指令之类的)，修改跳转地址，改到一个空白区，当然空白区部分的权限需要修改为RWE(读写执行)，然后编写汇编代码进行自解密，解密完成后再跳转到原应跳转的位置。例子可以去看安洵的那个题。</p>
<p>下面讲讲如何用c语言代码实现。</p>
<p>环境配置，release，x86，优化关闭，数据执行保护(DEP)关闭，随机基地关闭。</p>
<p>下面讲为什么需要设置这些，优化关闭可以直接定位到函数地址，不关闭的话会进入函数会有一个jmp 然后再跳到函数地址，简单来说就是优化时，函数所代表的地址不是函数真正的地址。数据执行保护关闭可以让你直接修改函数代码的二进制。随机地址关闭可以让你每次加载的基地址一致。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="comment">//将这个会被加密的函数放入SMC节区中，SMC节区的属性设置为ERW</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> code_seg(<span class="meta-string">&quot;.SMC&quot;</span>);</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">func</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;this is a function&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">func2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> code_seg()</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> comment(linker, <span class="meta-string">&quot;/SECTION:.SMC,ERW&quot;</span>)</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Decode</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">void</span>* p,*q;</span><br><span class="line">	p = func;</span><br><span class="line">	q = func2;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">int</span> i;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//printf(&quot;%x\n&quot;, p);</span></span><br><span class="line">	<span class="comment">//printf(&quot;%x\n&quot;, q);</span></span><br><span class="line">	<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; (<span class="keyword">int</span>)q - (<span class="keyword">int</span>)p; i++)</span><br><span class="line">	&#123;</span><br><span class="line">		*((<span class="keyword">unsigned</span> <span class="keyword">char</span>*)p + i) = *((<span class="keyword">unsigned</span> <span class="keyword">char</span>*)p + i) ^ <span class="number">5</span>;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;%02X &quot;</span>, *((<span class="keyword">unsigned</span> <span class="keyword">char</span>*)p + i));</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//50 8E E9 6D 05 34 45 05 ED 36 F5 FA FA 86 C1 01 58 C6 C9 C9 C9 C9 C9 C9 C9 C9 C9 C9 C9 C9 C9 C9</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	Decode();</span><br><span class="line">	func();</span><br><span class="line">	system(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>加密部分呢很简单就是一个异或，所以解密也是这个，如何实现的问题，上面的例子是通过获取函数地址来实现的，这也是为什么要关优化的原因。而且加了个SMC节区，主要是为了方便我们找到二进制文件的位置方便修改。编译的时候注意，在加密函数前加个断点，然后才开始执行，然后停止，然后将生成的exe，找到smc节区，去修改为加密后的数据，这样exe执行的时候就是解密了。</p>
<p>其实，还有中方法去定位到SMC节区，就是先把exe映射到内存，利用pe结构的知识点，找到smc节区，然后去加密解密。</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">The_Itach1</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="http://example.com/2022/01/11/windows%E5%8F%8D%E8%B0%83%E8%AF%95%E6%80%BB%E7%BB%93/">http://example.com/2022/01/11/windows%E5%8F%8D%E8%B0%83%E8%AF%95%E6%80%BB%E7%BB%93/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"></div><div class="post_share"><div class="social-share" data-image="https://s2.loli.net/2022/01/11/RcyES7Ve6Fmk9Dw.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2022/01/25/HWS%20DASCTF%20RE/"><img class="prev-cover" src="https://s2.loli.net/2022/01/25/IfJOYwXAk65WyUN.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">Previous Post</div><div class="prev_info">HWS DASCTF RE</div></div></a></div><div class="next-post pull-right"><a href="/2021/12/02/%E7%AE%80%E5%8D%95%E8%BD%AF%E4%BB%B6%E7%A0%B4%E8%A7%A3/"><img class="next-cover" src="https://i.loli.net/2021/12/02/gaPGbVDE1NFzupY.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">Next Post</div><div class="next_info">Simple software cracking</div></div></a></div></nav></div><div class="aside_content" id="aside_content"><div class="card-widget card-info"><div class="card-content"><div class="card-info-avatar is-center"><img class="avatar-img" src="/img/5.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/><div class="author-info__name">The_Itach1</div><div class="author-info__description"></div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">52</div></a></div></div><a class="button--animated" id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/xxxxxx"><i class="fab fa-github"></i><span>Follow Me</span></a></div></div><div class="card-widget card-announcement"><div class="card-content"><div class="item-headline"><i class="fas fa-bullhorn card-announcement-animation"></i><span>Announcement</span></div><div class="announcement_content">This is my Blog</div></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="card-content"><div class="item-headline"><i class="fas fa-stream"></i><span>Catalog</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Windows%E5%8F%8D%E8%B0%83%E8%AF%95%E6%80%BB%E7%BB%93"><span class="toc-number">1.</span> <span class="toc-text">Windows反调试总结</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9D%99%E6%80%81%E5%8F%8D%E8%B0%83%E8%AF%95"><span class="toc-number">1.1.</span> <span class="toc-text">静态反调试</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#BeingDebugged"><span class="toc-number">1.1.1.</span> <span class="toc-text">BeingDebugged</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#NtGlobalFlag"><span class="toc-number">1.1.2.</span> <span class="toc-text">NtGlobalFlag</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#NtQueryInformationProcess"><span class="toc-number">1.1.3.</span> <span class="toc-text">NtQueryInformationProcess</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#NtQuerySystemInformation"><span class="toc-number">1.1.4.</span> <span class="toc-text">NtQuerySystemInformation</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#NtQueryObject"><span class="toc-number">1.1.5.</span> <span class="toc-text">NtQueryObject</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ZwSetInformationThread"><span class="toc-number">1.1.6.</span> <span class="toc-text">ZwSetInformationThread</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#TLS%E5%9B%9E%E8%B0%83%E5%87%BD%E6%95%B0"><span class="toc-number">1.1.7.</span> <span class="toc-text">TLS回调函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ETC"><span class="toc-number">1.1.8.</span> <span class="toc-text">ETC</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SMC"><span class="toc-number">1.1.9.</span> <span class="toc-text">SMC</span></a></li></ol></li></ol></li></ol></div></div></div><div class="card-widget card-recent-post"><div class="card-content"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Post</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2022/03/30/Simple%20Exe%20Packing/" title="Simple Exe Packing"><img src="https://s2.loli.net/2022/03/30/cVsNfuSDZGqMO4r.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Simple Exe Packing"/></a><div class="content"><a class="title" href="/2022/03/30/Simple%20Exe%20Packing/" title="Simple Exe Packing">Simple Exe Packing</a><time datetime="2022-03-30T12:17:50.834Z" title="Created 2022-03-30 20:17:50">2022-03-30</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/03/15/OWASP%20Top%2010%20learning/" title="OWASP Top 10 learning"><img src="https://s2.loli.net/2022/03/15/Afs4qw2QXxeUHlO.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="OWASP Top 10 learning"/></a><div class="content"><a class="title" href="/2022/03/15/OWASP%20Top%2010%20learning/" title="OWASP Top 10 learning">OWASP Top 10 learning</a><time datetime="2022-03-14T16:56:35.239Z" title="Created 2022-03-15 00:56:35">2022-03-15</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/02/25/%E5%90%91%E6%97%A5%E8%91%B5%20CNVD-2022-10270%E5%88%86%E6%9E%90/" title="向日葵 CNVD-2022-10270分析"><img src="https://s2.loli.net/2022/02/25/v2oYBbMdSCqf3gc.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="向日葵 CNVD-2022-10270分析"/></a><div class="content"><a class="title" href="/2022/02/25/%E5%90%91%E6%97%A5%E8%91%B5%20CNVD-2022-10270%E5%88%86%E6%9E%90/" title="向日葵 CNVD-2022-10270分析">向日葵 CNVD-2022-10270分析</a><time datetime="2022-02-25T12:12:34.686Z" title="Created 2022-02-25 20:12:34">2022-02-25</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/02/25/hgame%202022%20Re/" title="hgame 2022 re wp"><img src="https://s2.loli.net/2022/02/25/TD8lZVdK6XLFOuG.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="hgame 2022 re wp"/></a><div class="content"><a class="title" href="/2022/02/25/hgame%202022%20Re/" title="hgame 2022 re wp">hgame 2022 re wp</a><time datetime="2022-02-25T12:07:52.221Z" title="Created 2022-02-25 20:07:52">2022-02-25</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/02/19/Log4j%20%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/" title="Log4j2 漏洞复现"><img src="https://s2.loli.net/2022/02/19/mcDBoNOdi34ul2P.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Log4j2 漏洞复现"/></a><div class="content"><a class="title" href="/2022/02/19/Log4j%20%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/" title="Log4j2 漏洞复现">Log4j2 漏洞复现</a><time datetime="2022-02-19T04:48:02.711Z" title="Created 2022-02-19 12:48:02">2022-02-19</time></div></div></div></div></div></div></div></main><footer id="footer" style="background-image: url(https://s2.loli.net/2022/01/11/RcyES7Ve6Fmk9Dw.jpg)"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2022 By The_Itach1</div><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">木叶飞舞之处，火亦生生不息</div><div class="icp"><a><span></span></a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Read Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Switch Between Light And Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="Setting"><i class="fas fa-cog"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table Of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back To Top"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><div class="js-pjax"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></div></body></html>